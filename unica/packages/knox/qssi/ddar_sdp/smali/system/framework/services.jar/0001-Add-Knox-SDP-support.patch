From f773db5b30fcdaf4ec723b6eae7c25c88e657307 Mon Sep 17 00:00:00 2001
From: BlackMesa123 <giangrecosalvo9@gmail.com>
Date: Wed, 31 Jan 2024 08:26:20 +0100
Subject: [PATCH] Add Knox SDP support

---
 .../server/StorageManagerService.smali        |   60 +-
 .../com/android/server/am/ProcessList.smali   |  575 ++++--
 .../server/am/UserController$Injector.smali   |   37 +-
 .../DevicePolicyManagerService$Injector.smali |    2 +-
 .../container/KnoxMUMContainerPolicy.smali    |  101 +-
 .../knox/ContainerDependencyWrapper.smali     |   36 +-
 .../server/knox/dar/DarManagerService.smali   |  127 +-
 .../com/android/server/knox/dar/DarUtil.smali |   53 +
 .../knox/dar/EnterprisePartitionManager.smali |   35 +
 ...anagerImpl$$ExternalSyntheticLambda3.smali |   18 +-
 ...anagerImpl$$ExternalSyntheticLambda4.smali |   26 +-
 ...anagerImpl$$ExternalSyntheticLambda5.smali |   20 +-
 ...anagerImpl$$ExternalSyntheticLambda6.smali |   22 +-
 ...anagerImpl$$ExternalSyntheticLambda7.smali |   38 +
 ...anagerImpl$$ExternalSyntheticLambda8.smali |   44 +
 .../sdp/SdpManagerImpl$SdpLocalService.smali  |   52 +
 .../server/knox/dar/sdp/SdpManagerImpl.smali  |  794 +++++++-
 .../knox/dar/sdp/SdpManagerInternal.smali     |    3 +
 .../knox/dar/sdp/security/BytesUtil.smali     |   24 +
 ...gsService$$ExternalSyntheticLambda10.smali |   26 +-
 ...gsService$$ExternalSyntheticLambda11.smali |   16 +-
 ...gsService$$ExternalSyntheticLambda12.smali |    2 +-
 ...gsService$$ExternalSyntheticLambda13.smali |    2 +-
 ...gsService$$ExternalSyntheticLambda14.smali |   16 +-
 ...gsService$$ExternalSyntheticLambda15.smali |   16 +-
 ...gsService$$ExternalSyntheticLambda16.smali |   20 +-
 ...gsService$$ExternalSyntheticLambda17.smali |   26 +-
 ...gsService$$ExternalSyntheticLambda19.smali |   36 +
 ...ngsService$$ExternalSyntheticLambda8.smali |   28 +-
 ...ngsService$$ExternalSyntheticLambda9.smali |   22 +-
 .../LockSettingsService$DarVirtualLock.smali  |   51 +-
 .../LockSettingsService$Lifecycle.smali       |   33 +-
 ...ckSettings$$ExternalSyntheticLambda1.smali |   42 +
 ...kSettings$$ExternalSyntheticLambda10.smali |   38 +
 ...kSettings$$ExternalSyntheticLambda11.smali |   38 +
 ...ckSettings$$ExternalSyntheticLambda2.smali |   42 +
 ...ckSettings$$ExternalSyntheticLambda3.smali |   42 +
 ...ckSettings$$ExternalSyntheticLambda4.smali |   46 +
 ...ckSettings$$ExternalSyntheticLambda5.smali |   42 +
 ...ckSettings$$ExternalSyntheticLambda6.smali |   36 +
 ...ckSettings$$ExternalSyntheticLambda7.smali |   36 +
 ...ckSettings$$ExternalSyntheticLambda8.smali |   34 +
 ...ckSettings$$ExternalSyntheticLambda9.smali |   30 +
 .../LockSettingsService$SdpLockSettings.smali | 1437 ++++++++++++-
 .../locksettings/LockSettingsService.smali    |  751 +++++--
 .../SyntheticPasswordCrypto.smali             |  854 +++++++-
 ...sswordManager$AuthenticationSdpToken.smali |   24 +
 ...yntheticPasswordManager$PasswordData.smali |  156 +-
 ...ordManager$$ExternalSyntheticLambda0.smali |   22 +-
 ...ordManager$$ExternalSyntheticLambda1.smali |   38 +
 ...ordManager$$ExternalSyntheticLambda2.smali |   38 +
 ...ordManager$$ExternalSyntheticLambda3.smali |   38 +
 ...dManager$SdpSyntheticPasswordManager.smali | 1699 +++++++++++++--
 ...ticPasswordManager$SyntheticPassword.smali |  349 +++-
 .../SyntheticPasswordManager.smali            | 1813 ++++++++++++-----
 ...yntheticPasswordMdfpp$KeyingMaterial.smali |  145 ++
 .../SyntheticPasswordMdfpp$Utils.smali        |   38 +
 .../locksettings/SyntheticPasswordMdfpp.smali |  278 +++
 ...geManagerService$IPackageManagerImpl.smali |   18 +-
 .../server/pm/PackageManagerService.smali     |  161 ++
 .../server/pm/RemovePackageHelper.smali       |  100 +-
 ...gerService$$ExternalSyntheticLambda6.smali |   28 +-
 ...gerService$$ExternalSyntheticLambda7.smali |   26 +-
 ...gerService$$ExternalSyntheticLambda8.smali |   38 +
 ...gerService$$ExternalSyntheticLambda9.smali |   36 +
 .../server/pm/UserManagerService.smali        |  630 ++++--
 ...gerService$$ExternalSyntheticLambda1.smali |   36 +
 ...rService$1$$ExternalSyntheticLambda1.smali |   36 +
 ...rService$1$$ExternalSyntheticLambda2.smali |   36 +
 .../server/trust/TrustManagerService$1.smali  |  107 +-
 .../server/trust/TrustManagerService.smali    |   82 +
 71 files changed, 10188 insertions(+), 1613 deletions(-)
 create mode 100644 smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7.smali
 create mode 100644 smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3.smali
 create mode 100644 smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$Utils.smali
 create mode 100644 smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda8.smali
 create mode 100644 smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda9.smali
 create mode 100644 smali_classes3/com/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1.smali
 create mode 100644 smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1.smali
 create mode 100644 smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2.smali

diff --git a/smali/com/android/server/StorageManagerService.smali b/smali/com/android/server/StorageManagerService.smali
index 7703ed039..7269a2ae0 100644
--- a/smali/com/android/server/StorageManagerService.smali
+++ b/smali/com/android/server/StorageManagerService.smali
@@ -13269,33 +13269,79 @@
 
     invoke-virtual {p2, v0, v1}, Landroid/os/Handler;->obtainMessage(ILjava/lang/Object;)Landroid/os/Message;
 
-    move-result-object v0
+    move-result-object v1
 
-    invoke-virtual {p2, v0}, Landroid/os/Handler;->sendMessage(Landroid/os/Message;)Z
+    invoke-virtual {p2, v1}, Landroid/os/Handler;->sendMessage(Landroid/os/Message;)Z
 
     :cond_d
     invoke-virtual {p0, p1, p3}, Lcom/android/server/StorageManagerService;->maybeLogMediaMount(Landroid/os/storage/VolumeInfo;I)V
 
     monitor-exit v2
+    :try_end_4
+    .catchall {:try_start_4 .. :try_end_4} :catchall_0
+
+    iget p2, p1, Landroid/os/storage/VolumeInfo;->type:I
+
+    if-ne p2, v0, :cond_e
+
+    if-ne p3, v0, :cond_e
+
+    invoke-virtual {p1}, Landroid/os/storage/VolumeInfo;->getMountUserId()I
+
+    move-result p1
+
+    invoke-static {p1}, Lcom/samsung/android/knox/SemPersonaManager;->isDoEnabled(I)Z
+
+    move-result p2
+
+    if-eqz p2, :cond_e
+
+    invoke-static {p1}, Lcom/samsung/android/knox/dar/ddar/DualDarManager;->isOnDeviceOwner(I)Z
+
+    move-result p2
+
+    if-nez p2, :cond_e
+
+    const-string p2, "StorageManagerService.SDP"
+
+    new-instance p3, Ljava/lang/StringBuilder;
 
+    invoke-direct {p3}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v0, "Emulated volume mounted for user "
+
+    invoke-virtual {p3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p3, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p3
+
+    invoke-static {p2, p3}, Landroid/util/sysfwutil/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {p0, p1}, Lcom/android/server/StorageManagerService;->mountSdpMediaStorageCmd(I)Z
+
+    :cond_e
     return-void
 
     :catchall_0
     move-exception p0
 
+    :try_start_5
     monitor-exit v2
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_0
+    :try_end_5
+    .catchall {:try_start_5 .. :try_end_5} :catchall_0
 
     throw p0
 
     :catchall_1
     move-exception p0
 
-    :try_start_5
+    :try_start_6
     monitor-exit v1
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_1
+    :try_end_6
+    .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
     throw p0
 .end method
diff --git a/smali/com/android/server/am/ProcessList.smali b/smali/com/android/server/am/ProcessList.smali
index 7d43b71eb..a677b388c 100644
--- a/smali/com/android/server/am/ProcessList.smali
+++ b/smali/com/android/server/am/ProcessList.smali
@@ -15853,7 +15853,7 @@
 .end method
 
 .method public startProcessLocked(Lcom/android/server/am/ProcessRecord;Lcom/android/server/am/HostingRecord;IZZLjava/lang/String;)Z
-    .locals 23
+    .locals 25
 
     move-object/from16 v14, p0
 
@@ -16011,7 +16011,7 @@
 
     move-result v1
     :try_end_0
-    .catch Ljava/lang/RuntimeException; {:try_start_0 .. :try_end_0} :catch_7
+    .catch Ljava/lang/RuntimeException; {:try_start_0 .. :try_end_0} :catch_c
 
     :try_start_1
     invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
@@ -16024,15 +16024,15 @@
 
     invoke-interface {v3, v4, v1}, Landroid/content/pm/IPackageManager;->checkPackageStartable(Ljava/lang/String;I)V
     :try_end_1
-    .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_5
-    .catch Ljava/lang/RuntimeException; {:try_start_1 .. :try_end_1} :catch_7
+    .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_a
+    .catch Ljava/lang/RuntimeException; {:try_start_1 .. :try_end_1} :catch_c
 
     :try_start_2
     iget v3, v15, Lcom/android/server/am/ProcessRecord;->uid:I
 
     iget-boolean v4, v15, Lcom/android/server/am/ProcessRecord;->isolated:Z
     :try_end_2
-    .catch Ljava/lang/RuntimeException; {:try_start_2 .. :try_end_2} :catch_7
+    .catch Ljava/lang/RuntimeException; {:try_start_2 .. :try_end_2} :catch_c
 
     if-nez v4, :cond_7
 
@@ -16092,7 +16092,7 @@
     const-string v9, "android.permission.INSTALL_PACKAGES"
     :try_end_3
     .catch Landroid/os/RemoteException; {:try_start_3 .. :try_end_3} :catch_0
-    .catch Ljava/lang/RuntimeException; {:try_start_3 .. :try_end_3} :catch_7
+    .catch Ljava/lang/RuntimeException; {:try_start_3 .. :try_end_3} :catch_c
 
     :try_start_4
     iget-object v11, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
@@ -16161,7 +16161,7 @@
     invoke-virtual {v4, v2}, Lcom/android/server/am/ProcessCachedOptimizerRecord;->setFreezeExempt(Z)V
     :try_end_4
     .catch Landroid/os/RemoteException; {:try_start_4 .. :try_end_4} :catch_0
-    .catch Ljava/lang/RuntimeException; {:try_start_4 .. :try_end_4} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_4 .. :try_end_4} :catch_9
 
     :cond_4
     :try_start_5
@@ -16282,7 +16282,9 @@
 
     iget v3, v3, Landroid/content/pm/ApplicationInfo;->flags:I
 
-    and-int/lit8 v3, v3, 0x2
+    const/4 v4, 0x2
+
+    and-int/2addr v3, v4
 
     if-eqz v3, :cond_9
 
@@ -16294,104 +16296,104 @@
     const/4 v3, 0x0
 
     :goto_4
-    iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
+    iget-object v6, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
-    invoke-virtual {v4}, Landroid/content/pm/ApplicationInfo;->isProfileableByShell()Z
+    invoke-virtual {v6}, Landroid/content/pm/ApplicationInfo;->isProfileableByShell()Z
 
-    move-result v4
+    move-result v6
 
-    iget-object v6, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
+    iget-object v7, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
-    invoke-virtual {v6}, Landroid/content/pm/ApplicationInfo;->isProfileable()Z
+    invoke-virtual {v7}, Landroid/content/pm/ApplicationInfo;->isProfileable()Z
 
-    move-result v6
+    move-result v7
 
-    iget-boolean v7, v15, Lcom/android/server/am/ProcessRecord;->isSdkSandbox:Z
+    iget-boolean v8, v15, Lcom/android/server/am/ProcessRecord;->isSdkSandbox:Z
 
-    if-eqz v7, :cond_b
+    if-eqz v8, :cond_b
 
     invoke-virtual/range {p1 .. p1}, Lcom/android/server/am/ProcessRecord;->getClientInfoForSdkSandbox()Landroid/content/pm/ApplicationInfo;
 
-    move-result-object v7
+    move-result-object v8
 
-    if-eqz v7, :cond_b
+    if-eqz v8, :cond_b
 
-    iget v8, v7, Landroid/content/pm/ApplicationInfo;->flags:I
+    iget v11, v8, Landroid/content/pm/ApplicationInfo;->flags:I
 
-    and-int/lit8 v8, v8, 0x2
+    and-int/2addr v11, v4
 
-    if-eqz v8, :cond_a
+    if-eqz v11, :cond_a
 
-    const/4 v8, 0x1
+    const/4 v11, 0x1
 
     goto :goto_5
 
     :cond_a
-    const/4 v8, 0x0
+    const/4 v11, 0x0
 
     :goto_5
-    or-int/2addr v3, v8
+    or-int/2addr v3, v11
 
-    invoke-virtual {v7}, Landroid/content/pm/ApplicationInfo;->isProfileableByShell()Z
+    invoke-virtual {v8}, Landroid/content/pm/ApplicationInfo;->isProfileableByShell()Z
 
-    move-result v8
+    move-result v11
 
-    or-int/2addr v4, v8
+    or-int/2addr v6, v11
 
-    invoke-virtual {v7}, Landroid/content/pm/ApplicationInfo;->isProfileable()Z
+    invoke-virtual {v8}, Landroid/content/pm/ApplicationInfo;->isProfileable()Z
 
-    move-result v7
+    move-result v8
 
-    or-int/2addr v6, v7
+    or-int/2addr v7, v8
 
     :cond_b
     if-eqz v3, :cond_d
 
-    iget-object v7, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
+    iget-object v8, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    iget-object v7, v7, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+    iget-object v8, v8, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
-    invoke-virtual {v7}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
+    invoke-virtual {v8}, Landroid/content/Context;->getContentResolver()Landroid/content/ContentResolver;
 
-    move-result-object v7
+    move-result-object v8
 
-    const-string v8, "art_verifier_verify_debuggable"
+    const-string v11, "art_verifier_verify_debuggable"
 
-    const/4 v11, 0x1
+    const/4 v4, 0x1
 
-    invoke-static {v7, v8, v11}, Landroid/provider/Settings$Global;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I
+    invoke-static {v8, v11, v4}, Landroid/provider/Settings$Global;->getInt(Landroid/content/ContentResolver;Ljava/lang/String;I)I
 
-    move-result v7
+    move-result v8
 
-    if-nez v7, :cond_c
+    if-nez v8, :cond_c
 
-    new-instance v7, Ljava/lang/StringBuilder;
+    new-instance v4, Ljava/lang/StringBuilder;
 
-    invoke-direct {v7}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v7, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
 
     const-string v8, ": ART verification disabled"
 
-    invoke-virtual {v7, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v7}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v7
+    move-result-object v4
 
-    invoke-static {v10, v7}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v10, v4}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    const/16 v7, 0x303
+    const/16 v4, 0x303
 
     goto :goto_6
 
     :cond_c
-    const/16 v7, 0x103
+    const/16 v4, 0x103
 
     goto :goto_6
 
     :cond_d
-    const/4 v7, 0x0
+    const/4 v4, 0x0
 
     :goto_6
     iget-object v8, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
@@ -16409,124 +16411,124 @@
     if-eqz v8, :cond_f
 
     :cond_e
-    or-int/lit8 v7, v7, 0x8
+    or-int/lit8 v4, v4, 0x8
 
     :cond_f
-    if-eqz v4, :cond_10
+    if-eqz v6, :cond_10
 
-    const v4, 0x8000
+    const v6, 0x8000
 
-    or-int/2addr v7, v4
+    or-int/2addr v4, v6
 
     :cond_10
-    if-eqz v6, :cond_11
+    if-eqz v7, :cond_11
 
-    const/high16 v4, 0x1000000
+    const/high16 v6, 0x1000000
 
-    or-int/2addr v7, v4
+    or-int/2addr v4, v6
 
     :cond_11
-    const-string v4, "debug.checkjni"
+    const-string v6, "debug.checkjni"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v4
+    move-result v6
 
-    if-eqz v4, :cond_12
+    if-eqz v6, :cond_12
 
-    or-int/lit8 v7, v7, 0x2
+    or-int/lit8 v4, v4, 0x2
 
     :cond_12
-    const-string v4, "debug.generate-debug-info"
+    const-string v6, "debug.generate-debug-info"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v6
+    move-result v7
     :try_end_5
-    .catch Ljava/lang/RuntimeException; {:try_start_5 .. :try_end_5} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_5 .. :try_end_5} :catch_9
 
     const-string/jumbo v8, "true"
 
-    if-nez v6, :cond_13
+    if-nez v7, :cond_13
 
     :try_start_6
-    invoke-virtual {v8, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v8, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v4
+    move-result v6
 
-    if-eqz v4, :cond_14
+    if-eqz v6, :cond_14
 
     :cond_13
-    or-int/lit8 v7, v7, 0x20
+    or-int/lit8 v4, v4, 0x20
 
     :cond_14
-    const-string v4, "dalvik.vm.minidebuginfo"
+    const-string v6, "dalvik.vm.minidebuginfo"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v6
+    move-result v7
 
-    if-nez v6, :cond_15
+    if-nez v7, :cond_15
 
-    invoke-virtual {v8, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v8, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v4
+    move-result v6
 
-    if-eqz v4, :cond_16
+    if-eqz v6, :cond_16
 
     :cond_15
-    or-int/lit16 v7, v7, 0x800
+    or-int/lit16 v4, v4, 0x800
 
     :cond_16
-    const-string v4, "debug.jni.logging"
+    const-string v6, "debug.jni.logging"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v4
+    move-result v6
 
-    if-eqz v4, :cond_17
+    if-eqz v6, :cond_17
 
-    or-int/lit8 v7, v7, 0x10
+    or-int/lit8 v4, v4, 0x10
 
     :cond_17
-    const-string v4, "debug.assert"
+    const-string v6, "debug.assert"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    move-result v4
+    move-result v6
 
-    if-eqz v4, :cond_18
+    if-eqz v6, :cond_18
 
-    or-int/lit8 v7, v7, 0x4
+    or-int/lit8 v4, v4, 0x4
 
     :cond_18
-    const-string v4, "debug.ignoreappsignalhandler"
+    const-string v6, "debug.ignoreappsignalhandler"
 
-    invoke-static {v4}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v0
 
@@ -16534,7 +16536,7 @@
 
     const/high16 v0, 0x20000
 
-    or-int/2addr v7, v0
+    or-int/2addr v4, v0
 
     :cond_19
     iget-object v0, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -16543,30 +16545,30 @@
 
     if-eqz v0, :cond_1a
 
-    iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+    iget-object v6, v15, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
 
-    invoke-virtual {v0, v4}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v0
 
     if-eqz v0, :cond_1a
 
-    or-int/lit8 v0, v7, 0x40
+    or-int/lit8 v0, v4, 0x40
 
     or-int/lit8 v0, v0, 0x20
 
-    or-int/lit16 v7, v0, 0x80
+    or-int/lit16 v4, v0, 0x80
 
     iget-object v0, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    const/4 v4, 0x0
+    const/4 v6, 0x0
 
-    iput-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mNativeDebuggingApp:Ljava/lang/String;
+    iput-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mNativeDebuggingApp:Ljava/lang/String;
 
     goto :goto_7
 
     :cond_1a
-    const/4 v4, 0x0
+    const/4 v6, 0x0
 
     :goto_7
     iget-object v0, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
@@ -16577,7 +16579,7 @@
 
     if-eqz v0, :cond_1b
 
-    or-int/lit16 v7, v7, 0x400
+    or-int/lit16 v4, v4, 0x400
 
     :cond_1b
     if-nez p4, :cond_1d
@@ -16594,15 +16596,15 @@
 
     iget-object v0, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
-    iget-object v6, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
+    iget-object v7, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    iget-object v6, v6, Lcom/android/server/am/ActivityManagerService;->mHiddenApiBlacklist:Lcom/android/server/am/ActivityManagerService$HiddenApiSettings;
+    iget-object v7, v7, Lcom/android/server/am/ActivityManagerService;->mHiddenApiBlacklist:Lcom/android/server/am/ActivityManagerService$HiddenApiSettings;
 
-    invoke-virtual {v6}, Lcom/android/server/am/ActivityManagerService$HiddenApiSettings;->getPolicy()I
+    invoke-virtual {v7}, Lcom/android/server/am/ActivityManagerService$HiddenApiSettings;->getPolicy()I
 
-    move-result v6
+    move-result v7
 
-    invoke-virtual {v0, v6}, Landroid/content/pm/ApplicationInfo;->maybeUpdateHiddenApiEnforcementPolicy(I)V
+    invoke-virtual {v0, v7}, Landroid/content/pm/ApplicationInfo;->maybeUpdateHiddenApiEnforcementPolicy(I)V
 
     iget-object v0, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
@@ -16610,21 +16612,21 @@
 
     move-result v0
 
-    sget v6, Lcom/android/internal/os/Zygote;->API_ENFORCEMENT_POLICY_SHIFT:I
+    sget v7, Lcom/android/internal/os/Zygote;->API_ENFORCEMENT_POLICY_SHIFT:I
 
-    shl-int v6, v0, v6
+    shl-int v7, v0, v7
 
-    and-int/lit16 v8, v6, 0x3000
+    and-int/lit16 v8, v7, 0x3000
 
-    if-ne v8, v6, :cond_1c
+    if-ne v8, v7, :cond_1c
 
-    or-int/2addr v7, v6
+    or-int/2addr v4, v7
 
     if-eqz p5, :cond_1d
 
     const/high16 v0, 0x40000
 
-    or-int/2addr v7, v0
+    or-int/2addr v4, v0
 
     goto :goto_8
 
@@ -16653,21 +16655,21 @@
     :goto_8
     const-string/jumbo v0, "persist.device_config.runtime_native.use_app_image_startup_cache"
 
-    const-string v6, ""
+    const-string v7, ""
 
-    invoke-static {v0, v6}, Landroid/os/SystemProperties;->get(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
+    invoke-static {v0, v7}, Landroid/os/SystemProperties;->get(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
 
     move-result-object v0
 
     invoke-static {v0}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
 
-    move-result v6
+    move-result v7
 
-    if-nez v6, :cond_1e
+    if-nez v7, :cond_1e
 
-    const-string v6, "false"
+    const-string v7, "false"
 
-    invoke-virtual {v0, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v0, v7}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v0
 
@@ -16675,7 +16677,7 @@
 
     const/high16 v0, 0x10000
 
-    or-int/2addr v7, v0
+    or-int/2addr v4, v0
 
     :cond_1e
     if-eqz v3, :cond_20
@@ -16702,30 +16704,30 @@
 
     move-result-object v3
     :try_end_6
-    .catch Ljava/lang/RuntimeException; {:try_start_6 .. :try_end_6} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_6 .. :try_end_6} :catch_9
 
     :try_start_7
-    new-instance v6, Ljava/io/File;
+    new-instance v7, Ljava/io/File;
 
-    invoke-direct {v6, v0}, Ljava/io/File;-><init>(Ljava/lang/String;)V
+    invoke-direct {v7, v0}, Ljava/io/File;-><init>(Ljava/lang/String;)V
 
-    invoke-virtual {v6}, Ljava/io/File;->exists()Z
+    invoke-virtual {v7}, Ljava/io/File;->exists()Z
 
-    move-result v6
+    move-result v7
 
-    if-eqz v6, :cond_1f
+    if-eqz v7, :cond_1f
 
-    new-instance v6, Ljava/lang/StringBuilder;
+    new-instance v7, Ljava/lang/StringBuilder;
 
-    invoke-direct {v6}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v7}, Ljava/lang/StringBuilder;-><init>()V
 
     const-string v8, "/system/bin/logwrapper "
 
-    invoke-virtual {v6, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v7, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v6, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v7, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v6}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v7}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
     move-result-object v0
     :try_end_7
@@ -16734,7 +16736,7 @@
     goto :goto_9
 
     :cond_1f
-    move-object v0, v4
+    move-object v0, v6
 
     :goto_9
     :try_start_8
@@ -16750,7 +16752,7 @@
     throw v0
 
     :cond_20
-    move-object v0, v4
+    move-object v0, v6
 
     :goto_a
     if-eqz p6, :cond_21
@@ -16769,12 +16771,12 @@
 
     sget-object v3, Landroid/os/Build;->SUPPORTED_ABIS:[Ljava/lang/String;
     :try_end_8
-    .catch Ljava/lang/RuntimeException; {:try_start_8 .. :try_end_8} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_8 .. :try_end_8} :catch_9
 
-    const/4 v6, 0x0
+    const/4 v7, 0x0
 
     :try_start_9
-    aget-object v3, v3, v6
+    aget-object v3, v3, v7
     :try_end_9
     .catch Ljava/lang/RuntimeException; {:try_start_9 .. :try_end_9} :catch_1
 
@@ -16783,12 +16785,12 @@
     :catch_1
     move-exception v0
 
-    move/from16 v19, v6
+    move/from16 v18, v7
 
     :goto_c
-    move-object/from16 v22, v10
+    move-object/from16 v24, v10
 
-    goto/16 :goto_14
+    goto/16 :goto_17
 
     :cond_22
     :goto_d
@@ -16810,7 +16812,7 @@
     goto :goto_e
 
     :cond_23
-    move-object v8, v4
+    move-object v8, v6
 
     :goto_e
     iget v3, v15, Lcom/android/server/am/ProcessRecord;->uid:I
@@ -16819,9 +16821,9 @@
 
     move-result v3
 
-    const/16 v4, 0x4d
+    const/16 v6, 0x4d
 
-    if-ne v3, v4, :cond_24
+    if-ne v3, v6, :cond_24
 
     iget-object v3, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
@@ -16850,15 +16852,15 @@
 
     new-instance v3, Landroid/content/pm/ApplicationInfo;
 
-    iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
+    iget-object v6, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
-    invoke-direct {v3, v4}, Landroid/content/pm/ApplicationInfo;-><init>(Landroid/content/pm/ApplicationInfo;)V
+    invoke-direct {v3, v6}, Landroid/content/pm/ApplicationInfo;-><init>(Landroid/content/pm/ApplicationInfo;)V
 
     invoke-virtual/range {p2 .. p2}, Lcom/android/server/am/HostingRecord;->getDefiningPackageName()Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v6
 
-    iput-object v4, v3, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+    iput-object v6, v3, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
 
     iput v5, v3, Landroid/content/pm/ApplicationInfo;->uid:I
 
@@ -16868,15 +16870,15 @@
     iget-object v3, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
     :goto_f
-    iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->processInfo:Landroid/content/pm/ProcessInfo;
+    iget-object v6, v15, Lcom/android/server/am/ProcessRecord;->processInfo:Landroid/content/pm/ProcessInfo;
 
-    iget-object v6, v14, Lcom/android/server/am/ProcessList;->mPlatformCompat:Lcom/android/server/compat/PlatformCompat;
+    iget-object v7, v14, Lcom/android/server/am/ProcessList;->mPlatformCompat:Lcom/android/server/compat/PlatformCompat;
 
-    invoke-static {v3, v4, v8, v6}, Lcom/android/internal/os/Zygote;->getMemorySafetyRuntimeFlags(Landroid/content/pm/ApplicationInfo;Landroid/content/pm/ProcessInfo;Ljava/lang/String;Lcom/android/internal/compat/IPlatformCompat;)I
+    invoke-static {v3, v6, v8, v7}, Lcom/android/internal/os/Zygote;->getMemorySafetyRuntimeFlags(Landroid/content/pm/ApplicationInfo;Landroid/content/pm/ProcessInfo;Ljava/lang/String;Lcom/android/internal/compat/IPlatformCompat;)I
 
     move-result v3
 
-    or-int/2addr v7, v3
+    or-int v7, v4, v3
 
     iget-object v3, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
@@ -16956,7 +16958,7 @@
 
     array-length v3, v2
     :try_end_a
-    .catch Ljava/lang/RuntimeException; {:try_start_a .. :try_end_a} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_a .. :try_end_a} :catch_9
 
     const/4 v4, 0x0
 
@@ -16975,6 +16977,8 @@
     aput v3, v1, v2
 
     invoke-virtual {v15, v1}, Lcom/android/server/am/ProcessRecord;->setGids([I)V
+    :try_end_c
+    .catch Ljava/lang/RuntimeException; {:try_start_c .. :try_end_c} :catch_9
 
     move-object v2, v1
 
@@ -16983,19 +16987,167 @@
     :catch_2
     move-exception v0
 
-    move/from16 v19, v4
+    move/from16 v18, v4
 
     goto/16 :goto_c
 
     :cond_27
     :goto_11
+    const/4 v1, 0x0
+
+    :try_start_d
+    filled-new-array {v1, v1}, [I
+
+    move-result-object v3
+    :try_end_d
+    .catch Ljava/lang/RuntimeException; {:try_start_d .. :try_end_d} :catch_8
+
+    :try_start_e
+    invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
+
+    move-result-object v1
+
+    iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
+
+    iget-object v4, v4, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+
+    iget v6, v15, Lcom/android/server/am/ProcessRecord;->userId:I
+    :try_end_e
+    .catch Landroid/os/RemoteException; {:try_start_e .. :try_end_e} :catch_4
+    .catch Ljava/lang/RuntimeException; {:try_start_e .. :try_end_e} :catch_9
+
+    move-wide/from16 v22, v12
+
+    const-wide/16 v12, 0x80
+
+    :try_start_f
+    invoke-interface {v1, v4, v12, v13, v6}, Landroid/content/pm/IPackageManager;->getApplicationInfo(Ljava/lang/String;JI)Landroid/content/pm/ApplicationInfo;
+
+    move-result-object v1
+
+    if-eqz v1, :cond_28
+
+    iget-object v1, v1, Landroid/content/pm/ApplicationInfo;->metaData:Landroid/os/Bundle;
+
+    if-eqz v1, :cond_28
+
+    const-string v4, "enabled"
+
+    const-string/jumbo v6, "sdp"
+
+    invoke-virtual {v1, v6}, Landroid/os/Bundle;->getString(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-virtual {v4, v1}, Ljava/lang/String;->equalsIgnoreCase(Ljava/lang/String;)Z
+
+    move-result v1
+    :try_end_f
+    .catch Landroid/os/RemoteException; {:try_start_f .. :try_end_f} :catch_5
+    .catch Ljava/lang/RuntimeException; {:try_start_f .. :try_end_f} :catch_9
+
+    if-eqz v1, :cond_28
+
+    const/16 v1, 0x1f41
+
+    const/4 v4, 0x0
+
+    :try_start_10
+    aput v1, v3, v4
+    :try_end_10
+    .catch Landroid/os/RemoteException; {:try_start_10 .. :try_end_10} :catch_3
+    .catch Ljava/lang/RuntimeException; {:try_start_10 .. :try_end_10} :catch_2
+
+    const/4 v1, 0x1
+
+    goto :goto_13
+
+    :catch_3
+    const/4 v1, 0x1
+
+    goto :goto_12
+
+    :cond_28
+    const/4 v1, 0x0
+
+    goto :goto_13
+
+    :catch_4
+    move-wide/from16 v22, v12
+
+    :catch_5
+    const/4 v1, 0x0
+
+    :goto_12
+    :try_start_11
+    const-string v4, "Failed to get metadata for sdp "
+
+    invoke-static {v10, v4}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    :try_end_11
+    .catch Ljava/lang/RuntimeException; {:try_start_11 .. :try_end_11} :catch_9
+
+    :goto_13
+    if-lez v1, :cond_2a
+
+    const/4 v4, 0x2
+
+    if-gt v1, v4, :cond_2a
+
+    if-nez v2, :cond_29
+
+    const/4 v4, 0x0
+
+    :try_start_12
+    new-array v2, v4, [I
+    :try_end_12
+    .catch Ljava/lang/RuntimeException; {:try_start_12 .. :try_end_12} :catch_2
+
+    :cond_29
+    :try_start_13
+    array-length v4, v2
+
+    add-int/2addr v4, v1
+
+    new-array v4, v4, [I
+
+    array-length v6, v2
+    :try_end_13
+    .catch Ljava/lang/RuntimeException; {:try_start_13 .. :try_end_13} :catch_9
+
+    const/4 v8, 0x0
+
+    :try_start_14
+    invoke-static {v2, v8, v4, v8, v6}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
+
+    array-length v2, v2
+
+    invoke-static {v3, v8, v4, v2, v1}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
+    :try_end_14
+    .catch Ljava/lang/RuntimeException; {:try_start_14 .. :try_end_14} :catch_6
+
+    :try_start_15
+    invoke-virtual {v15, v4}, Lcom/android/server/am/ProcessRecord;->setGids([I)V
+
+    move-object v2, v4
+
+    goto :goto_14
+
+    :catch_6
+    move-exception v0
+
+    move/from16 v18, v8
+
+    goto/16 :goto_c
+
+    :cond_2a
+    :goto_14
     iget v1, v15, Lcom/android/server/am/ProcessRecord;->userId:I
 
     invoke-static {v1}, Lcom/samsung/android/knox/SemPersonaManager;->isDarDualEncryptionEnabled(I)Z
 
     move-result v1
 
-    if-eqz v1, :cond_29
+    if-eqz v1, :cond_2c
 
     iget v1, v15, Lcom/android/server/am/ProcessRecord;->userId:I
 
@@ -17003,7 +17155,7 @@
 
     move-result v1
 
-    if-eqz v1, :cond_29
+    if-eqz v1, :cond_2c
 
     iget-object v1, v14, Lcom/android/server/am/ProcessList;->mService:Lcom/android/server/am/ActivityManagerService;
 
@@ -17019,7 +17171,7 @@
 
     move-result v1
 
-    if-nez v1, :cond_29
+    if-nez v1, :cond_2c
 
     new-instance v1, Ljava/lang/StringBuilder;
 
@@ -17041,17 +17193,17 @@
 
     invoke-static {v10, v1}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    if-nez v2, :cond_28
+    if-nez v2, :cond_2b
 
     const/4 v1, 0x1
 
     new-array v2, v1, [I
 
-    const/4 v8, 0x0
+    const/4 v12, 0x0
 
-    goto :goto_12
+    goto :goto_15
 
-    :cond_28
+    :cond_2b
     const/4 v1, 0x1
 
     array-length v3, v2
@@ -17061,17 +17213,17 @@
     new-array v3, v3, [I
 
     array-length v4, v2
-    :try_end_c
-    .catch Ljava/lang/RuntimeException; {:try_start_c .. :try_end_c} :catch_4
+    :try_end_15
+    .catch Ljava/lang/RuntimeException; {:try_start_15 .. :try_end_15} :catch_9
 
-    const/4 v8, 0x0
+    const/4 v12, 0x0
 
-    :try_start_d
-    invoke-static {v2, v8, v3, v8, v4}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
+    :try_start_16
+    invoke-static {v2, v12, v3, v12, v4}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
 
     move-object v2, v3
 
-    :goto_12
+    :goto_15
     array-length v3, v2
 
     sub-int/2addr v3, v1
@@ -17082,17 +17234,17 @@
 
     invoke-virtual {v15, v2}, Lcom/android/server/am/ProcessRecord;->setGids([I)V
 
-    goto :goto_13
+    goto :goto_16
 
-    :cond_29
-    const/4 v8, 0x0
+    :cond_2c
+    const/4 v12, 0x0
 
-    :goto_13
+    :goto_16
     move-object v6, v2
 
     const-string v3, "android.app.ActivityThread"
-    :try_end_d
-    .catch Ljava/lang/RuntimeException; {:try_start_d .. :try_end_d} :catch_3
+    :try_end_16
+    .catch Ljava/lang/RuntimeException; {:try_start_16 .. :try_end_16} :catch_7
 
     move-object/from16 v1, p0
 
@@ -17100,75 +17252,84 @@
 
     move-object/from16 v4, p1
 
-    move-object/from16 v18, v19
-
-    move/from16 v19, v8
+    move-object/from16 v13, v19
 
     move/from16 v8, p3
 
-    move-object/from16 v22, v10
+    move-object/from16 v24, v10
 
     move-object/from16 v10, v21
 
-    move-wide/from16 v20, v12
+    move/from16 v18, v12
 
-    move-object/from16 v12, v18
+    move-wide/from16 v19, v22
+
+    move-object v12, v13
 
     move-object v13, v0
 
-    move-wide/from16 v14, v20
+    move-wide/from16 v14, v19
 
-    :try_start_e
+    :try_start_17
     invoke-virtual/range {v1 .. v17}, Lcom/android/server/am/ProcessList;->startProcessLocked(Lcom/android/server/am/HostingRecord;Ljava/lang/String;Lcom/android/server/am/ProcessRecord;I[IIIILjava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;JJ)Z
 
     move-result v0
 
     return v0
 
-    :catch_3
+    :catch_7
+    move-exception v0
+
+    move-object/from16 v24, v10
+
+    move/from16 v18, v12
+
+    goto :goto_17
+
+    :catch_8
     move-exception v0
 
-    move/from16 v19, v8
+    move/from16 v18, v1
 
     goto/16 :goto_c
 
-    :catch_4
+    :catch_9
     move-exception v0
 
-    move-object/from16 v22, v10
+    move-object/from16 v24, v10
 
-    const/16 v19, 0x0
+    const/16 v18, 0x0
 
-    goto :goto_14
+    goto :goto_17
 
-    :catch_5
+    :catch_a
     move-exception v0
 
-    move-object/from16 v22, v10
+    move-object/from16 v24, v10
 
-    move/from16 v19, v11
+    move/from16 v18, v11
 
     invoke-virtual {v0}, Landroid/os/RemoteException;->rethrowAsRuntimeException()Ljava/lang/RuntimeException;
 
     move-result-object v0
 
     throw v0
-    :try_end_e
-    .catch Ljava/lang/RuntimeException; {:try_start_e .. :try_end_e} :catch_6
+    :try_end_17
+    .catch Ljava/lang/RuntimeException; {:try_start_17 .. :try_end_17} :catch_b
 
-    :catch_6
+    :catch_b
     move-exception v0
 
-    goto :goto_14
+    goto :goto_17
 
-    :catch_7
+    :catch_c
     move-exception v0
 
-    move-object/from16 v22, v10
+    move-object/from16 v24, v10
 
-    move/from16 v19, v11
+    move/from16 v18, v11
 
-    :goto_14
+    :goto_17
     new-instance v1, Ljava/lang/StringBuilder;
 
     invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
@@ -17187,7 +17348,7 @@
 
     move-result-object v1
 
-    move-object/from16 v3, v22
+    move-object/from16 v3, v24
 
     invoke-static {v3, v1, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
@@ -17237,7 +17398,7 @@
 
     invoke-virtual/range {v0 .. v9}, Lcom/android/server/am/ActivityManagerService;->forceStopPackageLocked(Ljava/lang/String;IZZZZZILjava/lang/String;)Z
 
-    return v19
+    return v18
 .end method
 
 .method public unregisterProcessObserver(Landroid/app/IProcessObserver;)V
diff --git a/smali/com/android/server/am/UserController$Injector.smali b/smali/com/android/server/am/UserController$Injector.smali
index 996b78f8e..241e0ccc3 100644
--- a/smali/com/android/server/am/UserController$Injector.smali
+++ b/smali/com/android/server/am/UserController$Injector.smali
@@ -486,6 +486,24 @@
     return-object p0
 .end method
 
+.method public getDarManagerService()Lcom/android/server/knox/dar/DarManagerService;
+    .locals 0
+
+    const-string p0, "dar"
+
+    invoke-static {p0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/samsung/android/knox/dar/IDarManagerService$Stub;->asInterface(Landroid/os/IBinder;)Lcom/samsung/android/knox/dar/IDarManagerService;
+
+    move-result-object p0
+
+    check-cast p0, Lcom/android/server/knox/dar/DarManagerService;
+
+    return-object p0
+.end method
+
 .method public getHandler(Landroid/os/Handler$Callback;)Landroid/os/Handler;
     .locals 2
 
@@ -539,8 +557,25 @@
 .end method
 
 .method public getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
-    .locals 0
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/am/UserController$Injector;->getDarManagerService()Lcom/android/server/knox/dar/DarManagerService;
+
+    move-result-object v0
 
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/am/UserController$Injector;->getDarManagerService()Lcom/android/server/knox/dar/DarManagerService;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     const/4 p0, 0x0
 
     return-object p0
diff --git a/smali_classes2/com/android/server/devicepolicy/DevicePolicyManagerService$Injector.smali b/smali_classes2/com/android/server/devicepolicy/DevicePolicyManagerService$Injector.smali
index 9874210df..42244fc7f 100644
--- a/smali_classes2/com/android/server/devicepolicy/DevicePolicyManagerService$Injector.smali
+++ b/smali_classes2/com/android/server/devicepolicy/DevicePolicyManagerService$Injector.smali
@@ -1016,7 +1016,7 @@
 .method public isDeviceSupportKnoxSDP()Z
     .locals 0
 
-    const/4 p0, 0x0
+    const/4 p0, 0x1
 
     return p0
 .end method
diff --git a/smali_classes2/com/android/server/enterprise/container/KnoxMUMContainerPolicy.smali b/smali_classes2/com/android/server/enterprise/container/KnoxMUMContainerPolicy.smali
index 23d7e14b4..49e85c875 100644
--- a/smali_classes2/com/android/server/enterprise/container/KnoxMUMContainerPolicy.smali
+++ b/smali_classes2/com/android/server/enterprise/container/KnoxMUMContainerPolicy.smali
@@ -3792,6 +3792,12 @@
     :try_start_1
     invoke-static {v11}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z
 
+    move-result v7
+
+    if-nez v7, :cond_6
+
+    invoke-virtual {v0, v11}, Lcom/android/server/enterprise/container/KnoxMUMContainerPolicy;->validateResetPwdKey(Ljava/lang/String;)Z
+
     move-result v7
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_1
@@ -3800,7 +3806,7 @@
 
     invoke-static {v13, v14}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    const/16 v0, -0x400
+    const/16 v0, -0x401
 
     return v0
 
@@ -20668,6 +20674,99 @@
     throw p0
 .end method
 
+.method public final validateResetPwdKey(Ljava/lang/String;)Z
+    .locals 3
+
+    const/4 p0, 0x0
+
+    if-eqz p1, :cond_5
+
+    move v0, p0
+
+    :goto_0
+    invoke-virtual {p1}, Ljava/lang/String;->length()I
+
+    move-result v1
+
+    if-ge v0, v1, :cond_3
+
+    invoke-virtual {p1, v0}, Ljava/lang/String;->charAt(I)C
+
+    move-result v1
+
+    const/16 v2, 0x41
+
+    if-lt v1, v2, :cond_0
+
+    const/16 v2, 0x5a
+
+    if-gt v1, v2, :cond_0
+
+    goto :goto_1
+
+    :cond_0
+    const/16 v2, 0x61
+
+    if-lt v1, v2, :cond_1
+
+    const/16 v2, 0x7a
+
+    if-gt v1, v2, :cond_1
+
+    goto :goto_1
+
+    :cond_1
+    const/16 v2, 0x30
+
+    if-lt v1, v2, :cond_2
+
+    const/16 v2, 0x39
+
+    :cond_2
+    :goto_1
+    add-int/lit8 v0, v0, 0x1
+
+    goto :goto_0
+
+    :cond_3
+    invoke-virtual {p1}, Ljava/lang/String;->length()I
+
+    move-result v0
+
+    const/16 v1, 0x80
+
+    if-gt v0, v1, :cond_4
+
+    invoke-virtual {p1}, Ljava/lang/String;->length()I
+
+    move-result p1
+
+    const/16 v0, 0x20
+
+    if-lt p1, v0, :cond_4
+
+    sget-object p0, Lcom/android/server/enterprise/container/KnoxMUMContainerPolicy;->TAG:Ljava/lang/String;
+
+    const-string p1, " inside validateResetPwdKey password is validated"
+
+    invoke-static {p0, p1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    const/4 p0, 0x1
+
+    goto :goto_2
+
+    :cond_4
+    sget-object p1, Lcom/android/server/enterprise/container/KnoxMUMContainerPolicy;->TAG:Ljava/lang/String;
+
+    const-string v0, " inside validateResetPwdKey password is not per requirement "
+
+    invoke-static {p1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_5
+    :goto_2
+    return p0
+.end method
+
 .method public final writeFile(Landroid/graphics/Bitmap;Ljava/lang/String;)Z
     .locals 3
 
diff --git a/smali_classes2/com/android/server/knox/ContainerDependencyWrapper.smali b/smali_classes2/com/android/server/knox/ContainerDependencyWrapper.smali
index b41dedf51..3f8db613b 100644
--- a/smali_classes2/com/android/server/knox/ContainerDependencyWrapper.smali
+++ b/smali_classes2/com/android/server/knox/ContainerDependencyWrapper.smali
@@ -2629,7 +2629,41 @@
 
 # virtual methods
 .method public callOnCMFALocked(I)V
-    .locals 0
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/knox/ContainerDependencyWrapper;->getDarManagerService()Lcom/android/server/knox/dar/DarManagerService;
+
+    move-result-object v0
+
+    if-eqz v0, :cond_0
 
+    iget-object p0, p0, Lcom/android/server/knox/ContainerDependencyWrapper;->mDarService:Lcom/android/server/knox/dar/DarManagerService;
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/DarManagerService;->onCMFALocked(I)V
+
+    :cond_0
     return-void
 .end method
+
+.method public final getDarManagerService()Lcom/android/server/knox/dar/DarManagerService;
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/knox/ContainerDependencyWrapper;->mDarService:Lcom/android/server/knox/dar/DarManagerService;
+
+    if-nez v0, :cond_0
+
+    const-string v0, "dar"
+
+    invoke-static {v0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/DarManagerService;
+
+    iput-object v0, p0, Lcom/android/server/knox/ContainerDependencyWrapper;->mDarService:Lcom/android/server/knox/dar/DarManagerService;
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/knox/ContainerDependencyWrapper;->mDarService:Lcom/android/server/knox/dar/DarManagerService;
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/knox/dar/DarManagerService.smali b/smali_classes2/com/android/server/knox/dar/DarManagerService.smali
index 6c6398fa6..216c49c60 100644
--- a/smali_classes2/com/android/server/knox/dar/DarManagerService.smali
+++ b/smali_classes2/com/android/server/knox/dar/DarManagerService.smali
@@ -183,6 +183,14 @@
 
     iput-object v0, p0, Lcom/android/server/knox/dar/DarManagerService;->mVirtualLockImpl:Lcom/android/server/knox/dar/VirtualLockImpl;
 
+    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-direct {v0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;-><init>(Lcom/android/server/knox/dar/DarManagerService$Injector;)V
+
+    iput-object v0, p0, Lcom/android/server/knox/dar/DarManagerService;->mSdpManagerImpl:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->prepareSdpService()V
+
     new-instance v0, Lcom/android/server/knox/dar/ddar/core/DualDarDoManagerImpl;
 
     invoke-direct {v0, p1}, Lcom/android/server/knox/dar/ddar/core/DualDarDoManagerImpl;-><init>(Lcom/android/server/knox/dar/DarManagerService$Injector;)V
@@ -1531,10 +1539,39 @@
 .end method
 
 .method public handleDeviceOwnerChanged()V
-    .locals 0
+    .locals 1
 
     invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->checkSystemPermission()V
 
+    invoke-static {}, Lcom/samsung/android/knox/dar/ddar/DualDarManager;->isOnDeviceOwnerEnabled()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    const/4 v0, 0x1
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/DarUtil;->setDoEnabled(Z)V
+
+    iget-object p0, p0, Lcom/android/server/knox/dar/DarManagerService;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
+
+    const/4 v0, 0x0
+
+    invoke-virtual {p0, v0}, Lcom/android/internal/widget/LockPatternUtils;->setDeviceOwner(I)V
+
+    const-string p0, "Skip sdp engine creation for dual-dar do"
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    return-void
+
+    :cond_0
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->handleDeviceOwnerChanged()V
+
     return-void
 .end method
 
@@ -2587,6 +2624,23 @@
 .method public isSdpSupported()Z
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object p0
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isSdpSupported()Z
+
+    move-result p0
+
+    return p0
+
+    :cond_0
     const-string p0, "DarManagerService_SDP"
 
     const-string v0, "SDP not supported"
@@ -2744,6 +2798,65 @@
     return-void
 .end method
 
+.method public onCMFALocked(I)V
+    .locals 2
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->isDarSupported()Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    return-void
+
+    :cond_0
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->isSdpSupported()Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    return-void
+
+    :cond_1
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "CMFA locked for user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    const-string v1, "DarManagerService_SDP"
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/DarManagerService;->getUserInfo(I)Landroid/content/pm/UserInfo;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/DarUtil;->isEnterpriseUser(Landroid/content/pm/UserInfo;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->lockSdpIfRequired(I)V
+
+    :cond_2
+    return-void
+.end method
+
 .method public onDeviceOwnerLocked(I)V
     .locals 1
 
@@ -2787,6 +2900,18 @@
     return-void
 .end method
 
+.method public final prepareSdpService()V
+    .locals 1
+
+    const-string p0, "DarManagerService_SDP"
+
+    const-string/jumbo v0, "prepare Sdp Service"
+
+    invoke-static {p0, v0}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
+
+    return-void
+.end method
+
 .method public prepareSecuredDataKey(I)V
     .locals 2
 
diff --git a/smali_classes2/com/android/server/knox/dar/DarUtil.smali b/smali_classes2/com/android/server/knox/dar/DarUtil.smali
index ba94c1b60..927a12349 100644
--- a/smali_classes2/com/android/server/knox/dar/DarUtil.smali
+++ b/smali_classes2/com/android/server/knox/dar/DarUtil.smali
@@ -339,6 +339,59 @@
     return v0
 .end method
 
+.method public static isFileBasedEncryption()Z
+    .locals 4
+
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    move-result-wide v0
+
+    :try_start_0
+    const-string/jumbo v2, "ro.crypto.type"
+
+    invoke-static {v2}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v2
+
+    const-string v3, "file"
+
+    invoke-virtual {v2, v3}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v2
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception v2
+
+    goto :goto_1
+
+    :catch_0
+    move-exception v2
+
+    :try_start_1
+    invoke-virtual {v2}, Ljava/lang/Exception;->printStackTrace()V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    const/4 v2, 0x0
+
+    :goto_0
+    return v2
+
+    :goto_1
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    throw v2
+.end method
+
 .method public static isLegacyContainerUser(Landroid/content/pm/UserInfo;)Z
     .locals 3
 
diff --git a/smali_classes2/com/android/server/knox/dar/EnterprisePartitionManager.smali b/smali_classes2/com/android/server/knox/dar/EnterprisePartitionManager.smali
index aa4eaf670..c4a1e20a8 100644
--- a/smali_classes2/com/android/server/knox/dar/EnterprisePartitionManager.smali
+++ b/smali_classes2/com/android/server/knox/dar/EnterprisePartitionManager.smali
@@ -1958,6 +1958,41 @@
     throw p1
 .end method
 
+.method public setSdpPolicy(I)Z
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/EnterprisePartitionManager;->mContext:Landroid/content/Context;
+
+    const-class v1, Landroid/os/storage/StorageManager;
+
+    invoke-virtual {v0, v1}, Landroid/content/Context;->getSystemService(Ljava/lang/Class;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Landroid/os/storage/StorageManager;
+
+    iput-object v0, p0, Lcom/android/server/knox/dar/EnterprisePartitionManager;->storage:Landroid/os/storage/StorageManager;
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {v0, p1}, Landroid/os/storage/StorageManager;->setSdpPolicy(I)Z
+
+    move-result p0
+
+    return p0
+
+    :cond_0
+    const-string p0, "EnterprisePartitionManager"
+
+    const-string p1, "StorageManager instance is NULL"
+
+    invoke-static {p0, p1}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    const/4 p0, 0x0
+
+    return p0
+.end method
+
 .method public setSdpPolicyToPath(ILjava/lang/String;)Z
     .locals 2
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3.smali
index 6ae7a765a..02b9f59bf 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3.smali
@@ -7,20 +7,20 @@
 
 
 # instance fields
-.field public final synthetic f$0:Ljava/lang/String;
+.field public final synthetic f$0:I
 
-.field public final synthetic f$1:I
+.field public final synthetic f$1:Ljava/io/File;
 
 
 # direct methods
-.method public synthetic constructor <init>(Ljava/lang/String;I)V
+.method public synthetic constructor <init>(ILjava/io/File;)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$0:Ljava/lang/String;
+    iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$0:I
 
-    iput p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$1:I
+    iput-object p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$1:Ljava/io/File;
 
     return-void
 .end method
@@ -30,13 +30,13 @@
 .method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
     .locals 1
 
-    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$0:Ljava/lang/String;
+    iget v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$0:I
 
-    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$1:I
+    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;->f$1:Ljava/io/File;
 
-    check-cast p1, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
 
-    invoke-static {v0, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$mU76E6wCBo3TlspzSaSaGS2vIXk(Ljava/lang/String;ILcom/android/server/pm/PackageManagerService$IPackageManagerImpl;)Ljava/lang/Boolean;
+    invoke-static {v0, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$4uoUzNd78HU1MImGYswpBUPP4Ss(ILjava/io/File;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4.smali
index cc8c3cead..a59bb262f 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4.smali
@@ -7,24 +7,20 @@
 
 
 # instance fields
-.field public final synthetic f$0:[B
+.field public final synthetic f$0:Ljava/lang/String;
 
-.field public final synthetic f$1:J
-
-.field public final synthetic f$2:I
+.field public final synthetic f$1:I
 
 
 # direct methods
-.method public synthetic constructor <init>([BJI)V
+.method public synthetic constructor <init>(Ljava/lang/String;I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$0:[B
-
-    iput-wide p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$1:J
+    iput-object p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$0:Ljava/lang/String;
 
-    iput p4, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$2:I
+    iput p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$1:I
 
     return-void
 .end method
@@ -32,17 +28,15 @@
 
 # virtual methods
 .method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
-    .locals 3
-
-    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$0:[B
+    .locals 1
 
-    iget-wide v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$1:J
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$0:Ljava/lang/String;
 
-    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$2:I
+    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;->f$1:I
 
-    check-cast p1, Lcom/android/internal/widget/ILockSettings;
+    check-cast p1, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;
 
-    invoke-static {v0, v1, v2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$bw0CKvIaIdUJeRIMefA1OhM_KA4([BJILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-static {v0, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$mU76E6wCBo3TlspzSaSaGS2vIXk(Ljava/lang/String;ILcom/android/server/pm/PackageManagerService$IPackageManagerImpl;)Ljava/lang/Boolean;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5.smali
index bd744d38d..a186e2025 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5.smali
@@ -7,24 +7,24 @@
 
 
 # instance fields
-.field public final synthetic f$0:I
+.field public final synthetic f$0:[B
 
-.field public final synthetic f$1:Ljava/lang/String;
+.field public final synthetic f$1:J
 
 .field public final synthetic f$2:I
 
 
 # direct methods
-.method public synthetic constructor <init>(ILjava/lang/String;I)V
+.method public synthetic constructor <init>([BJI)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$0:I
+    iput-object p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$0:[B
 
-    iput-object p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$1:Ljava/lang/String;
+    iput-wide p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$1:J
 
-    iput p3, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$2:I
+    iput p4, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$2:I
 
     return-void
 .end method
@@ -32,17 +32,17 @@
 
 # virtual methods
 .method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
-    .locals 2
+    .locals 3
 
-    iget v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$0:I
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$0:[B
 
-    iget-object v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$1:Ljava/lang/String;
+    iget-wide v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$1:J
 
     iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;->f$2:I
 
     check-cast p1, Lcom/android/internal/widget/ILockSettings;
 
-    invoke-static {v0, v1, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$Bni0A_Nptmz0mFfiMMCdwAeK1LI(ILjava/lang/String;ILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-static {v0, v1, v2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$bw0CKvIaIdUJeRIMefA1OhM_KA4([BJILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6.smali
index b8c5c5066..3de3b6128 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6.smali
@@ -9,28 +9,40 @@
 # instance fields
 .field public final synthetic f$0:I
 
+.field public final synthetic f$1:Ljava/lang/String;
+
+.field public final synthetic f$2:I
+
 
 # direct methods
-.method public synthetic constructor <init>(I)V
+.method public synthetic constructor <init>(ILjava/lang/String;I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
     iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$0:I
 
+    iput-object p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$1:Ljava/lang/String;
+
+    iput p3, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$2:I
+
     return-void
 .end method
 
 
 # virtual methods
 .method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
-    .locals 0
+    .locals 2
+
+    iget v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$0:I
+
+    iget-object v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$1:Ljava/lang/String;
 
-    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$0:I
+    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;->f$2:I
 
-    check-cast p1, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;
+    check-cast p1, Lcom/android/internal/widget/ILockSettings;
 
-    invoke-static {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$vNp5G6g342e_KABHiOOnQZD2e_I(ILcom/android/server/pm/PackageManagerService$IPackageManagerImpl;)Ljava/lang/Boolean;
+    invoke-static {v0, v1, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$Bni0A_Nptmz0mFfiMMCdwAeK1LI(ILjava/lang/String;ILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7.smali
new file mode 100644
index 000000000..0cec2099f
--- /dev/null
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7;->f$0:I
+
+    check-cast p1, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$vNp5G6g342e_KABHiOOnQZD2e_I(ILcom/android/server/pm/PackageManagerService$IPackageManagerImpl;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8.smali
new file mode 100644
index 000000000..4933005eb
--- /dev/null
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8.smali
@@ -0,0 +1,44 @@
+.class public final synthetic Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+.field public final synthetic f$1:J
+
+
+# direct methods
+.method public synthetic constructor <init>(IJ)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;->f$0:I
+
+    iput-wide p2, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;->f$1:J
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 3
+
+    iget v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;->f$0:I
+
+    iget-wide v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;->f$1:J
+
+    check-cast p1, Lcom/android/internal/widget/ILockSettings;
+
+    invoke-static {v0, v1, v2, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->$r8$lambda$K1yGPlJt_y5KnaoCWMgYNlYZkB0(IJLcom/android/internal/widget/ILockSettings;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService.smali
index 277451c21..738b5b9a2 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService.smali
@@ -50,6 +50,58 @@
     return-void
 .end method
 
+.method public setSdpPolicy(I)Z
+    .locals 3
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService;->this$0:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->-$$Nest$fgetmNeedToSetSdpPolicyForUser(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;)I
+
+    move-result v0
+
+    const/4 v1, 0x1
+
+    if-eq p1, v0, :cond_0
+
+    return v1
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService;->this$0:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    const/16 v2, -0x2710
+
+    invoke-static {v0, v2}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->-$$Nest$fputmNeedToSetSdpPolicyForUser(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;I)V
+
+    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$SdpLocalService;->this$0:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->-$$Nest$fgetmContext(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;)Landroid/content/Context;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/EnterprisePartitionManager;->getInstance(Landroid/content/Context;)Lcom/android/server/knox/dar/EnterprisePartitionManager;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/EnterprisePartitionManager;->setSdpPolicy(I)Z
+
+    move-result p0
+
+    if-nez p0, :cond_1
+
+    const-string p0, "SdpManagerImpl"
+
+    const-string/jumbo p1, "setSdpPolicy failed!"
+
+    invoke-static {p0, p1}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    const/4 p0, 0x0
+
+    return p0
+
+    :cond_1
+    return v1
+.end method
+
 .method public setSdpPolicyToPath(ILjava/lang/String;)Z
     .locals 0
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl.smali
index d1bd9d4e6..293ffbe41 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerImpl.smali
@@ -70,6 +70,16 @@
 
 
 # direct methods
+.method public static synthetic $r8$lambda$4uoUzNd78HU1MImGYswpBUPP4Ss(ILjava/io/File;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->lambda$handleDeviceOwnerChanged$6(ILjava/io/File;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static synthetic $r8$lambda$Bni0A_Nptmz0mFfiMMCdwAeK1LI(ILjava/lang/String;ILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
     .locals 0
 
@@ -80,6 +90,16 @@
     return-object p0
 .end method
 
+.method public static synthetic $r8$lambda$K1yGPlJt_y5KnaoCWMgYNlYZkB0(IJLcom/android/internal/widget/ILockSettings;)Ljava/lang/Object;
+    .locals 0
+
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->lambda$updateSdpMdfppModeForSystem$7(IJLcom/android/internal/widget/ILockSettings;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static synthetic $r8$lambda$TiTVJaW9nyC8CDL7zV7CLLDx4J0(ILcom/android/server/pm/UserManagerInternal;)Ljava/lang/Boolean;
     .locals 0
 
@@ -172,6 +192,14 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$fgetmNeedToSetSdpPolicyForUser(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;)I
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mNeedToSetSdpPolicyForUser:I
+
+    return p0
+.end method
+
 .method public static bridge synthetic -$$Nest$fgetmSdpEngineDb(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;)Lcom/android/server/knox/dar/sdp/SdpManagerImpl$SdpEngineDatabase;
     .locals 0
 
@@ -196,6 +224,14 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$fputmNeedToSetSdpPolicyForUser(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;I)V
+    .locals 0
+
+    iput p1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mNeedToSetSdpPolicyForUser:I
+
+    return-void
+.end method
+
 .method public static bridge synthetic -$$Nest$mcheckCallerPermissionFor(Lcom/android/server/knox/dar/sdp/SdpManagerImpl;Ljava/lang/String;)V
     .locals 0
 
@@ -634,6 +670,70 @@
     return-void
 .end method
 
+.method public static isLDUModel()Z
+    .locals 3
+
+    invoke-static {}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->readOMCSalesCode()Ljava/lang/String;
+
+    move-result-object v0
+
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v2, "isLDUModel : sales code : "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    const-string v2, "SdpManagerImpl"
+
+    invoke-static {v2, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    const-string v1, "PAP"
+
+    invoke-virtual {v1, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v1
+
+    if-nez v1, :cond_1
+
+    const-string v1, "FOP"
+
+    invoke-virtual {v1, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v1
+
+    if-nez v1, :cond_1
+
+    const-string v1, "LDU"
+
+    invoke-virtual {v1, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 v0, 0x0
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 v0, 0x1
+
+    :goto_1
+    return v0
+.end method
+
 .method public static synthetic lambda$checkCredential$2(ILjava/lang/String;ILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
     .locals 3
 
@@ -714,6 +814,24 @@
     return-object p0
 .end method
 
+.method public static synthetic lambda$handleDeviceOwnerChanged$6(ILjava/io/File;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-virtual {p1}, Ljava/io/File;->getPath()Ljava/lang/String;
+
+    move-result-object p1
+
+    invoke-virtual {p2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;->setSdpPolicyToPath(ILjava/lang/String;)Z
+
+    move-result p0
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static synthetic lambda$handleUserRemoved$5(ILcom/android/server/pm/PackageManagerService$IPackageManagerImpl;)Ljava/lang/Boolean;
     .locals 0
 
@@ -758,6 +876,27 @@
     return-object p0
 .end method
 
+.method public static synthetic lambda$updateSdpMdfppModeForSystem$7(IJLcom/android/internal/widget/ILockSettings;)Ljava/lang/Object;
+    .locals 0
+
+    :try_start_0
+    invoke-interface {p3, p0, p1, p2}, Lcom/android/internal/widget/ILockSettings;->updateSdpMdfppForSystem(IJ)V
+    :try_end_0
+    .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
+
+    goto :goto_0
+
+    :catch_0
+    move-exception p0
+
+    invoke-virtual {p0}, Landroid/os/RemoteException;->printStackTrace()V
+
+    :goto_0
+    const/4 p0, 0x0
+
+    return-object p0
+.end method
+
 .method public static synthetic lambda$verifyToken$0([BJILcom/android/internal/widget/ILockSettings;)Lcom/android/internal/widget/VerifyCredentialResponse;
     .locals 0
 
@@ -801,6 +940,75 @@
 .method public static native nativeOnUserRemoved(II)I
 .end method
 
+.method public static readOMCSalesCode()Ljava/lang/String;
+    .locals 4
+
+    const-string v0, ""
+
+    :try_start_0
+    const-string/jumbo v1, "persist.omc.sales_code"
+
+    invoke-static {v1}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    if-eqz v1, :cond_0
+
+    :try_start_1
+    invoke-virtual {v1}, Ljava/lang/String;->isEmpty()Z
+
+    move-result v2
+
+    if-eqz v2, :cond_2
+
+    :cond_0
+    const-string/jumbo v2, "ro.csc.sales_code"
+
+    invoke-static {v2}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    if-eqz v1, :cond_1
+
+    invoke-virtual {v1}, Ljava/lang/String;->isEmpty()Z
+
+    move-result v2
+
+    if-eqz v2, :cond_2
+
+    :cond_1
+    const-string/jumbo v2, "ril.sales_code"
+
+    invoke-static {v2}, Landroid/os/SystemProperties;->get(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+    :try_end_1
+    .catch Ljava/lang/Exception; {:try_start_1 .. :try_end_1} :catch_1
+
+    goto :goto_0
+
+    :catch_0
+    move-object v1, v0
+
+    :catch_1
+    const-string v2, "SdpManagerImpl"
+
+    const-string/jumbo v3, "readOMCSalesCode failed"
+
+    invoke-static {v2, v3}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_2
+    :goto_0
+    if-nez v1, :cond_3
+
+    return-object v0
+
+    :cond_3
+    return-object v1
+.end method
+
 
 # virtual methods
 .method public addEngine(Lcom/samsung/android/knox/sdp/core/SdpCreationParam;Ljava/lang/String;Ljava/lang/String;)I
@@ -2236,9 +2444,9 @@
 
     move-result-object p0
 
-    new-instance v2, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;
+    new-instance v2, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;
 
-    invoke-direct {v2, p2, p1, p3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;-><init>(ILjava/lang/String;I)V
+    invoke-direct {v2, p2, p1, p3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;-><init>(ILjava/lang/String;I)V
 
     invoke-virtual {p0, v2}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
@@ -2578,9 +2786,9 @@
 
     move-result-object p0
 
-    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;
+    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;
 
-    invoke-direct {v0, p2, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;-><init>(Ljava/lang/String;I)V
+    invoke-direct {v0, p2, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;-><init>(Ljava/lang/String;I)V
 
     invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
@@ -4265,48 +4473,337 @@
 
     if-eqz p0, :cond_1
 
-    goto :goto_1
+    goto :goto_1
+
+    :cond_1
+    sget-object p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->NULL_USER:Landroid/content/pm/UserInfo;
+
+    :goto_1
+    return-object p0
+.end method
+
+.method public final getUserManagerInternal()Ljava/util/Optional;
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+
+    if-nez v0, :cond_0
+
+    const-class v0, Lcom/android/server/pm/UserManagerInternal;
+
+    invoke-static {v0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/pm/UserManagerInternal;
+
+    iput-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public final handleCleanupUser(I)V
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->cancelLegacyResetTimeout(I)V
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->clearLegacyResetStatus(I)V
+
+    return-void
+.end method
+
+.method public handleDeviceOwnerChanged()V
+    .locals 6
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->checkSystemPermission()V
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isSupportedDevice()Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    return-void
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mDevicePolicyManager:Landroid/app/admin/DevicePolicyManager;
+
+    invoke-virtual {v0}, Landroid/app/admin/DevicePolicyManager;->getDeviceOwner()Ljava/lang/String;
+
+    move-result-object v0
+
+    iget-object v1, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mDevicePolicyManager:Landroid/app/admin/DevicePolicyManager;
+
+    invoke-virtual {v1}, Landroid/app/admin/DevicePolicyManager;->getDeviceOwnerUserId()I
+
+    move-result v1
+
+    const-string v2, "Device Owner has been changed!"
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    const-string v2, "Confirming Device Owner information [ Owner : %s, User : %d ]"
+
+    invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v3
+
+    filled-new-array {v0, v3}, [Ljava/lang/Object;
+
+    move-result-object v3
+
+    invoke-static {v2, v3}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/SecureUtil;->isEmpty(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    const/4 v2, 0x1
+
+    const/4 v3, 0x0
+
+    if-nez v0, :cond_8
+
+    if-eqz v1, :cond_1
+
+    goto/16 :goto_2
+
+    :cond_1
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mSdpDatabaseCache:Lcom/android/server/knox/dar/sdp/SdpDatabaseCache;
+
+    const-string v4, "do_cleared"
+
+    invoke-virtual {v0, v3, v4, v3}, Lcom/android/server/knox/dar/sdp/SdpDatabaseCache;->putBoolean(ILjava/lang/String;Z)V
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mSdpEngineDbLock:Ljava/lang/Object;
+
+    monitor-enter v0
+
+    :try_start_0
+    invoke-virtual {p0, v1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getEngineInfoLocked(I)Lcom/samsung/android/knox/sdp/core/SdpEngineInfo;
+
+    move-result-object v4
+
+    if-eqz v4, :cond_2
+
+    const-string p0, "Unexpected condition as per DO\' already has engine"
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    monitor-exit v0
+
+    return-void
+
+    :cond_2
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/DarUtil;->setDoEnabled(Z)V
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
+
+    invoke-virtual {v0, v1}, Lcom/android/internal/widget/LockPatternUtils;->setDeviceOwner(I)V
+
+    invoke-virtual {p0, v1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->welcomeNewUser(I)V
+
+    const/4 v0, 0x4
+
+    invoke-virtual {p0, v1, v0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->unlockSdpIfUnsecuredOrBiometricAuthenticated(II)V
+
+    invoke-static {}, Lcom/android/server/knox/dar/DarUtil;->isFileBasedEncryption()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_6
+
+    new-instance v0, Ljava/io/File;
+
+    const-string v4, "/data/knox/secure_fs/enc_media"
+
+    invoke-static {v1}, Ljava/lang/Integer;->toString(I)Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-direct {v0, v4, v5}, Ljava/io/File;-><init>(Ljava/lang/String;Ljava/lang/String;)V
+
+    invoke-virtual {v0}, Ljava/io/File;->exists()Z
+
+    move-result v4
+
+    if-nez v4, :cond_3
+
+    const-string v0, "Failed to set sdp policy due to non-existent target"
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto/16 :goto_1
+
+    :cond_3
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getSdpManagerInternal()Ljava/util/Optional;
+
+    move-result-object v4
+
+    new-instance v5, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;
+
+    invoke-direct {v5, v1, v0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda3;-><init>(ILjava/io/File;)V
+
+    invoke-virtual {v4, v5}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object v4
+
+    sget-object v5, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {v4, v5}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v4
+
+    check-cast v4, Ljava/lang/Boolean;
+
+    invoke-virtual {v4}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result v4
+
+    if-eqz v4, :cond_5
+
+    new-instance v4, Ljava/lang/StringBuilder;
+
+    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v5, "Successfully set sdp policy to "
+
+    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/io/File;->getPath()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v4, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mContext:Landroid/content/Context;
+
+    const-class v4, Landroid/os/storage/StorageManager;
+
+    invoke-virtual {v0, v4}, Landroid/content/Context;->getSystemService(Ljava/lang/Class;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Landroid/os/storage/StorageManager;
+
+    if-eqz v0, :cond_4
+
+    invoke-virtual {v0, v1}, Landroid/os/storage/StorageManager;->mountSdpMediaStorage(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_4
+
+    goto :goto_0
+
+    :cond_4
+    move v2, v3
+
+    :goto_0
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v4, "Result of mount sdp media storage : "
+
+    invoke-virtual {v0, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, v2}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto :goto_1
+
+    :cond_5
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v4, "Failed to set sdp policy to "
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/io/File;->getPath()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
 
-    :cond_1
-    sget-object p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->NULL_USER:Landroid/content/pm/UserInfo;
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
+    :cond_6
     :goto_1
-    return-object p0
-.end method
+    invoke-static {v3}, Lcom/samsung/android/knox/SemPersonaManager;->isDarDualEncryptionEnabled(I)Z
 
-.method public final getUserManagerInternal()Ljava/util/Optional;
-    .locals 1
+    move-result v0
 
-    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+    if-nez v0, :cond_7
 
-    if-nez v0, :cond_0
+    const-string v0, "SdpManagerImpl"
 
-    const-class v0, Lcom/android/server/pm/UserManagerInternal;
+    const-string v2, "Update SdpMdfpp for System."
 
-    invoke-static {v0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
+    invoke-static {v0, v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
 
-    move-result-object v0
+    const-wide/16 v2, 0x1
 
-    check-cast v0, Lcom/android/server/pm/UserManagerInternal;
+    invoke-virtual {p0, v1, v2, v3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->updateSdpMdfppModeForSystem(IJ)V
 
-    iput-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+    :cond_7
+    return-void
 
-    :cond_0
-    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mUserManagerInternal:Lcom/android/server/pm/UserManagerInternal;
+    :catchall_0
+    move-exception p0
 
-    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+    :try_start_1
+    monitor-exit v0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
-    move-result-object p0
+    throw p0
 
-    return-object p0
-.end method
+    :cond_8
+    :goto_2
+    const-string v0, "Device Owner turned out to be ejected..."
 
-.method public final handleCleanupUser(I)V
-    .locals 0
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
-    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->cancelLegacyResetTimeout(I)V
+    iget-object v0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mSdpDatabaseCache:Lcom/android/server/knox/dar/sdp/SdpDatabaseCache;
 
-    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->clearLegacyResetStatus(I)V
+    const-string v1, "do_cleared"
+
+    invoke-virtual {v0, v3, v1, v2}, Lcom/android/server/knox/dar/sdp/SdpDatabaseCache;->putBoolean(ILjava/lang/String;Z)V
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->updateDeviceOwnerStatus()V
 
     return-void
 .end method
@@ -5262,9 +5759,9 @@
 
     move-result-object p0
 
-    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;
+    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7;
 
-    invoke-direct {v0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda6;-><init>(I)V
+    invoke-direct {v0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda7;-><init>(I)V
 
     invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
@@ -5740,6 +6237,48 @@
     return p0
 .end method
 
+.method public isInitialized()Z
+    .locals 2
+
+    const-class v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    monitor-enter v0
+
+    :try_start_0
+    sget-boolean v1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mSystemReady:Z
+
+    if-nez v1, :cond_1
+
+    iget-boolean p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mIsHandlerReady:Z
+
+    if-eqz p0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 p0, 0x1
+
+    :goto_1
+    monitor-exit v0
+
+    return p0
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+.end method
+
 .method public isLicensed()I
     .locals 3
 
@@ -5794,6 +6333,30 @@
     return p0
 .end method
 
+.method public isNeedToEnableSdpMdfppModeForSystem(I)Z
+    .locals 0
+
+    if-nez p1, :cond_0
+
+    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
+
+    invoke-virtual {p0}, Lcom/android/internal/widget/LockPatternUtils;->isNeedToEnableSdpMdfppModeForSystem()Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    return p0
+.end method
+
 .method public final isPrivileged(Lcom/samsung/android/knox/sdp/core/SdpEngineInfo;)Z
     .locals 3
 
@@ -5842,6 +6405,30 @@
     return v1
 .end method
 
+.method public isSdpMdfppModeEnabledForSystem(I)Z
+    .locals 0
+
+    if-nez p1, :cond_0
+
+    iget-object p0, p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
+
+    invoke-virtual {p0}, Lcom/android/internal/widget/LockPatternUtils;->isSdpMdfppModeEnabledForSystem()Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    return p0
+.end method
+
 .method public isSdpPackage(ILjava/lang/String;)Z
     .locals 5
     .annotation runtime Landroid/annotation/SystemApi;
@@ -5908,6 +6495,73 @@
     return v2
 .end method
 
+.method public isSdpSupported()Z
+    .locals 4
+
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+
+    move-result v0
+
+    invoke-static {v0}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v0
+
+    invoke-virtual {p0, v0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getUserInfo(I)Landroid/content/pm/UserInfo;
+
+    move-result-object v1
+
+    invoke-virtual {v1}, Landroid/content/pm/UserInfo;->isGuest()Z
+
+    move-result v2
+
+    const/4 v3, 0x0
+
+    if-nez v2, :cond_3
+
+    invoke-virtual {v1}, Landroid/content/pm/UserInfo;->isDualAppProfile()Z
+
+    move-result v2
+
+    if-nez v2, :cond_3
+
+    invoke-virtual {v1}, Landroid/content/pm/UserInfo;->isBMode()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    invoke-static {v0}, Lcom/samsung/android/knox/SemPersonaManager;->isDarDualEncryptionEnabled(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    return v3
+
+    :cond_1
+    invoke-static {}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isLDUModel()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    return v3
+
+    :cond_2
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isSupportedDevice()Z
+
+    move-result p0
+
+    return p0
+
+    :cond_3
+    :goto_0
+    return v3
+.end method
+
 .method public isSensitive(Ljava/lang/String;)Z
     .locals 1
 
@@ -5934,15 +6588,9 @@
 .end method
 
 .method public final isSupportedDevice()Z
-    .locals 1
-
-    const-string p0, "SdpManagerImpl"
-
-    const-string v0, "SDP not supported"
-
-    invoke-static {p0, v0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+    .locals 0
 
-    const/4 p0, 0x0
+    const/4 p0, 0x1
 
     return p0
 .end method
@@ -6996,6 +7644,30 @@
     throw p0
 .end method
 
+.method public onLegacyResetCredentialFinalized(I)V
+    .locals 2
+
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "Legacy reset credential policy finalized for user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->clearLegacyResetStatus(I)V
+
+    return-void
+.end method
+
 .method public onLegacyResetCredentialRequested([BII)V
     .locals 4
 
@@ -7103,6 +7775,30 @@
     return-void
 .end method
 
+.method public onLegacyResetCredentialStarted(I)V
+    .locals 2
+
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "Legacy reset credential policy started for user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->cancelLegacyResetTimeout(I)V
+
+    return-void
+.end method
+
 .method public final onManagedProfileUnavailable(I)V
     .locals 2
 
@@ -11893,6 +12589,24 @@
     return-void
 .end method
 
+.method public updateSdpMdfppModeForSystem(IJ)V
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->checkSystemPermission()V
+
+    invoke-virtual {p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getLockSettings()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;
+
+    invoke-direct {v0, p1, p2, p3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda8;-><init>(IJ)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    return-void
+.end method
+
 .method public final verifyToken([BJI)Lcom/android/internal/widget/VerifyCredentialResponse;
     .locals 3
 
@@ -11905,9 +12619,9 @@
 
     move-result-object p0
 
-    new-instance v2, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;
+    new-instance v2, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;
 
-    invoke-direct {v2, p1, p2, p3, p4}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda4;-><init>([BJI)V
+    invoke-direct {v2, p1, p2, p3, p4}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl$$ExternalSyntheticLambda5;-><init>([BJI)V
 
     invoke-virtual {p0, v2}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerInternal.smali b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerInternal.smali
index 21a0e8f4c..9f0ec9188 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerInternal.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/SdpManagerInternal.smali
@@ -20,6 +20,9 @@
 .method public abstract setMasterKeyVersion(II)V
 .end method
 
+.method public abstract setSdpPolicy(I)Z
+.end method
+
 .method public abstract setSdpPolicyToPath(ILjava/lang/String;)Z
 .end method
 
diff --git a/smali_classes2/com/android/server/knox/dar/sdp/security/BytesUtil.smali b/smali_classes2/com/android/server/knox/dar/sdp/security/BytesUtil.smali
index cfff43d3d..70eee90aa 100644
--- a/smali_classes2/com/android/server/knox/dar/sdp/security/BytesUtil.smali
+++ b/smali_classes2/com/android/server/knox/dar/sdp/security/BytesUtil.smali
@@ -26,6 +26,30 @@
     return-void
 .end method
 
+.method public static bytesToInt([BII)I
+    .locals 2
+
+    const/4 v0, 0x4
+
+    invoke-static {v0}, Ljava/nio/ByteBuffer;->allocate(I)Ljava/nio/ByteBuffer;
+
+    move-result-object v0
+
+    sget-object v1, Lcom/android/server/knox/dar/sdp/security/BytesUtil;->DEFAULT_BYTE_ORDER:Ljava/nio/ByteOrder;
+
+    invoke-virtual {v0, v1}, Ljava/nio/ByteBuffer;->order(Ljava/nio/ByteOrder;)Ljava/nio/ByteBuffer;
+
+    invoke-virtual {v0, p0, p1, p2}, Ljava/nio/ByteBuffer;->put([BII)Ljava/nio/ByteBuffer;
+
+    invoke-virtual {v0}, Ljava/nio/ByteBuffer;->flip()Ljava/nio/Buffer;
+
+    invoke-virtual {v0}, Ljava/nio/ByteBuffer;->getInt()I
+
+    move-result p0
+
+    return p0
+.end method
+
 .method public static bytesToLong([B)J
     .locals 2
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10.smali
index 8cb261f0e..a62c73145 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10.smali
@@ -3,38 +3,36 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/lang/Runnable;
+.implements Ljava/util/function/Function;
 
 
 # instance fields
-.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
-
-.field public final synthetic f$1:J
+.field public final synthetic f$0:I
 
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;J)V
+.method public synthetic constructor <init>(I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$0:Lcom/android/server/locksettings/LockSettingsService;
-
-    iput-wide p2, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$1:J
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$0:I
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final run()V
-    .locals 3
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
 
-    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$0:I
 
-    iget-wide v1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;->f$1:J
+    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
 
-    invoke-static {v0, v1, v2}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$hxFRMJ-qy23Ksj0E5uph7lZu_Ww(Lcom/android/server/locksettings/LockSettingsService;J)V
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$8J6KUr7Op7Q4laSYt_FWDwOYHlY(ILcom/android/server/pm/PersonaManagerService;)Ljava/lang/Boolean;
 
-    return-void
+    move-result-object p0
+
+    return-object p0
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11.smali
index b308616c5..1bb26a01a 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11.smali
@@ -3,34 +3,32 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Function;
+.implements Ljava/util/function/Supplier;
 
 
 # instance fields
-.field public final synthetic f$0:I
+.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
 
 
 # direct methods
-.method public synthetic constructor <init>(I)V
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;->f$0:I
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+.method public final get()Ljava/lang/Object;
     .locals 0
 
-    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;->f$0:I
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
-    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
-
-    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$8J6KUr7Op7Q4laSYt_FWDwOYHlY(ILcom/android/server/pm/PersonaManagerService;)Ljava/lang/Boolean;
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$jAgFSB3vtTGARVwnrGilX8PbFIU(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12.smali
index 3b499832d..da9f6695d 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12.smali
@@ -28,7 +28,7 @@
 
     iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
-    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$jAgFSB3vtTGARVwnrGilX8PbFIU(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$HH6I5RSCFyZQ3CFAaJW-s_oHOas(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13.smali
index 1862d1793..1320d55f4 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13.smali
@@ -28,7 +28,7 @@
 
     iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
-    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$HH6I5RSCFyZQ3CFAaJW-s_oHOas(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$5o0h0fldPK5obVEr7xMeuZWYrrw(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14.smali
index 5aebd8cd4..55e5e5ad5 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14.smali
@@ -3,32 +3,34 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Supplier;
+.implements Ljava/util/function/Function;
 
 
 # instance fields
-.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
+.field public final synthetic f$0:I
 
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;)V
+.method public synthetic constructor <init>(I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;->f$0:I
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final get()Ljava/lang/Object;
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
     .locals 0
 
-    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;->f$0:I
 
-    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$5o0h0fldPK5obVEr7xMeuZWYrrw(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
+    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$S3R_qBk2E4mhsHEfwm4195vN0Z8(ILcom/android/server/pm/PersonaManagerService;)Ljava/lang/Boolean;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15.smali
index 46bddc59c..9c6b8881d 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15.smali
@@ -3,34 +3,32 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Function;
+.implements Ljava/util/function/Supplier;
 
 
 # instance fields
-.field public final synthetic f$0:I
+.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
 
 
 # direct methods
-.method public synthetic constructor <init>(I)V
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;->f$0:I
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+.method public final get()Ljava/lang/Object;
     .locals 0
 
-    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;->f$0:I
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
-    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
-
-    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$S3R_qBk2E4mhsHEfwm4195vN0Z8(ILcom/android/server/pm/PersonaManagerService;)Ljava/lang/Boolean;
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$ftbV1-uUdNATE66srgaXyvwoxsA(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
 
     move-result-object p0
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16.smali
index 402d3cf30..eba5bb4c2 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16.smali
@@ -3,34 +3,24 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Supplier;
-
-
-# instance fields
-.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
+.implements Ljava/lang/Runnable;
 
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;)V
+.method public synthetic constructor <init>()V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;->f$0:Lcom/android/server/locksettings/LockSettingsService;
-
     return-void
 .end method
 
 
 # virtual methods
-.method public final get()Ljava/lang/Object;
+.method public final run()V
     .locals 0
 
-    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+    invoke-static {}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$S-_jB2YpEnUEFRdAmvlGBYll4BM()V
 
-    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$ftbV1-uUdNATE66srgaXyvwoxsA(Lcom/android/server/locksettings/LockSettingsService;)Ljava/lang/String;
-
-    move-result-object p0
-
-    return-object p0
+    return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17.smali
index 754704b0e..defcfe89f 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17.smali
@@ -6,21 +6,41 @@
 .implements Ljava/lang/Runnable;
 
 
+# instance fields
+.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
+
+.field public final synthetic f$1:Landroid/content/Intent;
+
+.field public final synthetic f$2:[B
+
+
 # direct methods
-.method public synthetic constructor <init>()V
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+
+    iput-object p2, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$1:Landroid/content/Intent;
+
+    iput-object p3, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$2:[B
+
     return-void
 .end method
 
 
 # virtual methods
 .method public final run()V
-    .locals 0
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+
+    iget-object v1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$1:Landroid/content/Intent;
+
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;->f$2:[B
 
-    invoke-static {}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$S-_jB2YpEnUEFRdAmvlGBYll4BM()V
+    invoke-static {v0, v1, p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$wglhPfK9guUkeBPZB5zjUaW4Tmc(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
 
     return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19.smali
new file mode 100644
index 000000000..51407b0df
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$7JQII9w8jf_99bqGTu9cpfv6pH4(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8.smali
index 22fdef77d..5d58a48ce 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8.smali
@@ -3,44 +3,34 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/lang/Runnable;
+.implements Ljava/util/function/Consumer;
 
 
 # instance fields
-.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
-
-.field public final synthetic f$1:Landroid/content/Intent;
-
-.field public final synthetic f$2:[B
+.field public final synthetic f$0:I
 
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
+.method public synthetic constructor <init>(I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$0:Lcom/android/server/locksettings/LockSettingsService;
-
-    iput-object p2, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$1:Landroid/content/Intent;
-
-    iput-object p3, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$2:[B
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$0:I
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final run()V
-    .locals 2
-
-    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
 
-    iget-object v1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$1:Landroid/content/Intent;
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$0:I
 
-    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;->f$2:[B
+    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
 
-    invoke-static {v0, v1, p0}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$wglhPfK9guUkeBPZB5zjUaW4Tmc(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$EBrAdoJ0AkatDyv8RAlOdsxiMzw(ILcom/android/server/pm/PersonaManagerService;)V
 
     return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9.smali
index 5227182fc..7f80f8462 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9.smali
@@ -3,34 +3,38 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Consumer;
+.implements Ljava/lang/Runnable;
 
 
 # instance fields
-.field public final synthetic f$0:I
+.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService;
+
+.field public final synthetic f$1:J
 
 
 # direct methods
-.method public synthetic constructor <init>(I)V
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService;J)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$0:I
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$0:Lcom/android/server/locksettings/LockSettingsService;
+
+    iput-wide p2, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$1:J
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final accept(Ljava/lang/Object;)V
-    .locals 0
+.method public final run()V
+    .locals 3
 
-    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$0:I
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$0:Lcom/android/server/locksettings/LockSettingsService;
 
-    check-cast p1, Lcom/android/server/pm/PersonaManagerService;
+    iget-wide v1, p0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;->f$1:J
 
-    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$EBrAdoJ0AkatDyv8RAlOdsxiMzw(ILcom/android/server/pm/PersonaManagerService;)V
+    invoke-static {v0, v1, v2}, Lcom/android/server/locksettings/LockSettingsService;->$r8$lambda$hxFRMJ-qy23Ksj0E5uph7lZu_Ww(Lcom/android/server/locksettings/LockSettingsService;J)V
 
     return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$DarVirtualLock.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$DarVirtualLock.smali
index aaeb536ee..d24f95fae 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$DarVirtualLock.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$DarVirtualLock.smali
@@ -280,13 +280,13 @@
 .method public doVerifyCredential(Lcom/android/internal/widget/LockscreenCredential;ILcom/android/internal/widget/ICheckCredentialProgressCallback;)Lcom/android/internal/widget/VerifyCredentialResponse;
     .locals 8
 
-    if-eqz p1, :cond_5
+    if-eqz p1, :cond_6
 
     invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
     move-result v0
 
-    if-nez v0, :cond_5
+    if-nez v0, :cond_6
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->OK:Lcom/android/internal/widget/VerifyCredentialResponse;
 
@@ -400,13 +400,54 @@
 
     if-eqz p3, :cond_4
 
+    const-string/jumbo v1, "set Sdp key"
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    iget-object v1, p3, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-virtual {v1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveSdpMasterKey()[B
+
+    move-result-object v1
+
+    invoke-virtual {v0, v1}, Lcom/android/internal/widget/VerifyCredentialResponse;->setSecret([B)V
+
+    invoke-static {p2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v1
+
+    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    filled-new-array {v1, v2}, [Ljava/lang/Object;
+
+    move-result-object v1
+
+    const-string v2, "Result of verification of user %d : %s"
+
+    invoke-static {v2, v1}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    :cond_4
+    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->isMatched()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_5
+
+    if-eqz p3, :cond_5
+
     iget-object v1, p0, Lcom/android/server/locksettings/LockSettingsService$DarVirtualLock;->this$0:Lcom/android/server/locksettings/LockSettingsService;
 
     invoke-static {v1, p2}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misDualDarAuthUserId(Lcom/android/server/locksettings/LockSettingsService;I)Z
 
     move-result v1
 
-    if-eqz v1, :cond_4
+    if-eqz v1, :cond_5
 
     iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$DarVirtualLock;->this$0:Lcom/android/server/locksettings/LockSettingsService;
 
@@ -422,10 +463,10 @@
 
     invoke-virtual {p0, p3, p2, p1}, Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;->activateEscrowTokensForDualDAR(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I[B)V
 
-    :cond_4
+    :cond_5
     return-object v0
 
-    :cond_5
+    :cond_6
     new-instance p0, Ljava/lang/IllegalArgumentException;
 
     const-string p1, "Credential can\'t be null or empty"
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$Lifecycle.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$Lifecycle.smali
index b74aa0b58..330afe53a 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$Lifecycle.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$Lifecycle.smali
@@ -67,10 +67,39 @@
 
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
 
+    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSdpLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->checkSdpStatus()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSdpLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->loadPasswordDataOnBootPhase()V
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
+
     invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$mrefreshWeaverSlots(Lcom/android/server/locksettings/LockSettingsService;)V
 
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
 
+    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSdpLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->shouldMigratePasswordHash()V
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
+
     invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmInjector(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$Injector;
 
     move-result-object v0
@@ -79,7 +108,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_0
+    if-eqz v0, :cond_1
 
     iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$Lifecycle;->mLockSettingsService:Lcom/android/server/locksettings/LockSettingsService;
 
@@ -93,7 +122,7 @@
 
     invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
 
-    :cond_0
+    :cond_1
     return-void
 .end method
 
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1.smali
new file mode 100644
index 000000000..c426ee5bc
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1.smali
@@ -0,0 +1,42 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+.field public final synthetic f$1:I
+
+
+# direct methods
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;->f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    iput p2, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;->f$1:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;->f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;->f$1:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {v0, p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$p-UFp710vSVSPZfLkToh3DVJYUI(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10.smali
new file mode 100644
index 000000000..8214759ce
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$CdLv3sDN_0m4zFiq3b2iP0fSz-Y(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Long;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11.smali
new file mode 100644
index 000000000..0fc2c0afa
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$o8bc1xt_RGvc5pEwmAs5JZsgcds(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2.smali
new file mode 100644
index 000000000..bbdc8944f
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2.smali
@@ -0,0 +1,42 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+.field public final synthetic f$1:I
+
+
+# direct methods
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;->f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    iput p2, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;->f$1:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;->f$0:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;->f$1:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {v0, p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$Y8A6Mg9nVRJjPI7JT0zaYkpFV3s(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3.smali
new file mode 100644
index 000000000..4da054704
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3.smali
@@ -0,0 +1,42 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+.field public final synthetic f$1:I
+
+
+# direct methods
+.method public synthetic constructor <init>(II)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;->f$0:I
+
+    iput p2, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;->f$1:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 1
+
+    iget v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;->f$0:I
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;->f$1:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {v0, p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$ZgNsm4_Madx9xavzgZBxO6VvNIU(IILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4.smali
new file mode 100644
index 000000000..88fc250ff
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4.smali
@@ -0,0 +1,46 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/lang/Runnable;
+
+
+# instance fields
+.field public final synthetic f$0:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+.field public final synthetic f$1:Lcom/android/internal/widget/LockscreenCredential;
+
+.field public final synthetic f$2:I
+
+
+# direct methods
+.method public synthetic constructor <init>(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$0:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    iput-object p2, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$1:Lcom/android/internal/widget/LockscreenCredential;
+
+    iput p3, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$2:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final run()V
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$0:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    iget-object v1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$1:Lcom/android/internal/widget/LockscreenCredential;
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;->f$2:I
+
+    invoke-static {v0, v1, p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$JbIx755Ab07SyakHAmX1Jvjh2NQ(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5.smali
new file mode 100644
index 000000000..e9a6cf7b9
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5.smali
@@ -0,0 +1,42 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:[B
+
+.field public final synthetic f$1:I
+
+
+# direct methods
+.method public synthetic constructor <init>([BI)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;->f$0:[B
+
+    iput p2, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;->f$1:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;->f$0:[B
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;->f$1:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {v0, p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$zrkxYjNb76vJfPC8iVJhZ3xBwmQ([BILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6.smali
new file mode 100644
index 000000000..c900cc271
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$ffiOI9hq7cocG6btzyQT-vU7Xz0(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7.smali
new file mode 100644
index 000000000..949a76b2e
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->$r8$lambda$UNoSAEPY9sKt9GE6mU8mxnpQcCY(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8.smali
new file mode 100644
index 000000000..cf404d5e7
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8.smali
@@ -0,0 +1,34 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# direct methods
+.method public synthetic constructor <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-virtual {p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isInitialized()Z
+
+    move-result p0
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9.smali
new file mode 100644
index 000000000..a28c70bbe
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9.smali
@@ -0,0 +1,30 @@
+.class public final synthetic Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# direct methods
+.method public synthetic constructor <init>()V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    check-cast p1, Lcom/android/server/knox/dar/DarManagerService;
+
+    invoke-virtual {p1}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings.smali
index f02ef12b8..04db6761e 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService$SdpLockSettings.smali
@@ -8,6 +8,74 @@
 
 
 # direct methods
+.method public static synthetic $r8$lambda$CdLv3sDN_0m4zFiq3b2iP0fSz-Y(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Long;
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$setLockCredentialWithLegacyToken$7(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Long;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic $r8$lambda$JbIx755Ab07SyakHAmX1Jvjh2NQ(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 0
+
+    invoke-direct {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$migratePasswordHashForEnterpriseUser$9(Lcom/android/internal/widget/LockscreenCredential;I)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$UNoSAEPY9sKt9GE6mU8mxnpQcCY(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$prepareLegacyResetRequest$5(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$Y8A6Mg9nVRJjPI7JT0zaYkpFV3s(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$prepareMasterKeyIfUnsecured$4(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$ZgNsm4_Madx9xavzgZBxO6VvNIU(IILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$onCredentialChanged$1(IILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$ffiOI9hq7cocG6btzyQT-vU7Xz0(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$finalizeLegacyResetRequest$6(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$o8bc1xt_RGvc5pEwmAs5JZsgcds(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)[B
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$setLockCredentialWithLegacyToken$8(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic $r8$lambda$p-UFp710vSVSPZfLkToh3DVJYUI(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$initializeMasterKeyIfRequired$2(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
 .method public static synthetic $r8$lambda$sdM3kiodHn_zirO_Z5tup2WwXJA(ILcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)V
     .locals 0
 
@@ -16,6 +84,32 @@
     return-void
 .end method
 
+.method public static synthetic $r8$lambda$zrkxYjNb76vJfPC8iVJhZ3xBwmQ([BILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->lambda$unlockSdpOnCredentialVerified$3([BILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$mmigratePasswordHashForEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 0
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->migratePasswordHashForEnterpriseUser(Lcom/android/internal/widget/LockscreenCredential;I)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$msetLockCredentialVariant(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+    .locals 0
+
+    invoke-virtual {p0, p1, p2, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->setLockCredentialVariant(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public constructor <init>(Lcom/android/server/locksettings/LockSettingsService;)V
     .locals 0
 
@@ -26,6 +120,69 @@
     return-void
 .end method
 
+.method public static synthetic lambda$finalizeLegacyResetRequest$6(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onLegacyResetCredentialFinalized(I)V
+
+    return-void
+.end method
+
+.method public static synthetic lambda$initializeMasterKeyIfRequired$2(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveSdpMasterKey()[B
+
+    move-result-object p0
+
+    invoke-virtual {p2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->initializeMasterKeyIfRequired([BI)V
+
+    return-void
+.end method
+
+.method private synthetic lambda$migratePasswordHashForEnterpriseUser$9(Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 0
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->duplicate()Lcom/android/internal/widget/LockscreenCredential;
+
+    move-result-object p1
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$mupdatePasswordHistory(Lcom/android/server/locksettings/LockSettingsService;Lcom/android/internal/widget/LockscreenCredential;I)V
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    if-eqz p1, :cond_0
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->close()V
+
+    :cond_0
+    return-void
+
+    :catchall_0
+    move-exception p0
+
+    if-eqz p1, :cond_1
+
+    :try_start_1
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->close()V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_1
+
+    goto :goto_0
+
+    :catchall_1
+    move-exception p1
+
+    invoke-virtual {p0, p1}, Ljava/lang/Throwable;->addSuppressed(Ljava/lang/Throwable;)V
+
+    :cond_1
+    :goto_0
+    throw p0
+.end method
+
 .method public static synthetic lambda$migrateWithAuthToken$0(ILcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;Lcom/android/server/knox/dar/sdp/SdpManagerInternal;)V
     .locals 2
 
@@ -79,106 +236,1292 @@
     return-void
 .end method
 
+.method public static synthetic lambda$onCredentialChanged$1(IILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
 
-# virtual methods
-.method public getSdpManagerInternal()Ljava/util/Optional;
+    invoke-virtual {p2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onCredentialChanged(II)V
+
+    return-void
+.end method
+
+.method public static synthetic lambda$prepareLegacyResetRequest$5(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
     .locals 0
 
-    const-class p0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onLegacyResetCredentialStarted(I)V
 
-    invoke-static {p0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
+    return-void
+.end method
+
+.method public static synthetic lambda$prepareMasterKeyIfUnsecured$4(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveSdpMasterKey()[B
 
     move-result-object p0
 
-    check-cast p0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+    invoke-virtual {p2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->saveMasterKeyIfUnsecured([BI)V
 
-    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+    return-void
+.end method
+
+.method public static synthetic lambda$setLockCredentialWithLegacyToken$7(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Long;
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getTokenHandle(I)J
+
+    move-result-wide p0
+
+    invoke-static {p0, p1}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
 
     move-result-object p0
 
     return-object p0
 .end method
 
-.method public final isSdpUser(I)Z
-    .locals 1
+.method public static synthetic lambda$setLockCredentialWithLegacyToken$8(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)[B
+    .locals 0
 
-    invoke-static {p1}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->getResetTokenSafe(I)[B
 
-    move-result v0
+    move-result-object p0
 
-    if-nez v0, :cond_1
+    return-object p0
+.end method
 
-    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+.method public static synthetic lambda$unlockSdpOnCredentialVerified$3([BILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
 
-    invoke-static {v0, p1}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService;I)Z
+    invoke-virtual {p2, p0, p1}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->unlockSdpOnCredentialVerified([BI)V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final checkSdpEngineListStatus()Z
+    .locals 7
+
+    new-instance p0, Ljava/io/File;
+
+    const-string v0, "/data/system/users/sdp_engine_list.xml"
+
+    invoke-direct {p0, v0}, Ljava/io/File;-><init>(Ljava/lang/String;)V
+
+    invoke-virtual {p0}, Ljava/io/File;->exists()Z
 
     move-result v0
 
-    if-eqz v0, :cond_0
+    const/4 v1, 0x0
 
-    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+    if-nez v0, :cond_0
 
-    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmDualDarLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;
+    const-string p0, "LockSettingsService"
+
+    const-string v0, "Failed to get engine list due to non-existence..."
+
+    invoke-static {p0, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    return v1
+
+    :cond_0
+    new-instance v0, Landroid/util/AtomicFile;
+
+    invoke-direct {v0, p0}, Landroid/util/AtomicFile;-><init>(Ljava/io/File;)V
+
+    :try_start_0
+    invoke-virtual {v0}, Landroid/util/AtomicFile;->openRead()Ljava/io/FileInputStream;
 
     move-result-object p0
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_1
 
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;->isDualDARUser(I)Z
+    :try_start_1
+    invoke-static {}, Lorg/xmlpull/v1/XmlPullParserFactory;->newInstance()Lorg/xmlpull/v1/XmlPullParserFactory;
 
-    move-result p0
+    move-result-object v0
 
-    if-nez p0, :cond_0
+    invoke-virtual {v0}, Lorg/xmlpull/v1/XmlPullParserFactory;->newPullParser()Lorg/xmlpull/v1/XmlPullParser;
 
-    goto :goto_0
+    move-result-object v0
 
-    :cond_0
-    const/4 p0, 0x0
+    const-string v2, "UTF-8"
 
-    goto :goto_1
+    invoke-interface {v0, p0, v2}, Lorg/xmlpull/v1/XmlPullParser;->setInput(Ljava/io/InputStream;Ljava/lang/String;)V
+
+    invoke-interface {v0}, Lorg/xmlpull/v1/XmlPullParser;->getEventType()I
+
+    move-result v2
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_1
+
+    const/4 v3, 0x1
+
+    move v4, v1
+
+    move v5, v3
 
-    :cond_1
     :goto_0
-    const/4 p0, 0x1
+    if-nez v4, :cond_6
+
+    if-eq v2, v3, :cond_6
+
+    const/4 v6, 0x2
+
+    if-eq v2, v6, :cond_1
+
+    goto :goto_2
+
+    :cond_1
+    :try_start_2
+    invoke-interface {v0}, Lorg/xmlpull/v1/XmlPullParser;->getName()Ljava/lang/String;
+
+    move-result-object v2
+
+    const-string v6, "engine"
+
+    invoke-virtual {v6, v2}, Ljava/lang/String;->equalsIgnoreCase(Ljava/lang/String;)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_5
+
+    const-string v2, "alias"
+
+    invoke-interface {v0, v1}, Lorg/xmlpull/v1/XmlPullParser;->getAttributeName(I)Ljava/lang/String;
+
+    move-result-object v6
+
+    invoke-virtual {v2, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_3
+
+    const-string v2, "id"
+
+    invoke-interface {v0, v3}, Lorg/xmlpull/v1/XmlPullParser;->getAttributeName(I)Ljava/lang/String;
+
+    move-result-object v6
+
+    invoke-virtual {v2, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_3
+
+    invoke-interface {v0, v1}, Lorg/xmlpull/v1/XmlPullParser;->getAttributeValue(I)Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-interface {v0, v3}, Lorg/xmlpull/v1/XmlPullParser;->getAttributeValue(I)Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-static {v5}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
+
+    move-result v5
+
+    if-ltz v5, :cond_2
+
+    invoke-virtual {v2}, Ljava/lang/String;->isEmpty()Z
+
+    move-result v2
+
+    if-nez v2, :cond_2
+
+    move v2, v3
+
+    goto :goto_1
+
+    :cond_2
+    move v2, v1
 
     :goto_1
-    return p0
-.end method
+    move v5, v2
 
-.method public migrateWithAuthToken(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
-    .locals 1
+    :cond_3
+    if-eqz v5, :cond_4
 
-    if-nez p1, :cond_0
+    move v4, v3
 
-    return-void
+    goto :goto_2
 
-    :cond_0
-    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+    :cond_4
+    new-instance v0, Ljava/lang/Exception;
 
-    move-result v0
+    const-string v1, "Suspicious of damaged file..."
 
-    if-eqz v0, :cond_1
+    invoke-direct {v0, v1}, Ljava/lang/Exception;-><init>(Ljava/lang/String;)V
 
-    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+    throw v0
 
-    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSpManager(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/SyntheticPasswordManager;
+    :cond_5
+    :goto_2
+    invoke-interface {v0}, Lorg/xmlpull/v1/XmlPullParser;->next()I
 
-    move-result-object v0
+    move-result v2
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+    goto :goto_0
 
-    move-result v0
+    :catchall_0
+    move-exception v0
 
-    if-eqz v0, :cond_1
+    move v1, v4
 
-    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManagerInternal()Ljava/util/Optional;
+    goto :goto_3
 
-    move-result-object p0
+    :cond_6
+    if-eqz p0, :cond_8
 
-    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda0;
+    :try_start_3
+    invoke-virtual {p0}, Ljava/io/FileInputStream;->close()V
+    :try_end_3
+    .catch Ljava/lang/Exception; {:try_start_3 .. :try_end_3} :catch_0
 
-    invoke-direct {v0, p2, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda0;-><init>(ILcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;)V
+    goto :goto_6
 
-    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+    :catch_0
+    move-exception p0
 
-    :cond_1
+    move v1, v4
+
+    goto :goto_5
+
+    :catchall_1
+    move-exception v0
+
+    :goto_3
+    if-eqz p0, :cond_7
+
+    :try_start_4
+    invoke-virtual {p0}, Ljava/io/FileInputStream;->close()V
+    :try_end_4
+    .catchall {:try_start_4 .. :try_end_4} :catchall_2
+
+    goto :goto_4
+
+    :catchall_2
+    move-exception p0
+
+    :try_start_5
+    invoke-virtual {v0, p0}, Ljava/lang/Throwable;->addSuppressed(Ljava/lang/Throwable;)V
+
+    :cond_7
+    :goto_4
+    throw v0
+    :try_end_5
+    .catch Ljava/lang/Exception; {:try_start_5 .. :try_end_5} :catch_1
+
+    :catch_1
+    move-exception p0
+
+    :goto_5
+    const-string v0, "LockSettingsService.SDP"
+
+    const-string/jumbo v2, "read sdp engine failed."
+
+    invoke-static {v0, v2, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+
+    move v4, v1
+
+    :cond_8
+    :goto_6
+    return v4
+.end method
+
+.method public checkSdpStatus()Z
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    const/4 v1, 0x0
+
+    invoke-static {v0, v1}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misDeviceOwner(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/DarUtil;->updateDeviceOwnerStatus(Z)V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->checkSdpEngineListStatus()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8;
+
+    invoke-direct {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8;-><init>()V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    sget-object v0, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Ljava/lang/Boolean;
+
+    invoke-virtual {p0}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result v1
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v0, "SdpEngineList Exists, Sdp service now ready [ res : "
+
+    invoke-virtual {p0, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+
+    const-string v0, " ]"
+
+    invoke-virtual {p0, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    goto :goto_0
+
+    :cond_0
+    const-string p0, "SdpEngineList is Empty."
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    :goto_0
+    return v1
+.end method
+
+.method public final finalizeLegacyResetRequest(I)V
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6;
+
+    invoke-direct {v0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda6;-><init>(I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    return-void
+.end method
+
+.method public getSdpManager()Ljava/util/Optional;
+    .locals 1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$mgetDarManagerService(Lcom/android/server/locksettings/LockSettingsService;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9;
+
+    invoke-direct {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda9;-><init>()V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    const/4 v0, 0x0
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public getSdpManagerInternal()Ljava/util/Optional;
+    .locals 0
+
+    const-class p0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    invoke-static {p0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public initializeMasterKeyIfRequired(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    .locals 1
+
+    if-nez p1, :cond_0
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p1, " Initialize master key - Unexpected condition with user "
+
+    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "LockSettingsService.SDP"
+
+    invoke-static {p1, p0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    return-void
+
+    :cond_0
+    invoke-static {p2}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;
+
+    invoke-direct {v0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda1;-><init>(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    :cond_1
+    return-void
+.end method
+
+.method public final isLegacyResetRequested(I)Z
+    .locals 2
+
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    move-result-wide v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService;->mUserManager:Landroid/os/UserManager;
+
+    invoke-virtual {p0, p1}, Landroid/os/UserManager;->getUserInfo(I)Landroid/content/pm/UserInfo;
+
+    move-result-object p0
+
+    if-eqz p0, :cond_0
+
+    invoke-virtual {p0}, Landroid/content/pm/UserInfo;->isLegacyResetCredentialRequested()Z
+
+    move-result p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    if-eqz p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    return p0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    throw p0
+.end method
+
+.method public final isSdpUser(I)Z
+    .locals 1
+
+    invoke-static {p1}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmDualDarLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;->isDualDARUser(I)Z
+
+    move-result p0
+
+    if-nez p0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 p0, 0x1
+
+    :goto_1
+    return p0
+.end method
+
+.method public loadPasswordDataOnBootPhase()V
+    .locals 8
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    iget-object v0, v0, Lcom/android/server/locksettings/LockSettingsService;->mUserManager:Landroid/os/UserManager;
+
+    invoke-virtual {v0}, Landroid/os/UserManager;->getUsers()Ljava/util/List;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    :goto_0
+    invoke-interface {v0}, Ljava/util/List;->size()I
+
+    move-result v2
+
+    if-ge v1, v2, :cond_2
+
+    invoke-interface {v0, v1}, Ljava/util/List;->get(I)Ljava/lang/Object;
+
+    move-result-object v2
+
+    check-cast v2, Landroid/content/pm/UserInfo;
+
+    iget v2, v2, Landroid/content/pm/UserInfo;->id:I
+
+    iget-object v3, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v3, v2}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v3
+
+    if-eqz v3, :cond_1
+
+    iget-object v3, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v3}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSpManager(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    move-result-object v3
+
+    monitor-enter v3
+
+    :try_start_0
+    iget-object v4, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v4, v2}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misSyntheticPasswordBasedCredentialLocked(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_0
+
+    iget-object v4, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-virtual {v4, v2}, Lcom/android/server/locksettings/LockSettingsService;->getCurrentLskfBasedProtectorId(I)J
+
+    move-result-wide v4
+
+    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v6}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSpManager(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    move-result-object v6
+
+    invoke-virtual {v6, v4, v5, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getCredentialType(JI)I
+
+    move-result v4
+
+    const-string v5, "LockSettingsService.SDP"
+
+    new-instance v6, Ljava/lang/StringBuilder;
+
+    invoke-direct {v6}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v7, "Cached credential type("
+
+    invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v6, v4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string v4, ") for enterprise user "
+
+    invoke-virtual {v6, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v6, v2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v6}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v5, v2}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_0
+    monitor-exit v3
+
+    goto :goto_1
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v3
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+
+    :cond_1
+    :goto_1
+    add-int/lit8 v1, v1, 0x1
+
+    goto :goto_0
+
+    :cond_2
+    return-void
+.end method
+
+.method public final migratePasswordHashForEnterpriseUser(Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 3
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v0, p2}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    const-string/jumbo v0, "ro.product.first_api_level"
+
+    const/4 v1, 0x0
+
+    invoke-static {v0, v1}, Landroid/os/SystemProperties;->getInt(Ljava/lang/String;I)I
+
+    move-result v0
+
+    const/16 v2, 0x1d
+
+    if-ge v0, v2, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    const-string/jumbo v2, "migrated_password_hash"
+
+    invoke-virtual {v0, v2, v1, p2}, Lcom/android/server/locksettings/LockSettingsService;->getBoolean(Ljava/lang/String;ZI)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "Migrate password hash for enterprise user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    const-string v1, "LockSettingsService.SDP"
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    const/4 v1, 0x1
+
+    invoke-virtual {v0, v2, v1, p2}, Lcom/android/server/locksettings/LockSettingsService;->setBoolean(Ljava/lang/String;ZI)V
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    iget-object v0, v0, Lcom/android/server/locksettings/LockSettingsService;->mHandler:Landroid/os/Handler;
+
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;
+
+    invoke-direct {v1, p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda4;-><init>(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+
+    invoke-virtual {v0, v1}, Landroid/os/Handler;->post(Ljava/lang/Runnable;)Z
+
+    :cond_0
+    return-void
+.end method
+
+.method public migrateWithAuthToken(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    .locals 1
+
+    if-nez p1, :cond_0
+
+    return-void
+
+    :cond_0
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmSpManager(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManagerInternal()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda0;
+
+    invoke-direct {v0, p2, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda0;-><init>(ILcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    :cond_1
+    return-void
+.end method
+
+.method public onCredentialChanged(II)V
+    .locals 1
+
+    invoke-static {p2}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;
+
+    invoke-direct {v0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda3;-><init>(II)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    :cond_0
+    return-void
+.end method
+
+.method public final prepareLegacyResetRequest(I)V
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7;
+
+    invoke-direct {v0, p1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda7;-><init>(I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    return-void
+.end method
+
+.method public prepareMasterKeyIfUnsecured(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    .locals 1
+
+    if-nez p1, :cond_0
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p1, "SP deserted - Unexpected condition while desert sp with user "
+
+    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "LockSettingsService.SDP"
+
+    invoke-static {p1, p0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    return-void
+
+    :cond_0
+    invoke-static {p2}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;
+
+    invoke-direct {v0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda2;-><init>(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    :cond_1
+    return-void
+.end method
+
+.method public final setLockCredentialVariant(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+    .locals 2
+
+    sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->SKIP:Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isLegacyResetRequested(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_1
+
+    invoke-static {p3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p2
+
+    filled-new-array {p2}, [Ljava/lang/Object;
+
+    move-result-object p2
+
+    const-string v1, "User %d requested to reset password"
+
+    invoke-static {v1, p2}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p2
+
+    invoke-static {p2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->prepareLegacyResetRequest(I)V
+
+    invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->setLockCredentialWithLegacyToken(Lcom/android/internal/widget/LockscreenCredential;I)Z
+
+    move-result p2
+
+    invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->finalizeLegacyResetRequest(I)V
+
+    if-eqz p2, :cond_0
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
+
+    move-result p1
+
+    invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->onCredentialChanged(II)V
+
+    sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->OK:Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    goto :goto_0
+
+    :cond_0
+    const-string p0, "Continue to set credential..."
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto :goto_0
+
+    :cond_1
+    invoke-static {p3}, Lcom/samsung/android/knox/SemPersonaManager;->isSecureFolderId(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_2
+
+    invoke-static {p3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v0
+
+    filled-new-array {v0}, [Ljava/lang/Object;
+
+    move-result-object v0
+
+    const-string v1, "User %d identified as secure folder user"
+
+    invoke-static {v1, v0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$fgetmDarLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;
+
+    move-result-object v0
+
+    invoke-virtual {v0, p1, p2, p3}, Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;->setSecureFolderLockCredential(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    move-result-object v0
+
+    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
+
+    move-result p2
+
+    if-nez p2, :cond_2
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
+
+    move-result p1
+
+    invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->onCredentialChanged(II)V
+
+    :cond_2
+    :goto_0
+    return-object v0
+.end method
+
+.method public final setLockCredentialWithLegacyToken(Lcom/android/internal/widget/LockscreenCredential;I)Z
+    .locals 9
+
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "Set lock credential with legacy token for user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v0
+
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10;
+
+    invoke-direct {v1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda10;-><init>(I)V
+
+    invoke-virtual {v0, v1}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object v0
+
+    const-wide/16 v1, 0x0
+
+    invoke-static {v1, v2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+
+    move-result-object v3
+
+    invoke-virtual {v0, v3}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Ljava/lang/Long;
+
+    invoke-virtual {v0}, Ljava/lang/Long;->longValue()J
+
+    move-result-wide v5
+
+    cmp-long v0, v5, v1
+
+    if-nez v0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v0
+
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11;
+
+    invoke-direct {v1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda11;-><init>(I)V
+
+    invoke-virtual {v0, v1}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    invoke-virtual {v0, v1}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    move-object v7, v0
+
+    check-cast v7, [B
+
+    invoke-static {v7}, Lcom/android/server/knox/dar/SecureUtil;->isEmpty(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    const-string p0, "Failed due to invalid token"
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto :goto_0
+
+    :cond_1
+    :try_start_0
+    iget-object v3, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    move-object v4, p1
+
+    move v8, p2
+
+    invoke-static/range {v3 .. v8}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$msetLockCredentialWithToken(Lcom/android/server/locksettings/LockSettingsService;Lcom/android/internal/widget/LockscreenCredential;J[BI)Z
+
+    move-result p0
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+
+    goto :goto_1
+
+    :catch_0
+    move-exception p0
+
+    const-string p1, "Unexpected failure while set credential with token"
+
+    invoke-static {p1, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->e(Ljava/lang/String;Ljava/lang/Exception;)V
+
+    :goto_0
+    const/4 p0, 0x0
+
+    :goto_1
+    invoke-static {p2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p1
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p2
+
+    filled-new-array {p1, p2}, [Ljava/lang/Object;
+
+    move-result-object p1
+
+    const-string p2, "Result of string credential with legacy token for user %d : %s"
+
+    invoke-static {p2, p1}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p1
+
+    invoke-static {p1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    return p0
+.end method
+
+.method public shouldMigratePasswordHash()V
+    .locals 6
+
+    const-string/jumbo v0, "ro.product.first_api_level"
+
+    const/4 v1, 0x0
+
+    invoke-static {v0, v1}, Landroid/os/SystemProperties;->getInt(Ljava/lang/String;I)I
+
+    move-result v0
+
+    const/16 v2, 0x1d
+
+    if-ge v0, v2, :cond_1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    iget-object v0, v0, Lcom/android/server/locksettings/LockSettingsService;->mUserManager:Landroid/os/UserManager;
+
+    invoke-virtual {v0}, Landroid/os/UserManager;->getUsers()Ljava/util/List;
+
+    move-result-object v0
+
+    move v2, v1
+
+    :goto_0
+    invoke-interface {v0}, Ljava/util/List;->size()I
+
+    move-result v3
+
+    if-ge v2, v3, :cond_1
+
+    invoke-interface {v0, v2}, Ljava/util/List;->get(I)Ljava/lang/Object;
+
+    move-result-object v3
+
+    check-cast v3, Landroid/content/pm/UserInfo;
+
+    iget v3, v3, Landroid/content/pm/UserInfo;->id:I
+
+    iget-object v4, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-static {v4, v3}, Lcom/android/server/locksettings/LockSettingsService;->-$$Nest$misEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService;I)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_0
+
+    iget-object v4, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    const-string/jumbo v5, "migrated_password_hash"
+
+    invoke-virtual {v4, v5, v1, v3}, Lcom/android/server/locksettings/LockSettingsService;->getBoolean(Ljava/lang/String;ZI)Z
+
+    move-result v4
+
+    if-nez v4, :cond_0
+
+    iget-object v4, p0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->service:Lcom/android/server/locksettings/LockSettingsService;
+
+    invoke-virtual {v4, v5, v1, v3}, Lcom/android/server/locksettings/LockSettingsService;->setBoolean(Ljava/lang/String;ZI)V
+
+    new-instance v4, Ljava/lang/StringBuilder;
+
+    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v5, "Need password hash migration for enterprise user "
+
+    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v4, v3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v3
+
+    const-string v4, "LockSettingsService.SDP"
+
+    invoke-static {v4, v3}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_0
+    add-int/lit8 v2, v2, 0x1
+
+    goto :goto_0
+
+    :cond_1
+    return-void
+.end method
+
+.method public unlockSdpOnCredentialVerified([BI)V
+    .locals 1
+
+    invoke-static {p2}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    const-string/jumbo v0, "unlockSdpOnCredentialVerified."
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    if-eqz p1, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;
+
+    invoke-direct {v0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda5;-><init>([BI)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    goto :goto_0
+
+    :cond_0
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p1, "Unlock SDP on credential verified - Unexpected condition with user "
+
+    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "LockSettingsService.SDP"
+
+    invoke-static {p1, p0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_1
+    :goto_0
     return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/LockSettingsService.smali b/smali_classes2/com/android/server/locksettings/LockSettingsService.smali
index 1eeb58715..fb39e8791 100644
--- a/smali_classes2/com/android/server/locksettings/LockSettingsService.smali
+++ b/smali_classes2/com/android/server/locksettings/LockSettingsService.smali
@@ -124,6 +124,14 @@
     return-object p0
 .end method
 
+.method public static synthetic $r8$lambda$7JQII9w8jf_99bqGTu9cpfv6pH4(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->lambda$unlockSdpOrSecureFolder$12(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
 .method public static synthetic $r8$lambda$8J6KUr7Op7Q4laSYt_FWDwOYHlY(ILcom/android/server/pm/PersonaManagerService;)Ljava/lang/Boolean;
     .locals 0
 
@@ -356,6 +364,14 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$fgetmSdpLockSettings(Lcom/android/server/locksettings/LockSettingsService;)Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+    .locals 0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    return-object p0
+.end method
+
 .method public static bridge synthetic -$$Nest$fgetmShouldUnbind(Lcom/android/server/locksettings/LockSettingsService;)Z
     .locals 0
 
@@ -482,6 +498,16 @@
     return-void
 .end method
 
+.method public static bridge synthetic -$$Nest$misDeviceOwner(Lcom/android/server/locksettings/LockSettingsService;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isDeviceOwner(I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
 .method public static bridge synthetic -$$Nest$misDualDarAuthUserId(Lcom/android/server/locksettings/LockSettingsService;I)Z
     .locals 0
 
@@ -770,6 +796,14 @@
     return-void
 .end method
 
+.method public static bridge synthetic -$$Nest$mupdatePasswordHistory(Lcom/android/server/locksettings/LockSettingsService;Lcom/android/internal/widget/LockscreenCredential;I)V
+    .locals 0
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService;->updatePasswordHistory(Lcom/android/internal/widget/LockscreenCredential;I)V
+
+    return-void
+.end method
+
 .method public static constructor <clinit>()V
     .locals 3
 
@@ -1499,6 +1533,16 @@
     throw p0
 .end method
 
+.method public static synthetic lambda$unlockSdpOrSecureFolder$12(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 1
+
+    const/4 v0, 0x4
+
+    invoke-virtual {p1, p0, v0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->unlockSdpIfUnsecuredOrBiometricAuthenticated(II)V
+
+    return-void
+.end method
+
 .method private synthetic lambda$updateVerifier$15(Landroid/content/Intent;[B)V
     .locals 2
 
@@ -1954,6 +1998,14 @@
 
     iget-object v1, v1, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
+    const-string v2, "addEscrowToken: initializeMasterKeyIfRequired"
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    iget-object v2, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual {v2, v1, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->initializeMasterKeyIfRequired(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
     const-string v2, "addEscrowToken: saveEscrowDataIfNeededLocked"
 
     invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
@@ -4605,31 +4657,59 @@
 
     if-eqz p4, :cond_7
 
-    iget-object p3, p3, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    iget-object p4, p3, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    invoke-virtual {p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveGkPassword()[B
+    invoke-virtual {p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveGkPassword()[B
 
-    move-result-object p3
+    move-result-object p4
 
-    invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->storeGatekeeperPasswordTemporarily([B)J
+    invoke-virtual {p0, p4}, Lcom/android/server/locksettings/LockSettingsService;->storeGatekeeperPasswordTemporarily([B)J
 
-    move-result-wide p3
+    move-result-wide v4
 
-    new-instance v0, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;
+    new-instance p4, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;
 
-    invoke-direct {v0}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;-><init>()V
+    invoke-direct {p4}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;-><init>()V
 
-    invoke-virtual {v0, p3, p4}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;->setGatekeeperPasswordHandle(J)Lcom/android/internal/widget/VerifyCredentialResponse$Builder;
+    invoke-virtual {p4, v4, v5}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;->setGatekeeperPasswordHandle(J)Lcom/android/internal/widget/VerifyCredentialResponse$Builder;
 
-    move-result-object p3
+    move-result-object p4
+
+    invoke-virtual {p4}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;->build()Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    move-result-object v0
+
+    :cond_7
+    const-string p4, "Result of verification of user %d : %s"
+
+    invoke-static {p2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v2
+
+    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->toString()Ljava/lang/String;
+
+    move-result-object v4
+
+    filled-new-array {v2, v4}, [Ljava/lang/Object;
+
+    move-result-object v2
+
+    invoke-static {p4, v2}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p4
+
+    invoke-static {p4}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    iget-object p4, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    iget-object p3, p3, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    invoke-virtual {p3}, Lcom/android/internal/widget/VerifyCredentialResponse$Builder;->build()Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-virtual {p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveSdpMasterKey()[B
 
     move-result-object p3
 
-    move-object v0, p3
+    invoke-virtual {p4, p3, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->unlockSdpOnCredentialVerified([BI)V
 
-    :cond_7
     invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService;->sendCredentialsOnUnlockIfRequired(Lcom/android/internal/widget/LockscreenCredential;I)V
 
     invoke-static {p2}, Lcom/samsung/android/knox/dar/ddar/DualDarManager;->isOnDeviceOwner(I)Z
@@ -4647,6 +4727,10 @@
     invoke-virtual {p3, p2}, Lcom/samsung/android/knox/dar/ddar/DualDarManager;->cancelDataLock(I)V
 
     :cond_8
+    iget-object p3, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-static {p3, p1, p2}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->-$$Nest$mmigratePasswordHashForEnterpriseUser(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;I)V
+
     iget-object p3, p0, Lcom/android/server/locksettings/LockSettingsService;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
     const-string/jumbo p4, "last-failed-count"
@@ -5265,18 +5349,45 @@
 
     invoke-static {v1}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
 
-    move-result-object v1
+    move-result-object v3
 
-    filled-new-array {v1}, [Ljava/lang/Object;
+    filled-new-array {v3}, [Ljava/lang/Object;
 
-    move-result-object v1
+    move-result-object v3
 
-    invoke-static {v2, v1}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+    invoke-static {v2, v3}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
 
-    move-result-object v1
+    move-result-object v2
+
+    invoke-virtual {v0, v2}, Lcom/android/internal/util/IndentingPrintWriter;->println(Ljava/lang/String;)V
+
+    if-eqz v1, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService;->isNeedToEnableSdpMdfppModeForSystem()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const-string v1, "SdpMdfppMode for System Applied: NeedToEnableSdpMdfppMode"
+
+    invoke-virtual {v0, v1}, Lcom/android/internal/util/IndentingPrintWriter;->println(Ljava/lang/String;)V
+
+    goto :goto_0
+
+    :cond_0
+    invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService;->isSdpMdfppModeEnabledForSystem()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_1
+
+    const-string v1, "SdpMdfppMode for System Applied: SdpMdfppModeEnabledForSystem"
 
     invoke-virtual {v0, v1}, Lcom/android/internal/util/IndentingPrintWriter;->println(Ljava/lang/String;)V
 
+    :cond_1
+    :goto_0
     invoke-virtual {v0}, Lcom/android/internal/util/IndentingPrintWriter;->println()V
 
     const-string v1, "User State:"
@@ -5293,12 +5404,12 @@
 
     move v2, p1
 
-    :goto_0
+    :goto_1
     invoke-interface {v1}, Ljava/util/List;->size()I
 
     move-result v3
 
-    if-ge v2, v3, :cond_1
+    if-ge v2, v3, :cond_3
 
     invoke-interface {v1, v2}, Ljava/util/List;->get(I)Ljava/lang/Object;
 
@@ -5565,16 +5676,16 @@
 
     move-result-object v6
 
-    if-eqz v6, :cond_0
+    if-eqz v6, :cond_2
 
     const-string v6, "known"
 
-    goto :goto_1
+    goto :goto_2
 
-    :cond_0
+    :cond_2
     const-string/jumbo v6, "unknown"
 
-    :goto_1
+    :goto_2
     aput-object v6, v5, p1
 
     invoke-static {v4, v5}, Landroid/text/TextUtils;->formatSimple(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
@@ -5627,7 +5738,7 @@
 
     add-int/lit8 v2, v2, 0x1
 
-    goto/16 :goto_0
+    goto/16 :goto_1
 
     :catchall_0
     move-exception p0
@@ -5639,7 +5750,7 @@
 
     throw p0
 
-    :cond_1
+    :cond_3
     invoke-virtual {v0}, Lcom/android/internal/util/IndentingPrintWriter;->println()V
 
     invoke-virtual {v0}, Lcom/android/internal/util/IndentingPrintWriter;->decreaseIndent()Lcom/android/internal/util/IndentingPrintWriter;
@@ -6307,11 +6418,91 @@
     return p0
 
     :cond_1
+    invoke-static {p1}, Lcom/samsung/android/knox/SemPersonaManager;->isDoEnabled(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_4
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isEnterpriseUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_4
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->getKeyguardStoredQuality(I)I
+
+    move-result v0
+
+    invoke-static {v0}, Lcom/android/internal/widget/LockPatternUtils;->isQualitySmartCard(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    const/4 p0, 0x6
+
+    return p0
+
+    :cond_2
+    :try_start_0
+    invoke-static {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->getCredentialType(I)I
+
+    move-result p0
+    :try_end_0
+    .catch Lcom/android/server/locksettings/SyntheticPasswordMdfpp$EmptySlotException; {:try_start_0 .. :try_end_0} :catch_0
+
+    return p0
+
+    :catch_0
+    move-exception v0
+
+    iget-object v1, p0, Lcom/android/server/locksettings/LockSettingsService;->mSpManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-virtual {v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v1
+
+    if-nez v1, :cond_4
+
+    sget-boolean v1, Lcom/android/server/locksettings/LockSettingsService;->DEBUG_DUMP:Z
+
+    if-eqz v1, :cond_3
+
+    invoke-virtual {v0}, Ljava/lang/SecurityException;->printStackTrace()V
+
+    goto :goto_0
+
+    :cond_3
+    const-string v1, "LockSettingsService.SDP"
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v3, ""
+
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/SecurityException;->getMessage()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_4
+    :goto_0
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mSpManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
     monitor-enter v0
 
-    :try_start_0
+    :try_start_1
     invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->getCurrentLskfBasedProtectorId(I)J
 
     move-result-wide v1
@@ -6320,7 +6511,7 @@
 
     cmp-long v3, v1, v3
 
-    if-nez v3, :cond_2
+    if-nez v3, :cond_5
 
     monitor-exit v0
 
@@ -6328,7 +6519,7 @@
 
     return p0
 
-    :cond_2
+    :cond_5
     iget-object v3, p0, Lcom/android/server/locksettings/LockSettingsService;->mSpManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
     invoke-virtual {v3, v1, v2, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getCredentialType(JI)I
@@ -6337,13 +6528,13 @@
 
     const/4 v2, 0x2
 
-    if-eq v1, v2, :cond_3
+    if-eq v1, v2, :cond_6
 
     monitor-exit v0
 
     return v1
 
-    :cond_3
+    :cond_6
     invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->getKeyguardStoredQuality(I)I
 
     move-result p0
@@ -6360,8 +6551,8 @@
     move-exception p0
 
     monitor-exit v0
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     throw p0
 .end method
@@ -7069,9 +7260,9 @@
 
     move-result-object v0
 
-    new-instance v2, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;
+    new-instance v2, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;
 
-    invoke-direct {v2, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;-><init>(I)V
+    invoke-direct {v2, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;-><init>(I)V
 
     invoke-virtual {v0, v2}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
@@ -7101,9 +7292,9 @@
 
     move-result-object p1
 
-    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;
 
-    invoke-direct {v0, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
+    invoke-direct {v0, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda15;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
 
     const-string p0, "Core.PROFILE_ENCRYPTED_DETAIL"
 
@@ -7243,9 +7434,9 @@
 
     move-result-object v0
 
-    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;
 
-    invoke-direct {v1, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;-><init>(I)V
+    invoke-direct {v1, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;-><init>(I)V
 
     invoke-virtual {v0, v1}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
 
@@ -7303,9 +7494,9 @@
 
     move-result-object p1
 
-    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12;
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;
 
-    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
+    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda11;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
 
     invoke-virtual {p1, v0, v1}, Landroid/app/admin/DevicePolicyResourcesManager;->getString(Ljava/lang/String;Ljava/util/function/Supplier;)Ljava/lang/String;
 
@@ -7324,9 +7515,9 @@
 
     move-result-object p1
 
-    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13;
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12;
 
-    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
+    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda12;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
 
     invoke-virtual {p1, v0, v1}, Landroid/app/admin/DevicePolicyResourcesManager;->getString(Ljava/lang/String;Ljava/util/function/Supplier;)Ljava/lang/String;
 
@@ -7345,9 +7536,9 @@
 
     move-result-object p1
 
-    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13;
 
-    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda14;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
+    invoke-direct {v1, p0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda13;-><init>(Lcom/android/server/locksettings/LockSettingsService;)V
 
     invoke-virtual {p1, v0, v1}, Landroid/app/admin/DevicePolicyResourcesManager;->getString(Ljava/lang/String;Ljava/util/function/Supplier;)Ljava/lang/String;
 
@@ -8545,9 +8736,7 @@
 .method public final isSEPLiteSecureFolder(I)Z
     .locals 0
 
-    invoke-static {p1}, Lcom/samsung/android/knox/SemPersonaManager;->isSecureFolderId(I)Z
-
-    move-result p0
+    const/4 p0, 0x0
 
     return p0
 .end method
@@ -9927,15 +10116,27 @@
     invoke-virtual {v0, p1}, Landroid/util/SparseArray;->remove(I)V
 
     monitor-exit p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isEnterpriseUser(I)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    invoke-static {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->removeUser(I)V
 
+    :cond_0
     return-void
 
     :catchall_0
     move-exception p1
 
+    :try_start_1
     monitor-exit p0
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     throw p1
 .end method
@@ -9990,6 +10191,10 @@
 
     invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->unlockUser(I)V
 
+    iget-object p2, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual {p2, p1, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->migrateWithAuthToken(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
     iget-object p2, p0, Lcom/android/server/locksettings/LockSettingsService;->mDualDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;
 
     invoke-virtual {p2, p3}, Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;->isDualDARUser(I)Z
@@ -10073,19 +10278,36 @@
 .method public final onPostPasswordChanged(Lcom/android/internal/widget/LockscreenCredential;I)V
     .locals 2
 
-    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->isPattern()Z
+    invoke-static {p2}, Lcom/samsung/android/knox/dar/VirtualLockUtils;->isVirtualUserId(I)Z
 
     move-result v0
 
     if-eqz v0, :cond_0
 
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mDualDarAuthUtils:Lcom/samsung/android/knox/dar/ddar/DualDarAuthUtils;
+
+    invoke-virtual {v0, p2}, Lcom/samsung/android/knox/dar/ddar/DualDarAuthUtils;->isInnerAuthUserForDo(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    return-void
+
+    :cond_0
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->isPattern()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
     const-string/jumbo v0, "lockscreen.patterneverchosen"
 
     const/4 v1, 0x1
 
     invoke-virtual {p0, v0, v1, p2}, Lcom/android/server/locksettings/LockSettingsService;->setBoolean(Ljava/lang/String;ZI)V
 
-    :cond_0
+    :cond_1
     invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/LockSettingsService;->updatePasswordHistory(Lcom/android/internal/widget/LockscreenCredential;I)V
 
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mContext:Landroid/content/Context;
@@ -12393,9 +12615,9 @@
 
     move-result-object p0
 
-    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;
 
-    invoke-direct {v0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;-><init>()V
+    invoke-direct {v0}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda16;-><init>()V
 
     const-wide/16 v1, 0x7d0
 
@@ -13477,9 +13699,32 @@
     invoke-virtual {v8, v9, v13, v14}, Lcom/android/server/locksettings/LockSettingsService;->setLockCredentialWithSpLocked(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)J
 
     :goto_5
-    invoke-virtual {v8, v9, v14, v10}, Lcom/android/server/locksettings/LockSettingsService;->sendCredentialsOnChangeIfRequired(Lcom/android/internal/widget/LockscreenCredential;IZ)V
+    invoke-virtual/range {p1 .. p1}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
-    iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;
+    move-result v1
+
+    if-eqz v1, :cond_b
+
+    iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual {v1, v13, v14}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->prepareMasterKeyIfUnsecured(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    :cond_b
+    invoke-virtual {v8, v9, v14, v10}, Lcom/android/server/locksettings/LockSettingsService;->sendCredentialsOnChangeIfRequired(Lcom/android/internal/widget/LockscreenCredential;IZ)V
+
+    iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual {v1, v13, v14}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->initializeMasterKeyIfRequired(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual/range {p1 .. p1}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
+
+    move-result v2
+
+    invoke-virtual {v1, v2, v14}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->onCredentialChanged(II)V
+
+    iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;
 
     invoke-virtual {v1, v13, v14}, Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;->saveEscrowDataIfNeededLocked(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
 
@@ -13491,7 +13736,7 @@
     :try_end_3
     .catchall {:try_start_3 .. :try_end_3} :catchall_1
 
-    if-eqz v1, :cond_b
+    if-eqz v1, :cond_c
 
     :try_start_4
     iget-object v1, v8, Lcom/android/server/locksettings/LockSettingsService;->mDualDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;
@@ -13509,7 +13754,7 @@
     :try_start_5
     invoke-virtual {v0}, Landroid/os/RemoteException;->printStackTrace()V
 
-    :cond_b
+    :cond_c
     :goto_6
     monitor-exit v12
 
@@ -13718,30 +13963,22 @@
 
     move-result v7
 
-    if-nez v7, :cond_8
-
-    if-eqz v6, :cond_9
-
-    :cond_8
-    const-string v6, "SEP-Lite User %d identified as SecureFolder user"
-
-    new-array v7, v1, [Ljava/lang/Object;
-
-    invoke-static {p3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    if-nez v7, :cond_9
 
-    move-result-object v8
+    if-eqz v6, :cond_8
 
-    aput-object v8, v7, v2
+    goto :goto_4
 
-    invoke-static {v6, v7}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+    :cond_8
+    invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->isEnterpriseUser(I)Z
 
-    move-result-object v6
+    move-result v6
 
-    invoke-static {v6}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+    if-eqz v6, :cond_a
 
-    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService;->mDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;
+    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
 
-    invoke-virtual {v6, p1, p2, p3}, Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;->setSecureFolderLockCredential(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-static {v6, p1, p2, p3}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->-$$Nest$msetLockCredentialVariant(Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
 
     move-result-object v6
 
@@ -13749,11 +13986,15 @@
 
     move-result v6
 
-    if-eq v6, v1, :cond_9
+    if-eq v6, v1, :cond_a
 
-    const-string/jumbo p1, "sdp not supported : setSecureFolderLockCredential success"
+    const-string/jumbo p4, "sdp supported : setLockCredentialVariant success"
 
-    invoke-static {p1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+    invoke-static {p4}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->zeroize()V
+
+    invoke-virtual {p2}, Lcom/android/internal/widget/LockscreenCredential;->zeroize()V
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_1
 
@@ -13807,33 +14048,96 @@
     return v1
 
     :cond_9
+    :goto_4
     :try_start_1
-    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService;->mSeparateChallengeLock:Ljava/lang/Object;
+    const-string v6, "SEP-Lite User %d identified as SecureFolder user"
 
-    monitor-enter v6
+    new-array v7, v1, [Ljava/lang/Object;
+
+    invoke-static {p3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v8
+
+    aput-object v8, v7, v2
+
+    invoke-static {v6, v7}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object v6
+
+    invoke-static {v6}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService;->mDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;
+
+    invoke-virtual {v6, p1, p2, p3}, Lcom/android/server/locksettings/LockSettingsService$DarLockSettings;->setSecureFolderLockCredential(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;I)Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    move-result-object v6
+
+    invoke-virtual {v6}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
+
+    move-result v6
+
+    if-eq v6, v1, :cond_a
+
+    const-string/jumbo p1, "sdp not supported : setSecureFolderLockCredential success"
+
+    invoke-static {p1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_1
 
-    if-eqz v3, :cond_a
+    invoke-static {v4, v5}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    new-instance p1, Ljava/lang/StringBuilder;
 
-    goto :goto_4
+    invoke-direct {p1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p2, "User "
+
+    invoke-virtual {p1, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string p2, " enrolled!\n"
+
+    invoke-virtual {p1, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p1
+
+    new-instance p2, Ljava/lang/StringBuilder;
+
+    invoke-direct {p2}, Ljava/lang/StringBuilder;-><init>()V
+
+    goto :goto_3
 
     :cond_a
+    :try_start_2
+    iget-object v6, p0, Lcom/android/server/locksettings/LockSettingsService;->mSeparateChallengeLock:Ljava/lang/Object;
+
+    monitor-enter v6
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_1
+
+    if-eqz v3, :cond_b
+
+    goto :goto_5
+
+    :cond_b
     move v0, p3
 
-    :goto_4
-    :try_start_2
+    :goto_5
+    :try_start_3
     invoke-virtual {p0, p1, p2, v0, v2}, Lcom/android/server/locksettings/LockSettingsService;->setLockCredentialInternal(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/internal/widget/LockscreenCredential;IZ)Z
 
     move-result v0
 
-    if-nez v0, :cond_b
+    if-nez v0, :cond_c
 
     invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService;->scheduleGc()V
 
     monitor-exit v6
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_0
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
     invoke-static {v4, v5}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
@@ -13883,40 +14187,40 @@
 
     return v2
 
-    :cond_b
+    :cond_c
     const/4 v0, 0x0
 
-    :try_start_3
+    :try_start_4
     invoke-virtual {p0, p3, v1, v0}, Lcom/android/server/locksettings/LockSettingsService;->setSeparateProfileChallengeEnabledLocked(IZLcom/android/internal/widget/LockscreenCredential;)V
 
-    if-eqz p4, :cond_c
+    if-eqz p4, :cond_d
 
     invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->isEnterpriseUser(I)Z
 
     move-result p4
 
-    if-eqz p4, :cond_c
+    if-eqz p4, :cond_d
 
-    goto :goto_5
+    goto :goto_6
 
-    :cond_c
+    :cond_d
     invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/LockSettingsService;->notifyPasswordChanged(Lcom/android/internal/widget/LockscreenCredential;I)V
 
-    :goto_5
+    :goto_6
     monitor-exit v6
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_0
+    :try_end_4
+    .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    :try_start_4
+    :try_start_5
     invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->isCredentialSharableWithParent(I)Z
 
     move-result p4
 
-    if-eqz p4, :cond_d
+    if-eqz p4, :cond_e
 
     invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->setDeviceUnlockedForUser(I)V
 
-    :cond_d
+    :cond_e
     invoke-virtual {p0, p3}, Lcom/android/server/locksettings/LockSettingsService;->notifySeparateProfileChallengeChanged(I)V
 
     invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/LockSettingsService;->onPostPasswordChanged(Lcom/android/internal/widget/LockscreenCredential;I)V
@@ -13939,16 +14243,16 @@
 
     move-result p4
 
-    if-eqz p4, :cond_e
+    if-eqz p4, :cond_f
 
     invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->zeroize()V
 
     invoke-virtual {p2}, Lcom/android/internal/widget/LockscreenCredential;->zeroize()V
 
-    :cond_e
+    :cond_f
     invoke-virtual {p0}, Lcom/android/server/locksettings/LockSettingsService;->scheduleGc()V
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_1
+    :try_end_5
+    .catchall {:try_start_5 .. :try_end_5} :catchall_1
 
     invoke-static {v4, v5}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
@@ -13979,15 +14283,15 @@
     :catchall_0
     move-exception p1
 
-    :try_start_5
+    :try_start_6
     monitor-exit v6
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_0
+    :try_end_6
+    .catchall {:try_start_6 .. :try_end_6} :catchall_0
 
-    :try_start_6
+    :try_start_7
     throw p1
-    :try_end_6
-    .catchall {:try_start_6 .. :try_end_6} :catchall_1
+    :try_end_7
+    .catchall {:try_start_7 .. :try_end_7} :catchall_1
 
     :catchall_1
     move-exception p1
@@ -14418,7 +14722,7 @@
 
     move-result v2
 
-    if-eqz v2, :cond_4
+    if-eqz v2, :cond_5
 
     move-wide/from16 v2, p2
 
@@ -14461,11 +14765,22 @@
 
     move-result v2
 
+    if-eqz v2, :cond_2
+
+    iget-object v3, v0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual/range {p1 .. p1}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
+
+    move-result v4
+
+    invoke-virtual {v3, v4, v5}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->onCredentialChanged(II)V
+
+    :cond_2
     monitor-exit v1
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_1
 
-    if-eqz v2, :cond_3
+    if-eqz v2, :cond_4
 
     iget-object v1, v0, Lcom/android/server/locksettings/LockSettingsService;->mSeparateChallengeLock:Ljava/lang/Object;
 
@@ -14486,7 +14801,7 @@
 
     move-result v1
 
-    if-eqz v1, :cond_2
+    if-eqz v1, :cond_3
 
     iget-object v1, v0, Lcom/android/server/locksettings/LockSettingsService;->mHandler:Landroid/os/Handler;
 
@@ -14496,7 +14811,7 @@
 
     invoke-virtual {v1, v3}, Landroid/os/Handler;->post(Ljava/lang/Runnable;)Z
 
-    :cond_2
+    :cond_3
     move-object/from16 v1, p1
 
     invoke-virtual {v0, v1, v5}, Lcom/android/server/locksettings/LockSettingsService;->notifyPasswordChanged(Lcom/android/internal/widget/LockscreenCredential;I)V
@@ -14515,7 +14830,7 @@
 
     throw v0
 
-    :cond_3
+    :cond_4
     :goto_0
     const-string v0, "Result of setting credential with token for user %d : %s"
 
@@ -14539,7 +14854,7 @@
 
     return v2
 
-    :cond_4
+    :cond_5
     :try_start_3
     new-instance v0, Ljava/lang/SecurityException;
 
@@ -14693,6 +15008,22 @@
     return v2
 
     :cond_2
+    if-eqz p1, :cond_3
+
+    invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
+
+    move-result p3
+
+    if-eqz p3, :cond_4
+
+    :cond_3
+    iget-object p3, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    iget-object p4, p2, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-virtual {p3, p4, p5}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->prepareMasterKeyIfUnsecured(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    :cond_4
     iget-object p3, p2, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
     invoke-virtual {p0, p5, p3}, Lcom/android/server/locksettings/LockSettingsService;->onSyntheticPasswordUnlocked(ILcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;)V
@@ -14800,9 +15131,9 @@
 
     move-result-object p0
 
-    new-instance p1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;
+    new-instance p1, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;
 
-    invoke-direct {p1, p4}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;-><init>(I)V
+    invoke-direct {p1, p4}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;-><init>(I)V
 
     invoke-virtual {p0, p1}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
 
@@ -15200,6 +15531,23 @@
 .method public final setUserPasswordMetrics(Lcom/android/internal/widget/LockscreenCredential;I)V
     .locals 1
 
+    invoke-static {p2}, Lcom/samsung/android/knox/dar/VirtualLockUtils;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mDualDarAuthUtils:Lcom/samsung/android/knox/dar/ddar/DualDarAuthUtils;
+
+    invoke-virtual {v0, p2}, Lcom/samsung/android/knox/dar/ddar/DualDarAuthUtils;->isInnerAuthUserForDo(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    return-void
+
+    :cond_0
     monitor-enter p0
 
     :try_start_0
@@ -15851,9 +16199,9 @@
 
     iget-object p1, p0, Lcom/android/server/locksettings/LockSettingsService;->mHandler:Landroid/os/Handler;
 
-    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;
+    new-instance v0, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;
 
-    invoke-direct {v0, p0, v3, v4}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda10;-><init>(Lcom/android/server/locksettings/LockSettingsService;J)V
+    invoke-direct {v0, p0, v3, v4}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda9;-><init>(Lcom/android/server/locksettings/LockSettingsService;J)V
 
     const-wide/32 v1, 0x927c0
 
@@ -16890,7 +17238,7 @@
 .end method
 
 .method public final unlockSdpOrSecureFolder(I)V
-    .locals 2
+    .locals 3
 
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mDualDarLockSettings:Lcom/android/server/locksettings/LockSettingsService$DualDarLockSettings;
 
@@ -16898,6 +17246,8 @@
 
     move-result v0
 
+    const-string v1, "LockSettingsService.SDP"
+
     if-eqz v0, :cond_0
 
     new-instance p0, Ljava/lang/StringBuilder;
@@ -16914,26 +17264,85 @@
 
     move-result-object p0
 
-    const-string p1, "LockSettingsService.SDP"
-
-    invoke-static {p1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
     goto :goto_1
 
     :cond_0
-    if-nez p1, :cond_2
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isEnterpriseUser(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isUserSecure(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_3
+
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v0
+
+    filled-new-array {v0}, [Ljava/lang/Object;
+
+    move-result-object v0
+
+    const-string v2, "Unlocking user - User %d has non type credential"
+
+    invoke-static {v2, v0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mSdpLockSettings:Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v0
+
+    new-instance v2, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19;
+
+    invoke-direct {v2, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda19;-><init>(I)V
+
+    invoke-virtual {v0, v2}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v2, "Unlocking user - Set device locked state (false) for user "
+
+    invoke-virtual {v0, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->setDeviceUnlockedForUser(I)V
+
+    goto :goto_1
+
+    :cond_1
+    if-nez p1, :cond_3
 
     invoke-static {}, Landroid/os/storage/StorageManager;->isFileEncryptedNativeOrEmulated()Z
 
     move-result v0
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isUserSecure(I)Z
 
     move-result v0
 
-    if-nez v0, :cond_2
+    if-nez v0, :cond_3
 
     iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mUserManager:Landroid/os/UserManager;
 
@@ -16945,13 +17354,13 @@
 
     move-result-object p1
 
-    :cond_1
+    :cond_2
     :goto_0
     invoke-interface {p1}, Ljava/util/Iterator;->hasNext()Z
 
     move-result v0
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     invoke-interface {p1}, Ljava/util/Iterator;->next()Ljava/lang/Object;
 
@@ -16963,13 +17372,13 @@
 
     move-result v1
 
-    if-eqz v1, :cond_1
+    if-eqz v1, :cond_2
 
     invoke-virtual {p0, v0}, Lcom/android/server/locksettings/LockSettingsService;->UnlockSecureFolderIfAutoDataDecryption(Landroid/content/pm/UserInfo;)V
 
     goto :goto_0
 
-    :cond_2
+    :cond_3
     :goto_1
     return-void
 .end method
@@ -18166,8 +18575,86 @@
 .end method
 
 .method public updateSdpMdfppForSystem(IJ)V
-    .locals 0
+    .locals 4
+
+    if-eqz p1, :cond_0
+
+    return-void
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/locksettings/LockSettingsService;->mSpManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v0
+
+    if-nez v0, :cond_2
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/LockSettingsService;->isDeviceOwner(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    invoke-static {p1}, Lcom/samsung/android/knox/SemPersonaManager;->isDarDualEncryptionEnabled(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_2
 
+    const-wide/16 v0, 0x0
+
+    const/4 v2, 0x0
+
+    const-string/jumbo v3, "sdp-mdfppmode-for-system"
+
+    invoke-virtual {p0, v3, v0, v1, v2}, Lcom/android/server/locksettings/LockSettingsService;->getLong(Ljava/lang/String;JI)J
+
+    move-result-wide v0
+
+    cmp-long v2, v0, p2
+
+    if-ltz v2, :cond_1
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p1, "Update SdpMdfpp for System for SdpMdfpp supported device. already set as : "
+
+    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, v0, v1}, Ljava/lang/StringBuilder;->append(J)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto :goto_0
+
+    :cond_1
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "Update SdpMdfpp for System for SdpMdfpp supported device. set : "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p2, p3}, Ljava/lang/StringBuilder;->append(J)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, v3, p2, p3, p1}, Lcom/android/server/locksettings/LockSettingsService;->setLong(Ljava/lang/String;JI)V
+
+    :cond_2
+    :goto_0
     return-void
 .end method
 
@@ -18198,9 +18685,9 @@
 
     new-instance v1, Ljava/lang/Thread;
 
-    new-instance v2, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;
+    new-instance v2, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;
 
-    invoke-direct {v2, p0, v0, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda8;-><init>(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
+    invoke-direct {v2, p0, v0, p1}, Lcom/android/server/locksettings/LockSettingsService$$ExternalSyntheticLambda17;-><init>(Lcom/android/server/locksettings/LockSettingsService;Landroid/content/Intent;[B)V
 
     const-string p0, "KMX_UPDATE_VERIFIER_SERVICE_CONNECTION"
 
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordCrypto.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordCrypto.smali
index 7744cfefa..2bd7d28cb 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordCrypto.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordCrypto.smali
@@ -22,6 +22,98 @@
     return-void
 .end method
 
+.method public static KBKDF([B[B[BI)[B
+    .locals 0
+
+    :try_start_0
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->nativeKBKDF([B[B[BI)[B
+
+    move-result-object p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-virtual {p0}, Ljava/lang/Throwable;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    return-object p0
+.end method
+
+.method public static KDF([B[B[BI)[B
+    .locals 0
+
+    :try_start_0
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->nativeKDF([B[B[BI)[B
+
+    move-result-object p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-virtual {p0}, Ljava/lang/Throwable;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    return-object p0
+.end method
+
+.method public static PBKDF2([B[BII)[B
+    .locals 0
+
+    :try_start_0
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->nativePBKDF2([B[BII)[B
+
+    move-result-object p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-virtual {p0}, Ljava/lang/Throwable;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    return-object p0
+.end method
+
+.method public static RBG(I)[B
+    .locals 0
+
+    :try_start_0
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->nativeRBG(I)[B
+
+    move-result-object p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-virtual {p0}, Ljava/lang/Throwable;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    return-object p0
+.end method
+
 .method public static androidKeystoreProviderName()Ljava/lang/String;
     .locals 1
 
@@ -201,6 +293,214 @@
     throw p1
 .end method
 
+.method public static varargs createBlob(Ljava/lang/String;[B[BJ[[B)[B
+    .locals 9
+
+    const-string v0, "AES"
+
+    const-string v1, "SyntheticPasswordCrypto"
+
+    :try_start_0
+    invoke-static {v0}, Ljavax/crypto/KeyGenerator;->getInstance(Ljava/lang/String;)Ljavax/crypto/KeyGenerator;
+
+    move-result-object v2
+
+    new-instance v3, Ljava/security/SecureRandom;
+
+    invoke-direct {v3}, Ljava/security/SecureRandom;-><init>()V
+
+    const/16 v4, 0x100
+
+    invoke-virtual {v2, v4, v3}, Ljavax/crypto/KeyGenerator;->init(ILjava/security/SecureRandom;)V
+
+    invoke-virtual {v2}, Ljavax/crypto/KeyGenerator;->generateKey()Ljavax/crypto/SecretKey;
+
+    move-result-object v2
+
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->getKeyStore()Ljava/security/KeyStore;
+
+    move-result-object v3
+
+    new-instance v4, Landroid/security/keystore/KeyProtection$Builder;
+
+    const/4 v5, 0x2
+
+    invoke-direct {v4, v5}, Landroid/security/keystore/KeyProtection$Builder;-><init>(I)V
+
+    const/4 v5, 0x1
+
+    new-array v6, v5, [Ljava/lang/String;
+
+    const-string v7, "GCM"
+
+    const/4 v8, 0x0
+
+    aput-object v7, v6, v8
+
+    invoke-virtual {v4, v6}, Landroid/security/keystore/KeyProtection$Builder;->setBlockModes([Ljava/lang/String;)Landroid/security/keystore/KeyProtection$Builder;
+
+    move-result-object v4
+
+    new-array v6, v5, [Ljava/lang/String;
+
+    const-string v7, "NoPadding"
+
+    aput-object v7, v6, v8
+
+    invoke-virtual {v4, v6}, Landroid/security/keystore/KeyProtection$Builder;->setEncryptionPaddings([Ljava/lang/String;)Landroid/security/keystore/KeyProtection$Builder;
+
+    move-result-object v4
+
+    invoke-virtual {v4, v5}, Landroid/security/keystore/KeyProtection$Builder;->setCriticalToDeviceEncryption(Z)Landroid/security/keystore/KeyProtection$Builder;
+
+    move-result-object v4
+
+    const-wide/16 v6, 0x0
+
+    cmp-long v6, p3, v6
+
+    if-eqz v6, :cond_0
+
+    invoke-virtual {v4, v5}, Landroid/security/keystore/KeyProtection$Builder;->setUserAuthenticationRequired(Z)Landroid/security/keystore/KeyProtection$Builder;
+
+    move-result-object v6
+
+    invoke-virtual {v6, p3, p4}, Landroid/security/keystore/KeyProtection$Builder;->setBoundToSpecificSecureUserId(J)Landroid/security/keystore/KeyProtection$Builder;
+
+    move-result-object p3
+
+    const/16 p4, 0xf
+
+    invoke-virtual {p3, p4}, Landroid/security/keystore/KeyProtection$Builder;->setUserAuthenticationValidityDurationSeconds(I)Landroid/security/keystore/KeyProtection$Builder;
+
+    :cond_0
+    invoke-virtual {v4}, Landroid/security/keystore/KeyProtection$Builder;->build()Landroid/security/keystore/KeyProtection;
+
+    move-result-object p3
+
+    invoke-virtual {v4, v5}, Landroid/security/keystore/KeyProtection$Builder;->setRollbackResistant(Z)Landroid/security/keystore/KeyProtection$Builder;
+
+    invoke-virtual {v4}, Landroid/security/keystore/KeyProtection$Builder;->build()Landroid/security/keystore/KeyProtection;
+
+    move-result-object p4
+
+    new-instance v4, Ljava/security/KeyStore$SecretKeyEntry;
+
+    invoke-direct {v4, v2}, Ljava/security/KeyStore$SecretKeyEntry;-><init>(Ljavax/crypto/SecretKey;)V
+    :try_end_0
+    .catch Ljava/security/cert/CertificateException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljava/io/IOException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljava/security/KeyStoreException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljava/security/InvalidKeyException; {:try_start_0 .. :try_end_0} :catch_1
+    .catch Ljava/security/spec/InvalidParameterSpecException; {:try_start_0 .. :try_end_0} :catch_1
+
+    :try_start_1
+    invoke-virtual {v3, p0, v4, p4}, Ljava/security/KeyStore;->setEntry(Ljava/lang/String;Ljava/security/KeyStore$Entry;Ljava/security/KeyStore$ProtectionParameter;)V
+
+    const-string p4, "Using rollback-resistant key"
+
+    invoke-static {v1, p4}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
+    :try_end_1
+    .catch Ljava/security/KeyStoreException; {:try_start_1 .. :try_end_1} :catch_0
+    .catch Ljava/security/cert/CertificateException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/io/IOException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/security/InvalidKeyException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/security/spec/InvalidParameterSpecException; {:try_start_1 .. :try_end_1} :catch_1
+
+    goto :goto_0
+
+    :catch_0
+    :try_start_2
+    const-string p4, "Rollback-resistant keys unavailable.  Falling back to non-rollback-resistant key"
+
+    invoke-static {v1, p4}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {v3, p0, v4, p3}, Ljava/security/KeyStore;->setEntry(Ljava/lang/String;Ljava/security/KeyStore$Entry;Ljava/security/KeyStore$ProtectionParameter;)V
+
+    :goto_0
+    if-eqz p5, :cond_1
+
+    invoke-static {p5}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->hasAAD([[B)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_1
+
+    new-instance p0, Ljavax/crypto/spec/SecretKeySpec;
+
+    const/16 p3, 0x20
+
+    invoke-static {p2, p3}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p2
+
+    invoke-direct {p0, p2, v0}, Ljavax/crypto/spec/SecretKeySpec;-><init>([BLjava/lang/String;)V
+
+    invoke-static {p5}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->extractAAD([[B)[B
+
+    move-result-object p2
+
+    filled-new-array {p2}, [[B
+
+    move-result-object p2
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt(Ljavax/crypto/SecretKey;[B[[B)[B
+
+    move-result-object p0
+
+    invoke-static {v2, p0, p5}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt(Ljavax/crypto/SecretKey;[B[[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_1
+    sget-object p0, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->PROTECTOR_SECRET_PERSONALIZATION:[B
+
+    invoke-static {p2, p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt([B[B[B)[B
+
+    move-result-object p0
+
+    invoke-static {v2, p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt(Ljavax/crypto/SecretKey;[B)[B
+
+    move-result-object p0
+    :try_end_2
+    .catch Ljava/security/cert/CertificateException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljava/io/IOException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljava/security/KeyStoreException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljava/security/InvalidKeyException; {:try_start_2 .. :try_end_2} :catch_1
+    .catch Ljava/security/spec/InvalidParameterSpecException; {:try_start_2 .. :try_end_2} :catch_1
+
+    return-object p0
+
+    :catch_1
+    move-exception p0
+
+    const-string p1, "Failed to create blob"
+
+    invoke-static {v1, p1, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+
+    new-instance p1, Ljava/lang/IllegalStateException;
+
+    const-string p2, "Failed to encrypt blob"
+
+    invoke-direct {p1, p2, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;Ljava/lang/Throwable;)V
+
+    throw p1
+.end method
+
 .method public static decrypt(Ljavax/crypto/SecretKey;[B)[B
     .locals 4
 
@@ -248,6 +548,68 @@
     return-object p0
 .end method
 
+.method public static varargs decrypt(Ljavax/crypto/SecretKey;[B[[B)[B
+    .locals 4
+
+    if-nez p1, :cond_0
+
+    const/4 p0, 0x0
+
+    return-object p0
+
+    :cond_0
+    const/4 v0, 0x0
+
+    const/16 v1, 0xc
+
+    invoke-static {p1, v0, v1}, Ljava/util/Arrays;->copyOfRange([BII)[B
+
+    move-result-object v0
+
+    array-length v2, p1
+
+    invoke-static {p1, v1, v2}, Ljava/util/Arrays;->copyOfRange([BII)[B
+
+    move-result-object p1
+
+    const-string v1, "AES/GCM/NoPadding"
+
+    invoke-static {v1}, Ljavax/crypto/Cipher;->getInstance(Ljava/lang/String;)Ljavax/crypto/Cipher;
+
+    move-result-object v1
+
+    new-instance v2, Ljavax/crypto/spec/GCMParameterSpec;
+
+    const/16 v3, 0x80
+
+    invoke-direct {v2, v3, v0}, Ljavax/crypto/spec/GCMParameterSpec;-><init>(I[B)V
+
+    const/4 v0, 0x2
+
+    invoke-virtual {v1, v0, p0, v2}, Ljavax/crypto/Cipher;->init(ILjava/security/Key;Ljava/security/spec/AlgorithmParameterSpec;)V
+
+    if-eqz p2, :cond_1
+
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->hasAAD([[B)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_1
+
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->extractAAD([[B)[B
+
+    move-result-object p0
+
+    invoke-virtual {v1, p0}, Ljavax/crypto/Cipher;->updateAAD([B)V
+
+    :cond_1
+    invoke-virtual {v1, p1}, Ljavax/crypto/Cipher;->doFinal([B)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static decrypt([B[B[B)[B
     .locals 1
 
@@ -283,62 +645,246 @@
     .catch Ljavax/crypto/BadPaddingException; {:try_start_0 .. :try_end_0} :catch_0
     .catch Ljava/security/InvalidAlgorithmParameterException; {:try_start_0 .. :try_end_0} :catch_0
 
-    return-object p0
-
+    return-object p0
+
+    :catch_0
+    move-exception p0
+
+    const-string p1, "SyntheticPasswordCrypto"
+
+    const-string p2, "Failed to decrypt"
+
+    invoke-static {p1, p2, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+
+    const/4 p0, 0x0
+
+    return-object p0
+.end method
+
+.method public static varargs decrypt([B[B[B[[B)[B
+    .locals 4
+
+    const/4 v0, 0x0
+
+    const-string v1, "AES"
+
+    const/16 v2, 0x20
+
+    if-eqz p3, :cond_0
+
+    invoke-static {p3}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->hasAAD([[B)Z
+
+    move-result v3
+
+    if-eqz v3, :cond_0
+
+    new-instance p1, Ljavax/crypto/spec/SecretKeySpec;
+
+    invoke-static {p0, v2}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p0
+
+    invoke-direct {p1, p0, v1}, Ljavax/crypto/spec/SecretKeySpec;-><init>([BLjava/lang/String;)V
+
+    :try_start_0
+    invoke-static {p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B[[B)[B
+
+    move-result-object p0
+    :try_end_0
+    .catch Ljava/security/InvalidKeyException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/InvalidAlgorithmParameterException; {:try_start_0 .. :try_end_0} :catch_0
+
+    return-object p0
+
+    :catch_0
+    move-exception p0
+
+    invoke-virtual {p0}, Ljava/security/GeneralSecurityException;->printStackTrace()V
+
+    return-object v0
+
+    :cond_0
+    filled-new-array {p0}, [[B
+
+    move-result-object p0
+
+    invoke-static {p1, p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->personalizedHash([B[[B)[B
+
+    move-result-object p0
+
+    new-instance p1, Ljavax/crypto/spec/SecretKeySpec;
+
+    invoke-static {p0, v2}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p0
+
+    invoke-direct {p1, p0, v1}, Ljavax/crypto/spec/SecretKeySpec;-><init>([BLjava/lang/String;)V
+
+    :try_start_1
+    invoke-static {p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B)[B
+
+    move-result-object p0
+    :try_end_1
+    .catch Ljava/security/InvalidKeyException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_1 .. :try_end_1} :catch_1
+    .catch Ljava/security/InvalidAlgorithmParameterException; {:try_start_1 .. :try_end_1} :catch_1
+
+    return-object p0
+
+    :catch_1
+    move-exception p0
+
+    const-string p1, "SyntheticPasswordCrypto"
+
+    const-string p2, "Failed to decrypt"
+
+    invoke-static {p1, p2, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+
+    return-object v0
+.end method
+
+.method public static decryptBlob(Ljava/lang/String;[B[B)[B
+    .locals 2
+
+    :try_start_0
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->getKeyStore()Ljava/security/KeyStore;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    invoke-virtual {v0, p0, v1}, Ljava/security/KeyStore;->getKey(Ljava/lang/String;[C)Ljava/security/Key;
+
+    move-result-object v0
+
+    check-cast v0, Ljavax/crypto/SecretKey;
+
+    if-eqz v0, :cond_0
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B)[B
+
+    move-result-object p0
+
+    sget-object p1, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->PROTECTOR_SECRET_PERSONALIZATION:[B
+
+    invoke-static {p2, p1, p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    new-instance p1, Ljava/lang/IllegalStateException;
+
+    new-instance p2, Ljava/lang/StringBuilder;
+
+    invoke-direct {p2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v0, "SP protector key is missing: "
+
+    invoke-virtual {p2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p2, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-direct {p1, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw p1
+    :try_end_0
+    .catch Ljava/security/cert/CertificateException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/io/IOException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/BadPaddingException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/IllegalBlockSizeException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/KeyStoreException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljavax/crypto/NoSuchPaddingException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/NoSuchAlgorithmException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/InvalidKeyException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/UnrecoverableKeyException; {:try_start_0 .. :try_end_0} :catch_0
+    .catch Ljava/security/InvalidAlgorithmParameterException; {:try_start_0 .. :try_end_0} :catch_0
+
     :catch_0
     move-exception p0
 
     const-string p1, "SyntheticPasswordCrypto"
 
-    const-string p2, "Failed to decrypt"
+    const-string p2, "Failed to decrypt blob"
 
     invoke-static {p1, p2, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
-    const/4 p0, 0x0
+    new-instance p1, Ljava/lang/IllegalStateException;
 
-    return-object p0
+    invoke-direct {p1, p2, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;Ljava/lang/Throwable;)V
+
+    throw p1
 .end method
 
-.method public static decryptBlob(Ljava/lang/String;[B[B)[B
-    .locals 2
+.method public static varargs decryptBlob(Ljava/lang/String;[B[B[[B)[B
+    .locals 3
+
+    const-string v0, "Failed to decrypt blob"
+
+    const/4 v1, 0x0
 
     :try_start_0
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->getKeyStore()Ljava/security/KeyStore;
 
-    move-result-object v0
+    move-result-object v2
 
-    const/4 v1, 0x0
+    invoke-virtual {v2, p0, v1}, Ljava/security/KeyStore;->getKey(Ljava/lang/String;[C)Ljava/security/Key;
 
-    invoke-virtual {v0, p0, v1}, Ljava/security/KeyStore;->getKey(Ljava/lang/String;[C)Ljava/security/Key;
+    move-result-object v2
 
-    move-result-object v0
+    check-cast v2, Ljavax/crypto/SecretKey;
 
-    check-cast v0, Ljavax/crypto/SecretKey;
+    if-eqz v2, :cond_1
 
-    if-eqz v0, :cond_0
+    if-eqz p3, :cond_0
 
-    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B)[B
+    invoke-static {v2, p1, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B[[B)[B
 
     move-result-object p0
 
     sget-object p1, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->PROTECTOR_SECRET_PERSONALIZATION:[B
 
-    invoke-static {p2, p1, p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B)[B
+    invoke-static {p2, p1, p0, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B[[B)[B
 
     move-result-object p0
 
     return-object p0
 
     :cond_0
+    invoke-static {v2, p1}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt(Ljavax/crypto/SecretKey;[B)[B
+
+    move-result-object p0
+
+    sget-object p1, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->PROTECTOR_SECRET_PERSONALIZATION:[B
+
+    invoke-static {p2, p1, p0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_1
     new-instance p1, Ljava/lang/IllegalStateException;
 
     new-instance p2, Ljava/lang/StringBuilder;
 
     invoke-direct {p2}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v0, "SP protector key is missing: "
+    const-string v2, "SP key is missing: "
 
-    invoke-virtual {p2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p2, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     invoke-virtual {p2, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
@@ -350,6 +896,7 @@
 
     throw p1
     :try_end_0
+    .catch Ljavax/crypto/AEADBadTagException; {:try_start_0 .. :try_end_0} :catch_1
     .catch Ljava/security/cert/CertificateException; {:try_start_0 .. :try_end_0} :catch_0
     .catch Ljava/io/IOException; {:try_start_0 .. :try_end_0} :catch_0
     .catch Ljavax/crypto/BadPaddingException; {:try_start_0 .. :try_end_0} :catch_0
@@ -366,13 +913,39 @@
 
     const-string p1, "SyntheticPasswordCrypto"
 
-    const-string p2, "Failed to decrypt blob"
+    invoke-static {p1, v0, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
-    invoke-static {p1, p2, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+    new-instance p1, Ljava/lang/IllegalStateException;
+
+    invoke-direct {p1, v0, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;Ljava/lang/Throwable;)V
+
+    throw p1
+
+    :catch_1
+    move-exception p0
+
+    const-string p1, "SyntheticPasswordCrypto.SDP"
+
+    const-string p2, "Authentication failed before decrypt blob"
+
+    invoke-static {p1, p2}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {p0}, Ljavax/crypto/AEADBadTagException;->printStackTrace()V
+
+    if-eqz p3, :cond_2
 
+    invoke-static {p3}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->hasAAD([[B)Z
+
+    move-result p1
+
+    if-eqz p1, :cond_2
+
+    return-object v1
+
+    :cond_2
     new-instance p1, Ljava/lang/IllegalStateException;
 
-    invoke-direct {p1, p2, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;Ljava/lang/Throwable;)V
+    invoke-direct {p1, v0, p0}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;Ljava/lang/Throwable;)V
 
     throw p1
 .end method
@@ -627,6 +1200,134 @@
     throw p0
 .end method
 
+.method public static varargs encrypt(Ljavax/crypto/SecretKey;[B[[B)[B
+    .locals 2
+
+    if-nez p1, :cond_0
+
+    const/4 p0, 0x0
+
+    return-object p0
+
+    :cond_0
+    const-string v0, "AES/GCM/NoPadding"
+
+    invoke-static {v0}, Ljavax/crypto/Cipher;->getInstance(Ljava/lang/String;)Ljavax/crypto/Cipher;
+
+    move-result-object v0
+
+    const/4 v1, 0x1
+
+    invoke-virtual {v0, v1, p0}, Ljavax/crypto/Cipher;->init(ILjava/security/Key;)V
+
+    if-eqz p2, :cond_1
+
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->hasAAD([[B)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_1
+
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;->extractAAD([[B)[B
+
+    move-result-object p0
+
+    invoke-virtual {v0, p0}, Ljavax/crypto/Cipher;->updateAAD([B)V
+
+    :cond_1
+    invoke-virtual {v0, p1}, Ljavax/crypto/Cipher;->doFinal([B)[B
+
+    move-result-object p0
+
+    invoke-virtual {v0}, Ljavax/crypto/Cipher;->getIV()[B
+
+    move-result-object p1
+
+    array-length p2, p1
+
+    const/16 v1, 0xc
+
+    if-ne p2, v1, :cond_3
+
+    invoke-virtual {v0}, Ljavax/crypto/Cipher;->getParameters()Ljava/security/AlgorithmParameters;
+
+    move-result-object p2
+
+    const-class v0, Ljavax/crypto/spec/GCMParameterSpec;
+
+    invoke-virtual {p2, v0}, Ljava/security/AlgorithmParameters;->getParameterSpec(Ljava/lang/Class;)Ljava/security/spec/AlgorithmParameterSpec;
+
+    move-result-object p2
+
+    check-cast p2, Ljavax/crypto/spec/GCMParameterSpec;
+
+    invoke-virtual {p2}, Ljavax/crypto/spec/GCMParameterSpec;->getTLen()I
+
+    move-result v0
+
+    const/16 v1, 0x80
+
+    if-ne v0, v1, :cond_2
+
+    filled-new-array {p1, p0}, [[B
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/internal/util/ArrayUtils;->concat([[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_2
+    new-instance p0, Ljava/lang/IllegalArgumentException;
+
+    new-instance p1, Ljava/lang/StringBuilder;
+
+    invoke-direct {p1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v0, "Invalid tag length: "
+
+    invoke-virtual {p1, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p2}, Ljavax/crypto/spec/GCMParameterSpec;->getTLen()I
+
+    move-result p2
+
+    invoke-virtual {p1, p2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p1
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalArgumentException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+
+    :cond_3
+    new-instance p0, Ljava/lang/IllegalArgumentException;
+
+    new-instance p2, Ljava/lang/StringBuilder;
+
+    invoke-direct {p2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v0, "Invalid iv length: "
+
+    invoke-virtual {p2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    array-length p1, p1
+
+    invoke-virtual {p2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p1
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalArgumentException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
 .method public static encrypt([B[B[B)[B
     .locals 1
 
@@ -828,6 +1529,119 @@
 .method public static native nativeRBG(I)[B
 .end method
 
+.method public static personalize([BILjava/lang/String;Ljava/lang/String;)[B
+    .locals 4
+
+    if-eqz p0, :cond_5
+
+    if-eqz p2, :cond_5
+
+    if-eqz p3, :cond_5
+
+    const/4 v0, 0x1
+
+    if-lt p1, v0, :cond_4
+
+    const/4 v1, 0x2
+
+    if-gt p1, v1, :cond_4
+
+    invoke-virtual {p2}, Ljava/lang/String;->getBytes()[B
+
+    move-result-object p2
+
+    invoke-virtual {p3}, Ljava/lang/String;->getBytes()[B
+
+    move-result-object p3
+
+    array-length v1, p2
+
+    const/16 v2, 0x20
+
+    if-gt v1, v2, :cond_3
+
+    array-length v1, p3
+
+    const/16 v3, 0x40
+
+    if-gt v1, v3, :cond_3
+
+    invoke-static {p2, v2}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p2
+
+    invoke-static {p3, v3}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p3
+
+    if-eq p1, v0, :cond_0
+
+    invoke-static {p0, p2, p3, v2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->KBKDF([B[B[BI)[B
+
+    move-result-object p0
+
+    goto :goto_0
+
+    :cond_0
+    invoke-static {p0, p2, p3, v2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->KDF([B[B[BI)[B
+
+    move-result-object p0
+
+    :goto_0
+    if-eqz p0, :cond_2
+
+    array-length p1, p0
+
+    if-le p1, v2, :cond_1
+
+    invoke-static {p0, v2}, Ljava/util/Arrays;->copyOf([BI)[B
+
+    move-result-object p1
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/SecureUtil;->clear([B)V
+
+    move-object p0, p1
+
+    :cond_1
+    return-object p0
+
+    :cond_2
+    new-instance p0, Ljava/lang/IllegalStateException;
+
+    const-string p1, "Unexpected native error while personalization"
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+
+    :cond_3
+    new-instance p0, Ljava/lang/IllegalStateException;
+
+    const-string p1, "Personalization too long"
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+
+    :cond_4
+    new-instance p0, Ljava/lang/IllegalStateException;
+
+    const-string p1, "Invalid secure mode for personalization"
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+
+    :cond_5
+    new-instance p0, Ljava/lang/IllegalStateException;
+
+    const-string p1, "Make sure of input parameter"
+
+    invoke-direct {p0, p1}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
 .method public static varargs personalizedHash([B[[B)[B
     .locals 3
 
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken.smali
index be8a3dbd4..83bcabde7 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken.smali
@@ -10,6 +10,14 @@
 
 
 # direct methods
+.method public static bridge synthetic -$$Nest$fgetsecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;)I
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->secureMode:I
+
+    return p0
+.end method
+
 .method public constructor <init>()V
     .locals 1
 
@@ -32,6 +40,22 @@
 
 
 # virtual methods
+.method public getSecureMode()I
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->secureMode:I
+
+    return p0
+.end method
+
+.method public isDestroyed()Z
+    .locals 0
+
+    iget-boolean p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->destroyed:Z
+
+    return p0
+.end method
+
 .method public setDestroyed(Z)V
     .locals 0
 
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$PasswordData.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$PasswordData.smali
index f31af45a7..2e476881f 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$PasswordData.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$PasswordData.smali
@@ -76,8 +76,22 @@
     return-object v0
 .end method
 
+.method public static create(III)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->create(II)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p2}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->setSecureMode(I)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static fromBytes([B)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
-    .locals 4
+    .locals 5
 
     new-instance v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
 
@@ -163,11 +177,45 @@
 
     invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v1, "Inside fromBytes() - result.pinLength : "
+    const-string v2, "Inside fromBytes() - result.pinLength : "
+
+    invoke-virtual {p0, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    iget v2, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->pinLength:I
+
+    invoke-virtual {p0, v2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string v2, "SyntheticPasswordManager.SDP"
+
+    invoke-static {v2, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {v1}, Ljava/nio/ByteBuffer;->remaining()I
+
+    move-result p0
+
+    const/4 v4, 0x4
+
+    if-lt p0, v4, :cond_1
+
+    invoke-virtual {v1}, Ljava/nio/ByteBuffer;->getInt()I
+
+    move-result p0
+
+    iput p0, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v1, "1. result.secureMode : "
 
     invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    iget v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->pinLength:I
+    iget v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
 
     invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
@@ -175,35 +223,37 @@
 
     move-result-object p0
 
-    const-string v1, "SyntheticPasswordManager.SDP"
+    invoke-static {v2, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
-    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+    goto :goto_1
 
+    :cond_1
     iput v3, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
 
     new-instance p0, Ljava/lang/StringBuilder;
 
     invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v2, "2. result.secureMode : "
+    const-string v1, "2. result.secureMode : "
 
-    invoke-virtual {p0, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    iget v2, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+    iget v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
 
-    invoke-virtual {p0, v2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {p0, v1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
     move-result-object p0
 
-    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v2, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
+    :goto_1
     return-object v0
 .end method
 
 .method public static fromBytesForMigration([B)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
-    .locals 4
+    .locals 5
 
     new-instance v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
 
@@ -285,11 +335,11 @@
 
     invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->isNormalSecureMode(I)Z
 
-    move-result v1
+    move-result v2
 
-    const-string v2, "SyntheticPasswordManager"
+    const-string v4, "SyntheticPasswordManager"
 
-    if-eqz v1, :cond_1
+    if-eqz v2, :cond_1
 
     const/4 v1, -0x1
 
@@ -313,15 +363,33 @@
 
     move-result-object p0
 
-    invoke-static {v2, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
+    invoke-static {v4, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
 
-    goto :goto_1
+    goto :goto_2
 
     :cond_1
     iput p0, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->pinLength:I
 
+    invoke-virtual {v1}, Ljava/nio/ByteBuffer;->remaining()I
+
+    move-result p0
+
+    const/4 v2, 0x4
+
+    if-lt p0, v2, :cond_2
+
+    invoke-virtual {v1}, Ljava/nio/ByteBuffer;->getInt()I
+
+    move-result p0
+
+    iput p0, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+
+    goto :goto_1
+
+    :cond_2
     iput v3, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
 
+    :goto_1
     new-instance p0, Ljava/lang/StringBuilder;
 
     invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
@@ -346,9 +414,9 @@
 
     move-result-object p0
 
-    invoke-static {v2, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
+    invoke-static {v4, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
 
-    :goto_1
+    :goto_2
     return-object v0
 .end method
 
@@ -403,6 +471,50 @@
 
 
 # virtual methods
+.method public isSdpMdfppMode()Z
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+
+    if-lez p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    return p0
+.end method
+
+.method public setSecureMode(I)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
+    .locals 1
+
+    if-ltz p1, :cond_1
+
+    const/4 v0, 0x2
+
+    if-le p1, v0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 p1, 0x0
+
+    iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
+
+    :goto_1
+    return-object p0
+.end method
+
 .method public toBytes()[B
     .locals 4
 
@@ -432,6 +544,8 @@
 
     add-int/lit8 v0, v0, 0x4
 
+    add-int/lit8 v0, v0, 0x4
+
     invoke-static {v0}, Ljava/nio/ByteBuffer;->allocate(I)Ljava/nio/ByteBuffer;
 
     move-result-object v0
@@ -492,7 +606,11 @@
     invoke-virtual {v0, v2}, Ljava/nio/ByteBuffer;->putInt(I)Ljava/nio/ByteBuffer;
 
     :goto_1
-    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->pinLength:I
+    iget v1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->pinLength:I
+
+    invoke-virtual {v0, v1}, Ljava/nio/ByteBuffer;->putInt(I)Ljava/nio/ByteBuffer;
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->secureMode:I
 
     invoke-virtual {v0, p0}, Ljava/nio/ByteBuffer;->putInt(I)Ljava/nio/ByteBuffer;
 
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0.smali
index b8c3d3122..07ad304dd 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0.smali
@@ -3,36 +3,40 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Ljava/util/function/Function;
+.implements Ljava/util/function/Consumer;
 
 
 # instance fields
 .field public final synthetic f$0:I
 
+.field public final synthetic f$1:J
+
 
 # direct methods
-.method public synthetic constructor <init>(I)V
+.method public synthetic constructor <init>(IJ)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
     iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;->f$0:I
 
+    iput-wide p2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;->f$1:J
+
     return-void
 .end method
 
 
 # virtual methods
-.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
-    .locals 0
+.method public final accept(Ljava/lang/Object;)V
+    .locals 3
 
-    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;->f$0:I
+    iget v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;->f$0:I
 
-    check-cast p1, Lcom/android/internal/widget/LockSettingsInternal;
+    iget-wide v1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;->f$1:J
 
-    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->$r8$lambda$U79uhHfJQuEjRQSUakV5LmnDph8(ILcom/android/internal/widget/LockSettingsInternal;)Ljava/lang/Integer;
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
 
-    move-result-object p0
+    invoke-static {v0, v1, v2, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->$r8$lambda$kuY4VCeCfOpA_h3n7bK9FXIodvw(IJLcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
 
-    return-object p0
+    return-void
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1.smali
new file mode 100644
index 000000000..34a8b5c3d
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->$r8$lambda$8YNLJ8mv1OStd8eA3pBumO1-IsQ(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2.smali
new file mode 100644
index 000000000..8ba150486
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->$r8$lambda$06zECyHfDtgpBY-CmjybjrZTDl8(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3.smali
new file mode 100644
index 000000000..334393c4f
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3;->f$0:I
+
+    check-cast p1, Lcom/android/internal/widget/LockSettingsInternal;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->$r8$lambda$U79uhHfJQuEjRQSUakV5LmnDph8(ILcom/android/internal/widget/LockSettingsInternal;)Ljava/lang/Integer;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager.smali
index 4a9b469ac..9bcdd85b4 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager.smali
@@ -10,6 +10,26 @@
 
 
 # direct methods
+.method public static synthetic $r8$lambda$06zECyHfDtgpBY-CmjybjrZTDl8(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->lambda$isSdpMdfppModeEnabledForSystem$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic $r8$lambda$8YNLJ8mv1OStd8eA3pBumO1-IsQ(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->lambda$isNeedToEnableSdpMdfppModeForSystem$2(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static synthetic $r8$lambda$U79uhHfJQuEjRQSUakV5LmnDph8(ILcom/android/internal/widget/LockSettingsInternal;)Ljava/lang/Integer;
     .locals 0
 
@@ -20,6 +40,30 @@
     return-object p0
 .end method
 
+.method public static synthetic $r8$lambda$kuY4VCeCfOpA_h3n7bK9FXIodvw(IJLcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->lambda$updateSdpMdfppModeForSystem$3(IJLcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$mcreateSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
+    .locals 0
+
+    invoke-virtual/range {p0 .. p9}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->createSyntheticPasswordBlobSpecific(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$mdeleteSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)V
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->deleteSecureMode(I)V
+
+    return-void
+.end method
+
 .method public static bridge synthetic -$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
     .locals 0
 
@@ -30,6 +74,26 @@
     return p0
 .end method
 
+.method public static bridge synthetic -$$Nest$mgetSecureModeForNewSyntheticPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->getSecureModeForNewSyntheticPassword(I)I
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public static bridge synthetic -$$Nest$misNeedToEnableSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isNeedToEnableSdpMdfppModeForSystem(I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
 .method public static bridge synthetic -$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
     .locals 0
 
@@ -40,6 +104,72 @@
     return p0
 .end method
 
+.method public static bridge synthetic -$$Nest$misSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeForSystem(I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public static bridge synthetic -$$Nest$misSdpUser(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpUser(I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public static bridge synthetic -$$Nest$misSpecificProcessRequired(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSpecificProcessRequired(I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public static bridge synthetic -$$Nest$mpostDeleteState(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;Ljava/lang/String;I)V
+    .locals 0
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->postDeleteState(Ljava/lang/String;I)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$mpostReadOrWriteState(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;Ljava/lang/String;[BI)V
+    .locals 0
+
+    invoke-virtual {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->postReadOrWriteState(Ljava/lang/String;[BI)V
+
+    return-void
+.end method
+
+.method public static bridge synthetic -$$Nest$munwrapSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JB[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    .locals 0
+
+    invoke-virtual/range {p0 .. p8}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->unwrapSyntheticPasswordBlobSpecific(JB[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static bridge synthetic -$$Nest$mupdateSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;IJ)Z
+    .locals 0
+
+    invoke-virtual {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->updateSdpMdfppModeForSystem(IJ)Z
+
+    move-result p0
+
+    return p0
+.end method
+
 .method public constructor <init>(Lcom/android/server/locksettings/SyntheticPasswordManager;Lcom/android/server/locksettings/SyntheticPasswordManager;)V
     .locals 0
 
@@ -66,8 +196,92 @@
     return-object p0
 .end method
 
+.method public static synthetic lambda$isNeedToEnableSdpMdfppModeForSystem$2(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isNeedToEnableSdpMdfppModeForSystem(I)Z
+
+    move-result p0
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic lambda$isSdpMdfppModeEnabledForSystem$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isSdpMdfppModeEnabledForSystem(I)Z
+
+    move-result p0
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic lambda$updateSdpMdfppModeForSystem$3(IJLcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p3, p0, p1, p2}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->updateSdpMdfppModeForSystem(IJ)V
+
+    return-void
+.end method
+
 
 # virtual methods
+.method public final adjustCredentialType(II)I
+    .locals 3
+
+    const/4 v0, 0x2
+
+    if-ne p1, v0, :cond_1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$fgetmStorage(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/locksettings/LockSettingsStorage;
+
+    move-result-object p0
+
+    const-string/jumbo v0, "lockscreen.password_type"
+
+    const-wide/16 v1, 0x0
+
+    invoke-virtual {p0, v0, v1, v2, p2}, Lcom/android/server/locksettings/LockSettingsStorage;->getLong(Ljava/lang/String;JI)J
+
+    move-result-wide v0
+
+    long-to-int p0, v0
+
+    invoke-static {p0}, Lcom/android/internal/widget/LockPatternUtils;->isQualityAlphabeticPassword(I)Z
+
+    move-result p2
+
+    if-eqz p2, :cond_0
+
+    const/4 p0, 0x4
+
+    return p0
+
+    :cond_0
+    invoke-static {p0}, Lcom/android/internal/widget/LockPatternUtils;->isQualityNumericPin(I)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_1
+
+    const/4 p0, 0x3
+
+    return p0
+
+    :cond_1
+    return p1
+.end method
+
 .method public final cacheSecureMode(II)V
     .locals 0
 
@@ -105,193 +319,1222 @@
     return-void
 .end method
 
-.method public final getSecureMode(I)I
+.method public varargs createSPBlob(Ljava/lang/String;[B[BJB[[B)[B
     .locals 6
 
-    const-string v0, "SyntheticPasswordManager.SDP"
+    const/4 p0, 0x1
 
-    const/4 v1, -0x1
+    if-ne p6, p0, :cond_0
 
-    :try_start_0
-    invoke-static {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->getSecureMode(I)I
+    move-object v0, p1
 
-    move-result v2
-    :try_end_0
-    .catch Lcom/android/server/locksettings/SyntheticPasswordMdfpp$EmptySlotException; {:try_start_0 .. :try_end_0} :catch_0
+    move-object v1, p2
+
+    move-object v2, p3
+
+    move-wide v3, p4
+
+    move-object v5, p7
+
+    invoke-static/range {v0 .. v5}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->createBlob(Ljava/lang/String;[B[BJ[[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    new-instance p0, Ljava/lang/SecurityException;
+
+    const-string p1, "Make sure of input parameter"
+
+    invoke-direct {p0, p1}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
+.method public final createSyntheticPasswordBlobSpecific(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
+    .locals 21
+
+    move-object/from16 v8, p0
+
+    move/from16 v9, p3
+
+    const/4 v10, 0x2
+
+    const/4 v11, 0x1
+
+    if-eq v9, v11, :cond_1
+
+    if-ne v9, v10, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    invoke-virtual/range {p4 .. p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object v0
 
     goto :goto_1
 
-    :catch_0
-    move-exception v2
+    :cond_1
+    :goto_0
+    invoke-virtual/range {p4 .. p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getEscrowSecret()[B
 
-    iget-object v3, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+    move-result-object v0
 
-    invoke-virtual {v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+    :goto_1
+    move-object v2, v0
 
-    move-result v3
+    new-instance v0, Ljava/lang/StringBuilder;
 
-    if-nez v3, :cond_1
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetDEBUG()Z
+    const-string v1, "createSPBlob with TARGET_ANDROID_KEYSTORE for user "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move/from16 v12, p8
+
+    invoke-virtual {v0, v12}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v0
+
+    const-string v1, "SyntheticPasswordManager"
+
+    invoke-static {v1, v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
+
+    iget-object v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    move-wide/from16 v13, p1
+
+    invoke-static {v0, v13, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetProtectorKeyAlias(Lcom/android/server/locksettings/SyntheticPasswordManager;J)Ljava/lang/String;
+
+    move-result-object v1
+
+    const/4 v6, 0x1
+
+    invoke-virtual/range {p9 .. p9}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAAD()[B
+
+    move-result-object v0
+
+    filled-new-array {v0}, [[B
+
+    move-result-object v7
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v3, p5
+
+    move-wide/from16 v4, p6
+
+    invoke-virtual/range {v0 .. v7}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->createSPBlob(Ljava/lang/String;[B[BJB[[B)[B
+
+    move-result-object v0
+
+    if-eqz v0, :cond_2
+
+    array-length v1, v0
+
+    const/16 v2, 0x13
+
+    add-int/2addr v1, v2
+
+    new-array v5, v1, [B
+
+    const/4 v1, 0x0
+
+    const/4 v3, 0x3
+
+    aput-byte v3, v5, v1
+
+    aput-byte v9, v5, v11
+
+    aput-byte v11, v5, v10
+
+    invoke-static {v5, v3, v2, v1}, Ljava/util/Arrays;->fill([BIIB)V
+
+    array-length v3, v0
+
+    invoke-static {v0, v1, v5, v2, v3}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
+
+    const-string v15, "SYNTHETIC_PASSWORD_VERSION_LATEST"
+
+    aget-byte v0, v5, v1
+
+    invoke-static {v0}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
+
+    move-result-object v16
+
+    const-string/jumbo v17, "protectorType"
+
+    aget-byte v0, v5, v11
+
+    invoke-static {v0}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
+
+    move-result-object v18
+
+    const-string/jumbo v19, "targetKeystore"
+
+    invoke-static {v11}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
+
+    move-result-object v20
+
+    filled-new-array/range {v15 .. v20}, [Ljava/lang/Object;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->p([Ljava/lang/Object;)V
+
+    iget-object v3, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    const-string/jumbo v4, "spblob"
+
+    move-wide/from16 v6, p1
+
+    move/from16 v8, p8
+
+    invoke-static/range {v3 .. v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$msaveState(Lcom/android/server/locksettings/SyntheticPasswordManager;Ljava/lang/String;[BJI)V
+
+    return-void
+
+    :cond_2
+    new-instance v0, Ljava/lang/SecurityException;
+
+    const-string v1, "content is null"
+
+    invoke-direct {v0, v1}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+.end method
+
+.method public varargs decryptSPBlob(Ljava/lang/String;[B[BB[[B)[B
+    .locals 0
+
+    const/4 p0, 0x1
+
+    if-ne p4, p0, :cond_0
+
+    invoke-static {p1, p2, p3, p5}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decryptBlob(Ljava/lang/String;[B[B[[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    new-instance p0, Ljava/lang/SecurityException;
+
+    const-string p1, "Make sure of input parameter"
+
+    invoke-direct {p0, p1}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
+.method public decryptSPBlobV1(Ljava/lang/String;[B[BB)[B
+    .locals 0
+
+    const/4 p0, 0x1
+
+    if-ne p4, p0, :cond_0
+
+    invoke-static {p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decryptBlobV1(Ljava/lang/String;[B[B)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
+    new-instance p0, Ljava/lang/SecurityException;
+
+    const-string p1, "Make sure of input parameter"
+
+    invoke-direct {p0, p1}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
+.method public final deleteSecureMode(I)V
+    .locals 0
+
+    invoke-static {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deleteSecureMode(I)V
+
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetDEBUG()Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p0
+
+    filled-new-array {p0}, [Ljava/lang/Object;
+
+    move-result-object p0
+
+    const-string p1, "Delete - [ Secure Mode : X, UserId : %d ]"
+
+    invoke-static {p1, p0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "SyntheticPasswordManager.SDP"
+
+    invoke-static {p1, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_0
+    return-void
+.end method
+
+.method public final getSecureMode(I)I
+    .locals 6
+
+    const-string v0, "SyntheticPasswordManager.SDP"
+
+    const/4 v1, -0x1
+
+    :try_start_0
+    invoke-static {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->getSecureMode(I)I
+
+    move-result v2
+    :try_end_0
+    .catch Lcom/android/server/locksettings/SyntheticPasswordMdfpp$EmptySlotException; {:try_start_0 .. :try_end_0} :catch_0
+
+    goto :goto_1
+
+    :catch_0
+    move-exception v2
+
+    iget-object v3, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-virtual {v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v3
+
+    if-nez v3, :cond_1
+
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetDEBUG()Z
+
+    move-result v3
+
+    if-eqz v3, :cond_0
+
+    invoke-virtual {v2}, Ljava/lang/SecurityException;->printStackTrace()V
+
+    goto :goto_0
+
+    :cond_0
+    invoke-virtual {v2}, Ljava/lang/SecurityException;->getMessage()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v0, v2}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_1
+    :goto_0
+    move v2, v1
+
+    :goto_1
+    if-ne v2, v1, :cond_7
+
+    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-virtual {v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v2
+
+    const/4 v3, 0x0
+
+    if-nez v2, :cond_6
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSpecificProcessRequired(I)Z
+
+    move-result v2
+
+    if-nez v2, :cond_2
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeEnabledForSystem(I)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_6
+
+    :cond_2
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isNeedToEnableSdpMdfppModeForSystem(I)Z
+
+    move-result v2
+
+    const-string v4, " using AOSP SP"
+
+    if-eqz v2, :cond_3
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v5, "Secure mode not set yet for System (Device owner) "
+
+    invoke-virtual {v2, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    const/4 v2, 0x1
+
+    goto :goto_2
+
+    :cond_3
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeEnabledForSystem(I)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_4
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v5, "Secure mode was set for System (Device owner) "
+
+    invoke-virtual {v2, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    :cond_4
+    move v2, v3
+
+    :goto_2
+    if-nez v2, :cond_6
+
+    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetLockSettingsInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
+
+    move-result-object v2
+
+    new-instance v3, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3;
+
+    invoke-direct {v3, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda3;-><init>(I)V
+
+    invoke-virtual {v2, v3}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object v2
+
+    invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v3
+
+    invoke-virtual {v2, v3}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v2
+
+    check-cast v2, Ljava/lang/Integer;
+
+    invoke-virtual {v2}, Ljava/lang/Integer;->intValue()I
+
+    move-result v2
+
+    if-ne v2, v1, :cond_7
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isDualDarUser(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_5
+
+    const-string v1, "Secure Mode doesn\'t support for initial DualDAR user anymore"
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    goto :goto_3
+
+    :cond_5
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v2, "No secure mode for user "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    const/4 v2, 0x2
+
+    goto :goto_3
+
+    :cond_6
+    move v2, v3
+
+    :cond_7
+    :goto_3
+    invoke-virtual {p0, p1, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->cacheSecureMode(II)V
+
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetDEBUG()Z
+
+    move-result p0
+
+    if-eqz p0, :cond_8
+
+    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p0
+
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v1
+
+    filled-new-array {p0, v1}, [Ljava/lang/Object;
+
+    move-result-object p0
+
+    const-string v1, "Get - [ Secure Mode : %d, UserId : %d ]"
+
+    invoke-static {v1, p0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {v0, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_8
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p0
+
+    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p1
+
+    filled-new-array {p0, p1}, [Ljava/lang/Object;
+
+    move-result-object p0
+
+    const-string p1, "Secure mode for user %d = %d"
+
+    invoke-static {p1, p0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {v0, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    return v2
+.end method
+
+.method public final getSecureModeForNewSyntheticPassword(I)I
+    .locals 3
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const-string/jumbo v0, "newSyntheticPassword: weaver not supported"
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSpecificProcessRequired(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isDualDarUser(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const/4 v0, 0x2
+
+    goto :goto_0
+
+    :cond_0
+    const/4 v0, 0x0
+
+    :goto_0
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string/jumbo v2, "newSyntheticPassword: sp for user "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string v2, " Secure Mode : "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+
+    invoke-virtual {p0, p1, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->cacheSecureMode(II)V
+
+    return v0
+.end method
+
+.method public final isDualDarUser(I)Z
+    .locals 2
+
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    move-result-wide v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetUserManagerInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/pm/UserManagerInternal;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerInternal;->getUserInfo(I)Landroid/content/pm/UserInfo;
+
+    move-result-object p0
+
+    if-eqz p0, :cond_0
+
+    iget p0, p0, Landroid/content/pm/UserInfo;->flags:I
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    const/high16 p1, 0x6000000
+
+    and-int/2addr p0, p1
+
+    if-eqz p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    return p0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    throw p0
+.end method
+
+.method public final isNeedToEnableSdpMdfppModeForSystem(I)Z
+    .locals 1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetSdpManager(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1;
+
+    invoke-direct {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda1;-><init>(I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    sget-object p1, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {p0, p1}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Ljava/lang/Boolean;
+
+    invoke-virtual {p0}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public final isSdpMdfppMode(I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->getSecureMode(I)I
+
+    move-result p0
+
+    if-lez p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    return p0
+.end method
+
+.method public final isSdpMdfppModeEnabledForSystem(I)Z
+    .locals 1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetSdpManager(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2;
+
+    invoke-direct {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda2;-><init>(I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    sget-object p1, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {p0, p1}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Ljava/lang/Boolean;
+
+    invoke-virtual {p0}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public final isSdpMdfppModeForSystem(I)Z
+    .locals 1
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isNeedToEnableSdpMdfppModeForSystem(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeEnabledForSystem(I)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 p0, 0x1
+
+    :goto_1
+    return p0
+.end method
+
+.method public final isSdpUser(I)Z
+    .locals 2
+
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    move-result-wide v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetUserManagerInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/pm/UserManagerInternal;
+
+    move-result-object p0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerInternal;->getUserInfo(I)Landroid/content/pm/UserInfo;
+
+    move-result-object p0
+
+    if-eqz p0, :cond_0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/DarUtil;->isEnterpriseUser(Landroid/content/pm/UserInfo;)Z
+
+    move-result p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    if-eqz p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
+    const/4 p0, 0x0
+
+    :goto_0
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    return p0
+
+    :catchall_0
+    move-exception p0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    throw p0
+.end method
+
+.method public final isSpecificProcessRequired(I)Z
+    .locals 3
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpUser(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-static {p1}, Landroid/os/UserManager;->isVirtualUserId(I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 v0, 0x0
+
+    goto :goto_1
+
+    :cond_1
+    :goto_0
+    const/4 v0, 0x1
+
+    :goto_1
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string/jumbo v2, "user"
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string v2, " - isSpecificProcessRequired : "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, v0}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+
+    const-string v2, ", is Sdp user? "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpUser(I)Z
+
+    move-result p0
+
+    invoke-virtual {v1, p0}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    return v0
+.end method
+
+.method public pbkdf2([B[BII)[B
+    .locals 0
+
+    invoke-static {p1, p2, p3, p4}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->PBKDF2([B[BII)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public final postDeleteState(Ljava/lang/String;I)V
+    .locals 0
+
+    const-string/jumbo p0, "pwd"
+
+    invoke-virtual {p0, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
+
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deleteCredentialType(I)V
+
+    :cond_0
+    return-void
+.end method
+
+.method public final postReadOrWriteState(Ljava/lang/String;[BI)V
+    .locals 2
+
+    if-eqz p2, :cond_2
+
+    array-length v0, p2
+
+    const/4 v1, 0x4
+
+    if-ge v0, v1, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const-string/jumbo v0, "pwd"
+
+    invoke-virtual {v0, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result p1
+
+    if-eqz p1, :cond_2
+
+    const/4 p1, 0x0
+
+    invoke-static {p2, p1, v1}, Lcom/android/server/knox/dar/sdp/security/BytesUtil;->bytesToInt([BII)I
+
+    move-result p1
+
+    invoke-virtual {p0, p1, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->adjustCredentialType(II)I
+
+    move-result p0
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->validateCredentialType(I)Z
+
+    move-result p1
+
+    if-eqz p1, :cond_1
+
+    invoke-static {p3, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->cacheCredentialType(II)V
+
+    new-instance p1, Ljava/lang/StringBuilder;
+
+    invoke-direct {p1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p2, "Credential type for user "
+
+    invoke-virtual {p1, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string p2, " : "
+
+    invoke-virtual {p1, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1, p0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "SyntheticPasswordManager.SDP"
+
+    invoke-static {p1, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_0
+
+    :cond_1
+    invoke-static {p3}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deleteCredentialType(I)V
+
+    :cond_2
+    :goto_0
+    return-void
+.end method
+
+.method public final unwrapSyntheticPasswordBlobSpecific(JB[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    .locals 18
+
+    move-object/from16 v6, p0
+
+    move-wide/from16 v7, p1
+
+    move-object/from16 v9, p4
+
+    move/from16 v10, p7
+
+    iget-object v0, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    const-string/jumbo v1, "spblob"
+
+    invoke-static {v0, v1, v7, v8, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mloadState(Lcom/android/server/locksettings/SyntheticPasswordManager;Ljava/lang/String;JI)[B
+
+    move-result-object v0
+
+    const/4 v11, 0x0
+
+    if-nez v0, :cond_0
+
+    return-object v11
+
+    :cond_0
+    const/4 v12, 0x0
+
+    aget-byte v13, v0, v12
+
+    const/4 v14, 0x1
+
+    if-lt v13, v14, :cond_f
+
+    const/4 v15, 0x3
+
+    if-gt v13, v15, :cond_f
+
+    aget-byte v5, v0, v14
+
+    move/from16 v1, p3
+
+    if-ne v5, v1, :cond_e
+
+    const/4 v4, 0x2
+
+    aget-byte v3, v0, v4
+
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string/jumbo v2, "unwrapSPBlob with "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, v3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    const-string v2, " for user "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    const-string v2, "SyntheticPasswordManager"
+
+    invoke-static {v2, v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
+
+    if-ne v13, v14, :cond_1
+
+    iget-object v1, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {v1, v7, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetProtectorKeyAlias(Lcom/android/server/locksettings/SyntheticPasswordManager;J)Ljava/lang/String;
+
+    move-result-object v1
+
+    array-length v3, v0
+
+    invoke-static {v0, v4, v3}, Ljava/util/Arrays;->copyOfRange([BII)[B
+
+    move-result-object v0
 
-    move-result v3
+    invoke-static {v1, v0, v9}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decryptBlobV1(Ljava/lang/String;[B[B)[B
 
-    if-eqz v3, :cond_0
+    move-result-object v0
 
-    invoke-virtual {v2}, Ljava/lang/SecurityException;->printStackTrace()V
+    move-object v14, v2
 
-    goto :goto_0
+    move v15, v4
 
-    :cond_0
-    invoke-virtual {v2}, Ljava/lang/SecurityException;->getMessage()Ljava/lang/String;
+    move v12, v5
 
-    move-result-object v2
+    :goto_0
+    move-object v5, v0
 
-    invoke-static {v0, v2}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+    goto :goto_1
 
     :cond_1
-    :goto_0
-    move v2, v1
+    const/16 v1, 0x13
 
-    :goto_1
-    if-ne v2, v1, :cond_7
+    if-ne v13, v4, :cond_2
 
-    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+    iget-object v4, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
-    invoke-virtual {v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverSupported()Z
+    invoke-static {v4, v7, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetProtectorKeyAlias(Lcom/android/server/locksettings/SyntheticPasswordManager;J)Ljava/lang/String;
 
-    move-result v2
+    move-result-object v4
 
-    const/4 v3, 0x0
+    array-length v12, v0
 
-    if-nez v2, :cond_6
+    invoke-static {v0, v1, v12}, Ljava/util/Arrays;->copyOfRange([BII)[B
 
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSpecificProcessRequired(I)Z
+    move-result-object v0
 
-    move-result v2
+    invoke-virtual {v6, v4, v0, v9, v3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->decryptSPBlobV1(Ljava/lang/String;[B[BB)[B
 
-    if-nez v2, :cond_2
+    move-result-object v0
 
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeEnabledForSystem(I)Z
+    move-object v14, v2
 
-    move-result v2
+    move v12, v5
 
-    if-eqz v2, :cond_6
+    const/4 v15, 0x2
+
+    goto :goto_0
 
     :cond_2
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isNeedToEnableSdpMdfppModeForSystem(I)Z
+    iget-object v4, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
-    move-result v2
+    invoke-static {v4, v7, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetProtectorKeyAlias(Lcom/android/server/locksettings/SyntheticPasswordManager;J)Ljava/lang/String;
 
-    const-string v4, " using AOSP SP"
+    move-result-object v4
 
-    if-eqz v2, :cond_3
+    array-length v12, v0
 
-    new-instance v2, Ljava/lang/StringBuilder;
+    invoke-static {v0, v1, v12}, Ljava/util/Arrays;->copyOfRange([BII)[B
 
-    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+    move-result-object v12
 
-    const-string v5, "Secure mode not set yet for System (Device owner) "
+    invoke-virtual/range {p8 .. p8}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAAD()[B
 
-    invoke-virtual {v2, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move-result-object v0
 
-    invoke-virtual {v2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    filled-new-array {v0}, [[B
 
-    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move-result-object v17
 
-    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    move-object/from16 v0, p0
 
-    move-result-object v2
+    move-object v1, v4
 
-    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+    move-object v4, v2
 
-    const/4 v2, 0x1
+    move-object v2, v12
 
-    goto :goto_2
+    move v12, v3
 
-    :cond_3
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeEnabledForSystem(I)Z
+    move-object/from16 v3, p4
 
-    move-result v2
+    move-object v14, v4
 
-    if-eqz v2, :cond_4
+    const/4 v15, 0x2
 
-    new-instance v2, Ljava/lang/StringBuilder;
+    move v4, v12
 
-    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+    move v12, v5
 
-    const-string v5, "Secure mode was set for System (Device owner) "
+    move-object/from16 v5, v17
 
-    invoke-virtual {v2, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual/range {v0 .. v5}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->decryptSPBlob(Ljava/lang/String;[B[BB[[B)[B
 
-    invoke-virtual {v2, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    move-result-object v0
 
-    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    goto :goto_0
 
-    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    :goto_1
+    if-nez v5, :cond_3
 
-    move-result-object v2
+    new-instance v0, Ljava/lang/StringBuilder;
 
-    invoke-static {v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
 
-    :cond_4
-    move v2, v3
+    const-string v1, "Fail to decrypt SP for user "
 
-    :goto_2
-    if-nez v2, :cond_6
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+    invoke-virtual {v0, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-static {v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetLockSettingsInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v2
+    move-result-object v0
 
-    new-instance v3, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;
+    invoke-static {v14, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    invoke-direct {v3, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;-><init>(I)V
+    return-object v11
 
-    invoke-virtual {v2, v3}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+    :cond_3
+    invoke-virtual/range {p8 .. p8}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getSecureMode()I
 
-    move-result-object v2
+    move-result v0
 
-    invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    if-nez v0, :cond_5
 
-    move-result-object v3
+    if-eq v13, v15, :cond_4
 
-    invoke-virtual {v2, v3}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+    const/4 v1, 0x3
 
-    move-result-object v2
+    if-ne v13, v1, :cond_5
 
-    check-cast v2, Ljava/lang/Integer;
+    :cond_4
+    const/16 v16, 0x1
 
-    invoke-virtual {v2}, Ljava/lang/Integer;->intValue()I
+    goto :goto_2
 
-    move-result v2
+    :cond_5
+    const/16 v16, 0x0
 
-    if-ne v2, v1, :cond_7
+    :goto_2
+    if-eqz v16, :cond_6
 
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isDualDarUser(I)Z
+    move v13, v15
+
+    :cond_6
+    invoke-virtual {v6, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpMdfppModeForSystem(I)Z
 
     move-result v1
 
-    if-eqz v1, :cond_5
+    if-eqz v1, :cond_7
 
-    const-string v1, "Secure Mode doesn\'t support for initial DualDAR user anymore"
+    const-string/jumbo v1, "unwrapSyntheticPasswordBlobSpecific: SdpMdfppMode enabled for System when Sp has no secure mode."
 
     invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
+    new-instance v1, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-direct {v1, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;-><init>(B)V
+
+    move-object v3, v1
+
     goto :goto_3
 
-    :cond_5
+    :cond_7
     new-instance v1, Ljava/lang/StringBuilder;
 
     invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v2, "No secure mode for user "
+    const-string/jumbo v2, "unwrapSyntheticPasswordBlobSpecific: secureMode : "
 
     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v1, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
@@ -299,185 +1542,267 @@
 
     invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
-    const/4 v2, 0x2
+    new-instance v1, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
 
-    goto :goto_3
+    invoke-direct {v1, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;-><init>(Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken-IA;)V
 
-    :cond_6
-    move v2, v3
+    invoke-virtual {v1, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->setSecureMode(I)V
+
+    new-instance v2, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-direct {v2, v13, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;-><init>(BLcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;)V
+
+    move-object v3, v2
 
-    :cond_7
     :goto_3
-    invoke-virtual {p0, p1, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->cacheSecureMode(II)V
+    const/4 v1, 0x1
 
-    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetDEBUG()Z
+    if-eq v12, v1, :cond_9
 
-    move-result p0
+    if-ne v12, v15, :cond_8
 
-    if-eqz p0, :cond_8
+    goto :goto_4
 
-    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    :cond_8
+    invoke-virtual {v3, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->recreateDirectly([B)V
 
-    move-result-object p0
+    goto :goto_5
 
-    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    :cond_9
+    :goto_4
+    invoke-virtual {v3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
 
-    move-result-object v1
+    move-result v1
 
-    filled-new-array {p0, v1}, [Ljava/lang/Object;
+    if-nez v1, :cond_a
 
-    move-result-object p0
+    iget-object v1, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
-    const-string v1, "Get - [ Secure Mode : %d, UserId : %d ]"
+    invoke-static {v1, v3, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mloadEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
 
-    invoke-static {v1, p0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+    move-result v1
 
-    move-result-object p0
+    if-nez v1, :cond_a
 
-    invoke-static {v0, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+    new-instance v0, Ljava/lang/StringBuilder;
 
-    :cond_8
-    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
 
-    move-result-object p0
+    const-string v1, "User is not escrowable: "
 
-    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-result-object p1
+    invoke-virtual {v0, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    filled-new-array {p0, p1}, [Ljava/lang/Object;
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object p0
+    move-result-object v0
 
-    const-string p1, "Secure mode for user %d = %d"
+    invoke-static {v14, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    invoke-static {p1, p0}, Ljava/lang/String;->format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
+    return-object v11
 
-    move-result-object p0
+    :cond_a
+    invoke-virtual {v3, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->recreateFromEscrow([B)V
 
-    invoke-static {v0, p0}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+    :goto_5
+    if-nez v0, :cond_c
 
-    return v2
-.end method
+    if-eqz v16, :cond_b
 
-.method public final isDualDarUser(I)Z
-    .locals 2
+    sget-object v0, Ljava/util/Locale;->US:Ljava/util/Locale;
 
-    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+    invoke-static/range {p7 .. p7}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-wide v0
+    move-result-object v1
 
-    :try_start_0
-    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->this$0:Lcom/android/server/locksettings/SyntheticPasswordManager;
+    invoke-static {v12}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
 
-    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetUserManagerInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/pm/UserManagerInternal;
+    move-result-object v2
 
-    move-result-object p0
+    invoke-static {v13}, Ljava/lang/Byte;->valueOf(B)Ljava/lang/Byte;
 
-    invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerInternal;->getUserInfo(I)Landroid/content/pm/UserInfo;
+    move-result-object v4
 
-    move-result-object p0
+    filled-new-array {v1, v2, v4}, [Ljava/lang/Object;
 
-    if-eqz p0, :cond_0
+    move-result-object v1
 
-    iget p0, p0, Landroid/content/pm/UserInfo;->flags:I
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+    const-string v2, "Revert to v2 SP original blob for user %d [ protectorType : %d, prev : %d ]"
 
-    const/high16 p1, 0x6000000
+    invoke-static {v0, v2, v1}, Ljava/lang/String;->format(Ljava/util/Locale;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
 
-    and-int/2addr p0, p1
+    move-result-object v0
 
-    if-eqz p0, :cond_0
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
-    const/4 p0, 0x1
+    iget-object v0, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
-    goto :goto_0
+    const-string/jumbo v1, "spblob"
 
-    :cond_0
-    const/4 p0, 0x0
+    const/4 v2, 0x0
 
-    :goto_0
-    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    move-object v11, v3
 
-    return p0
+    move-wide/from16 v3, p1
 
-    :catchall_0
-    move-exception p0
+    move-object/from16 v16, v5
 
-    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    move/from16 v5, p7
 
-    throw p0
-.end method
+    invoke-static/range {v0 .. v5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$msaveState(Lcom/android/server/locksettings/SyntheticPasswordManager;Ljava/lang/String;[BJI)V
 
-.method public final isNeedToEnableSdpMdfppModeForSystem(I)Z
-    .locals 0
+    iget-object v0, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
 
-    const/4 p0, 0x0
+    move-wide/from16 v1, p1
 
-    return p0
-.end method
+    move v3, v12
 
-.method public final isSdpMdfppMode(I)Z
-    .locals 0
+    move-object v4, v11
 
-    const/4 p0, 0x0
+    move-object/from16 v5, p4
 
-    return p0
-.end method
+    move-wide/from16 v6, p5
 
-.method public final isSdpMdfppModeEnabledForSystem(I)Z
-    .locals 0
+    move/from16 v8, p7
 
-    const/4 p0, 0x0
+    invoke-static/range {v0 .. v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mcreateSyntheticPasswordBlob(Lcom/android/server/locksettings/SyntheticPasswordManager;JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
 
-    return p0
-.end method
+    goto :goto_6
 
-.method public final isSdpUser(I)Z
-    .locals 0
+    :cond_b
+    move-object v11, v3
 
-    const/4 p0, 0x0
+    move-object/from16 v16, v5
 
-    return p0
-.end method
+    goto :goto_6
 
-.method public final isSpecificProcessRequired(I)Z
-    .locals 3
+    :cond_c
+    move-object v11, v3
+
+    move-object/from16 v16, v5
+
+    if-ne v13, v15, :cond_d
 
     new-instance v0, Ljava/lang/StringBuilder;
 
     invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string/jumbo v1, "user"
+    const-string v1, "Upgrade v2 SP blob for user "
 
     invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v0, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    const-string v1, " - isSpecificProcessRequired : "
+    const-string v1, ", protectorType = "
 
     invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    const/4 v1, 0x0
+    invoke-virtual {v0, v12}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    const-string v2, ", is Sdp user? "
+    move-result-object v0
 
-    invoke-virtual {v0, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-static {v14, v0}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
 
-    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->isSdpUser(I)Z
+    move-object/from16 v0, p0
 
-    move-result p0
+    move-wide/from16 v1, p1
 
-    invoke-virtual {v0, p0}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+    move v3, v12
 
-    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    move-object v4, v11
+
+    move-object/from16 v5, p4
+
+    move-wide/from16 v6, p5
+
+    move/from16 v8, p7
+
+    move-object/from16 v9, p8
+
+    invoke-virtual/range {v0 .. v9}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->createSyntheticPasswordBlobSpecific(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
+
+    :cond_d
+    :goto_6
+    invoke-static/range {v16 .. v16}, Lcom/android/server/knox/dar/SecureUtil;->clear([B)V
+
+    return-object v11
+
+    :cond_e
+    new-instance v0, Ljava/lang/RuntimeException;
+
+    const-string v1, "Invalid blob protectorType"
+
+    invoke-direct {v0, v1}, Ljava/lang/RuntimeException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+
+    :cond_f
+    new-instance v0, Ljava/lang/RuntimeException;
+
+    const-string v1, "Unknown blob version"
+
+    invoke-direct {v0, v1}, Ljava/lang/RuntimeException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+.end method
+
+.method public final updateSdpMdfppModeForSystem(IJ)Z
+    .locals 3
+
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    move-result-wide v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->spManager:Lcom/android/server/locksettings/SyntheticPasswordManager;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$mgetSdpManager(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
 
     move-result-object p0
 
-    invoke-static {p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+    new-instance v2, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;
+
+    invoke-direct {v2, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager$$ExternalSyntheticLambda0;-><init>(IJ)V
+
+    invoke-virtual {p0, v2}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+    :try_end_0
+    .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    const/4 p0, 0x1
+
+    return p0
+
+    :catchall_0
+    move-exception p0
+
+    goto :goto_0
 
-    return v1
+    :catch_0
+    move-exception p0
+
+    :try_start_1
+    invoke-virtual {p0}, Ljava/lang/Exception;->printStackTrace()V
+
+    const-string/jumbo p1, "update SdpMdfppMode failed!"
+
+    invoke-static {p1, p0}, Lcom/android/server/knox/dar/sdp/SDPLog;->e(Ljava/lang/String;Ljava/lang/Exception;)V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    const/4 p0, 0x0
+
+    return p0
+
+    :goto_0
+    invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    throw p0
 .end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword.smali
index 1f1fd155e..3ff2c2c8a 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword.smali
@@ -54,6 +54,22 @@
     return-void
 .end method
 
+.method public constructor <init>(BLcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-byte p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mVersion:B
+
+    iput-object p2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    const/4 p1, 0x0
+
+    iput-boolean p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSecureFolderAuthToken:Z
+
+    return-void
+.end method
+
 .method public static create()Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
     .locals 5
 
@@ -90,6 +106,83 @@
     return-object v0
 .end method
 
+.method public static createSdpMdfppMode(I)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    .locals 4
+
+    new-instance v0, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    const/4 v1, 0x0
+
+    invoke-direct {v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;-><init>(Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken-IA;)V
+
+    invoke-virtual {v0, p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->setSecureMode(I)V
+
+    new-instance p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    const/4 v1, 0x3
+
+    invoke-direct {p0, v1, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;-><init>(BLcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;)V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    const-string v0, "SyntheticPasswordManager"
+
+    const-string v1, "createSdpMdfppMode : isSdpMdfppMode Enabled"
+
+    invoke-static {v0, v1}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    const/16 v0, 0x20
+
+    invoke-static {v0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->RBG(I)[B
+
+    move-result-object v1
+
+    if-nez v1, :cond_0
+
+    const-string v1, "SyntheticPasswordManager.SDP"
+
+    const-string v2, "Unexpected failure while generate random sp"
+
+    invoke-static {v1, v2}, Landroid/util/Slog;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-static {v0}, Lcom/android/server/locksettings/SecureRandomUtils;->randomBytes(I)[B
+
+    move-result-object v1
+
+    :cond_0
+    invoke-virtual {p0, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->recreateForSdpMdfpp([B)V
+
+    const/4 v0, 0x1
+
+    new-array v2, v0, [B
+
+    const/4 v3, 0x0
+
+    aput-byte v3, v2, v3
+
+    new-array v0, v0, [B
+
+    aput-byte v3, v0, v3
+
+    invoke-virtual {p0, v2, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->setEscrowData([B[B)V
+
+    invoke-static {v1}, Lcom/android/server/knox/dar/SecureUtil;->clear([B)V
+
+    goto :goto_0
+
+    :cond_1
+    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->create()Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    move-result-object p0
+
+    :goto_0
+    return-object p0
+.end method
+
 
 # virtual methods
 .method public final createSdpToken()V
@@ -116,9 +209,73 @@
     return-void
 .end method
 
+.method public final decodeForSdpMdfpp([B)[B
+    .locals 1
+
+    if-nez p1, :cond_0
+
+    const/4 p0, 0x0
+
+    return-object p0
+
+    :cond_0
+    new-instance p0, Ljava/lang/String;
+
+    sget-object v0, Ljava/nio/charset/StandardCharsets;->UTF_8:Ljava/nio/charset/Charset;
+
+    invoke-direct {p0, p1, v0}, Ljava/lang/String;-><init>([BLjava/nio/charset/Charset;)V
+
+    invoke-virtual {p0}, Ljava/lang/String;->toCharArray()[C
+
+    move-result-object p0
+
+    const/4 p1, 0x1
+
+    invoke-static {p0, p1}, Llibcore/util/HexEncoding;->decode([CZ)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public final deriveDiskEncryptionKeyForSdpMdfpp()[B
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->ensureSdpTokenSyntheticPassword()V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object v0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->getSecureMode()I
+
+    move-result p0
+
+    invoke-static {v0, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateFileSystemKey([BI)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public deriveFileBasedEncryptionKey()[B
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveDiskEncryptionKeyForSdpMdfpp()[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetPERSONALIZATION_FBE_KEY()[B
 
     move-result-object v0
@@ -133,6 +290,19 @@
 .method public deriveGkPassword()[B
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deriveGkPasswordForSdpMdfpp()[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetPERSONALIZATION_SP_GK_AUTH()[B
 
     move-result-object v0
@@ -144,9 +314,44 @@
     return-object p0
 .end method
 
+.method public final deriveGkPasswordForSdpMdfpp()[B
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->ensureSdpTokenSyntheticPassword()V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object v0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->getSecureMode()I
+
+    move-result p0
+
+    invoke-static {v0, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateGatekeeperPassword([BI)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public deriveKeyStorePassword()[B
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->deviceKeystorePasswordForSdpMdfpp()[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetPERSONALIZATION_KEY_STORE_PASSWORD()[B
 
     move-result-object v0
@@ -193,6 +398,31 @@
 .method public deriveSdpMasterKey()[B
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->ensureSdpTokenSyntheticPassword()V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object v0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->getSecureMode()I
+
+    move-result p0
+
+    invoke-static {v0, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateSdpMasterKey([BI)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetPERSONALIZATION_SDP_MASTER_KEY()[B
 
     move-result-object v0
@@ -291,18 +521,82 @@
     return-object p0
 .end method
 
+.method public final deviceKeystorePasswordForSdpMdfpp()[B
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->ensureSdpTokenSyntheticPassword()V
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object v0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->getSecureMode()I
+
+    move-result p0
+
+    invoke-static {v0, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateKeystorePassword([BI)[B
+
+    move-result-object p0
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->bytesToHex([B)[B
+
+    move-result-object v0
+
+    invoke-static {p0}, Lcom/android/server/knox/dar/SecureUtil;->clear([B)V
+
+    return-object v0
+.end method
+
+.method public final ensureSdpTokenSyntheticPassword()V
+    .locals 1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->isDestroyed()Z
+
+    move-result p0
+
+    if-nez p0, :cond_0
+
+    return-void
+
+    :cond_0
+    new-instance p0, Ljava/lang/SecurityException;
+
+    const-string v0, "The object has been already destroyed!"
+
+    invoke-direct {p0, v0}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
+
+    throw p0
+.end method
+
 .method public getEscrowSecret()[B
     .locals 2
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->getSyntheticPassword()[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_0
     iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mEncryptedEscrowSplit0:[B
 
-    if-nez v0, :cond_0
+    if-nez v0, :cond_1
 
     const/4 p0, 0x0
 
     return-object p0
 
-    :cond_0
+    :cond_1
     iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSyntheticPassword:[B
 
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->-$$Nest$sfgetPERSONALIZATION_E0()[B
@@ -345,8 +639,22 @@
 .method public isSdpMdfppMode()Z
     .locals 0
 
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSdpToken:Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;->-$$Nest$fgetsecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationSdpToken;)I
+
+    move-result p0
+
+    if-lez p0, :cond_0
+
+    const/4 p0, 0x1
+
+    goto :goto_0
+
+    :cond_0
     const/4 p0, 0x0
 
+    :goto_0
     return p0
 .end method
 
@@ -388,9 +696,46 @@
     return-void
 .end method
 
+.method public final recreateForSdpMdfpp([B)V
+    .locals 1
+
+    invoke-static {p1}, Llibcore/util/HexEncoding;->encode([B)[C
+
+    move-result-object p1
+
+    invoke-static {p1}, Ljava/lang/String;->valueOf([C)Ljava/lang/String;
+
+    move-result-object p1
+
+    sget-object v0, Ljava/nio/charset/StandardCharsets;->UTF_8:Ljava/nio/charset/Charset;
+
+    invoke-virtual {p1, v0}, Ljava/lang/String;->getBytes(Ljava/nio/charset/Charset;)[B
+
+    move-result-object p1
+
+    iput-object p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mSyntheticPassword:[B
+
+    return-void
+.end method
+
 .method public recreateFromEscrow([B)V
     .locals 1
 
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->decodeForSdpMdfpp([B)[B
+
+    move-result-object p1
+
+    invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->recreateForSdpMdfpp([B)V
+
+    return-void
+
+    :cond_0
     iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->mEscrowSplit1:[B
 
     invoke-static {v0}, Ljava/util/Objects;->requireNonNull(Ljava/lang/Object;)Ljava/lang/Object;
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager.smali
index 5a19d7aaf..f86211702 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordManager.smali
@@ -48,6 +48,8 @@
 # instance fields
 .field public final mContext:Landroid/content/Context;
 
+.field public mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
 .field public mIsWeaverSupported:Z
 
 .field public final mListeners:Landroid/os/RemoteCallbackList;
@@ -56,6 +58,8 @@
 
 .field public mPasswordSlotManager:Lcom/android/server/locksettings/PasswordSlotManager;
 
+.field public mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
 .field public final mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
 .field public mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
@@ -76,6 +80,14 @@
 
 
 # direct methods
+.method public static bridge synthetic -$$Nest$fgetmStorage(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/locksettings/LockSettingsStorage;
+    .locals 0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+
+    return-object p0
+.end method
+
 .method public static bridge synthetic -$$Nest$fgetmWeaver(Lcom/android/server/locksettings/SyntheticPasswordManager;)Landroid/hardware/weaver/IWeaver;
     .locals 0
 
@@ -100,6 +112,14 @@
     return-void
 .end method
 
+.method public static bridge synthetic -$$Nest$mcreateSyntheticPasswordBlob(Lcom/android/server/locksettings/SyntheticPasswordManager;JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
+    .locals 0
+
+    invoke-virtual/range {p0 .. p8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSyntheticPasswordBlob(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
+
+    return-void
+.end method
+
 .method public static bridge synthetic -$$Nest$mgetLockSettingsInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
     .locals 0
 
@@ -110,6 +130,26 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$mgetProtectorKeyAlias(Lcom/android/server/locksettings/SyntheticPasswordManager;J)Ljava/lang/String;
+    .locals 0
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getProtectorKeyAlias(J)Ljava/lang/String;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static bridge synthetic -$$Nest$mgetSdpManager(Lcom/android/server/locksettings/SyntheticPasswordManager;)Ljava/util/Optional;
+    .locals 0
+
+    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static bridge synthetic -$$Nest$mgetUserManagerInternal(Lcom/android/server/locksettings/SyntheticPasswordManager;)Lcom/android/server/pm/UserManagerInternal;
     .locals 0
 
@@ -120,6 +160,34 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$mloadEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
+    .locals 0
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
+
+    move-result p0
+
+    return p0
+.end method
+
+.method public static bridge synthetic -$$Nest$mloadState(Lcom/android/server/locksettings/SyntheticPasswordManager;Ljava/lang/String;JI)[B
+    .locals 0
+
+    invoke-virtual {p0, p1, p2, p3, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadState(Ljava/lang/String;JI)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static bridge synthetic -$$Nest$msaveState(Lcom/android/server/locksettings/SyntheticPasswordManager;Ljava/lang/String;[BJI)V
+    .locals 0
+
+    invoke-virtual/range {p0 .. p5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveState(Ljava/lang/String;[BJI)V
+
+    return-void
+.end method
+
 .method public static bridge synthetic -$$Nest$sfgetDEBUG()Z
     .locals 1
 
@@ -598,7 +666,7 @@
 
 # virtual methods
 .method public addPendingToken([BIILcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;)J
-    .locals 5
+    .locals 6
 
     sget-boolean v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->SECURITY_UNPACK:Z
 
@@ -656,23 +724,23 @@
 
     if-eqz v4, :cond_2
 
-    iget-object v3, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mWeaverConfig:Landroid/hardware/weaver/WeaverConfig;
+    iget-object v4, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mWeaverConfig:Landroid/hardware/weaver/WeaverConfig;
 
-    iget v3, v3, Landroid/hardware/weaver/WeaverConfig;->valueSize:I
+    iget v4, v4, Landroid/hardware/weaver/WeaverConfig;->valueSize:I
 
-    invoke-static {v3}, Lcom/android/server/locksettings/SecureRandomUtils;->randomBytes(I)[B
+    invoke-static {v4}, Lcom/android/server/locksettings/SecureRandomUtils;->randomBytes(I)[B
 
-    move-result-object v3
+    move-result-object v4
 
-    iput-object v3, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->weaverSecret:[B
+    iput-object v4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->weaverSecret:[B
 
-    sget-object v4, Lcom/android/server/locksettings/SyntheticPasswordManager;->PERSONALIZATION_WEAVER_TOKEN:[B
+    sget-object v5, Lcom/android/server/locksettings/SyntheticPasswordManager;->PERSONALIZATION_WEAVER_TOKEN:[B
 
-    invoke-static {v3, v4, p2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt([B[B[B)[B
+    invoke-static {v4, v5, p2}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->encrypt([B[B[B)[B
 
-    move-result-object v3
+    move-result-object v4
 
-    iput-object v3, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->secdiscardableOnDisk:[B
+    iput-object v4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->secdiscardableOnDisk:[B
 
     goto :goto_0
 
@@ -684,20 +752,76 @@
     :goto_0
     invoke-virtual {p0, p1, p2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
 
+    move-result-object p2
+
+    iput-object p2, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->aggregatedSecret:[B
+
+    iput-object p4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mCallback:Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;
+
+    iget-object p2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+
+    move-result p2
+
+    iget-object p4, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {p4, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result p4
+
+    const/4 v4, 0x1
+
+    if-nez p4, :cond_3
+
+    iget-object v5, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v5, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v5
+
+    if-eqz v5, :cond_3
+
+    const-string p2, "addPendingToken for System. Need to enable SdpMdfppMode."
+
+    invoke-static {p2}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    const/4 p2, 0x2
+
+    move p4, v4
+
+    :cond_3
+    if-eqz p4, :cond_4
+
+    const-string p4, "Sdp Mdfpp Mode. set KeyingMaterial"
+
+    invoke-static {p4}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    new-instance p4, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
+
+    invoke-direct {p4, p1, p2, v4}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BIZ)V
+
+    iput-object p4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->km:Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
+
+    invoke-virtual {p4}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAppId()[B
+
     move-result-object p1
 
     iput-object p1, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->aggregatedSecret:[B
 
-    iput-object p4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mCallback:Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;
+    new-array p1, v4, [B
 
-    iget-object p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+    const/4 p2, 0x0
+
+    aput-byte p2, p1, p2
 
-    invoke-static {p1, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+    iput-object p1, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->secdiscardableOnDisk:[B
 
-    iget-object p1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+    iput-object v3, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->weaverSecret:[B
 
-    invoke-static {p1, p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    goto :goto_1
 
+    :cond_4
     const-string p1, "Not Sdp Mdfpp Mode. keyingMaterial null"
 
     invoke-static {p1}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
@@ -708,6 +832,7 @@
 
     iput-object p1, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->km:Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
+    :goto_1
     iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
 
     invoke-static {p3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
@@ -872,7 +997,7 @@
 .end method
 
 .method public createLskfBasedProtector(Landroid/service/gatekeeper/IGateKeeperService;Lcom/android/internal/widget/LockscreenCredential;JLcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)J
-    .locals 17
+    .locals 18
 
     move-object/from16 v0, p0
 
@@ -882,11 +1007,11 @@
 
     move-wide/from16 v3, p3
 
-    move/from16 v10, p7
+    move/from16 v11, p7
 
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager;->generateProtectorId()J
 
-    move-result-wide v11
+    move-result-wide v12
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isAutoPinConfirmationFeatureAvailable()Z
 
@@ -902,7 +1027,7 @@
 
     move-result v6
 
-    invoke-virtual {v0, v5, v6, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->derivePinLength(IZI)I
+    invoke-virtual {v0, v5, v6, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->derivePinLength(IZI)I
 
     move-result v5
 
@@ -914,16 +1039,59 @@
     :goto_0
     iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v6, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+    invoke-static {v6, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
 
     move-result v6
 
     iget-object v7, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v7, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    invoke-static {v7, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
 
     move-result v7
 
+    iget-object v8, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v8, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misNeedToEnableSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v8
+
+    if-eqz v8, :cond_2
+
+    const-string v6, "createLskfBasedProtector for System. Need to enable SdpMdfppMode."
+
+    invoke-static {v6}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v6, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mdeleteSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)V
+
+    iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    const-wide/16 v7, 0x2
+
+    invoke-static {v6, v11, v7, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mupdateSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;IJ)Z
+
+    move-result v6
+
+    if-eqz v6, :cond_1
+
+    const/4 v6, 0x2
+
+    const/4 v7, 0x1
+
+    goto :goto_1
+
+    :cond_1
+    new-instance v0, Ljava/lang/IllegalStateException;
+
+    const-string v1, "Failed to update SdpMdfppMode for System"
+
+    invoke-direct {v0, v1}, Ljava/lang/IllegalStateException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+
+    :cond_2
+    :goto_1
     new-instance v8, Ljava/lang/StringBuilder;
 
     invoke-direct {v8}, Ljava/lang/StringBuilder;-><init>()V
@@ -932,7 +1100,7 @@
 
     invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v8, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v8, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     const-string v9, " secureMode : "
 
@@ -950,139 +1118,141 @@
 
     move-result v8
 
-    const/4 v9, 0x0
-
-    if-eqz v8, :cond_1
+    if-eqz v8, :cond_3
 
     move-object/from16 v8, p5
 
-    move-object v5, v9
+    const/4 v5, 0x0
 
-    goto :goto_1
+    goto :goto_2
 
-    :cond_1
+    :cond_3
     invoke-virtual/range {p5 .. p5}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
 
     move-result v8
 
-    invoke-static {v8, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->create(II)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
+    invoke-static {v8, v5, v6}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->create(III)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
 
     move-result-object v5
 
     move-object/from16 v8, p5
 
-    :goto_1
+    :goto_2
     invoke-virtual {v0, v8, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchLskf(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;)[B
 
-    move-result-object v13
+    move-result-object v10
 
-    if-eqz v7, :cond_2
+    if-eqz v7, :cond_4
 
-    new-instance v7, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
+    new-instance v14, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    invoke-direct {v7, v13, v6}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BI)V
+    invoke-direct {v14, v10, v6}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BI)V
 
-    goto :goto_2
+    goto :goto_3
 
-    :cond_2
+    :cond_4
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getNull()Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    :goto_2
+    move-result-object v14
+
+    :goto_3
     invoke-virtual/range {p5 .. p5}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
     move-result v6
 
-    const-string v7, "User "
-
-    const/4 v14, 0x0
+    const-string v15, "User "
 
-    if-eqz v6, :cond_3
+    if-eqz v6, :cond_5
 
     iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
-    new-instance v15, Ljava/lang/StringBuilder;
+    new-instance v9, Ljava/lang/StringBuilder;
 
-    invoke-direct {v15}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v9}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v15, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v9, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v9, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    const-string v7, ", Lock is None"
+    const-string v15, ", Lock is None"
 
-    invoke-virtual {v15, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v9, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v9}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v7
+    move-result-object v9
 
-    invoke-virtual {v6, v14, v7}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    const/4 v15, 0x0
 
-    goto :goto_3
+    invoke-virtual {v6, v15, v9}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    :cond_3
+    goto :goto_4
+
+    :cond_5
     iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
-    new-instance v15, Ljava/lang/StringBuilder;
+    new-instance v9, Ljava/lang/StringBuilder;
+
+    invoke-direct {v9}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-direct {v15}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-virtual {v9, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v9, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    const-string v15, ", new salt : "
 
-    const-string v7, ", new salt : "
+    invoke-virtual {v9, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    iget-object v15, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
 
-    iget-object v7, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
+    invoke-static {v15}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
 
-    invoke-static {v7}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
+    move-result-object v15
 
-    move-result-object v7
+    invoke-virtual {v9, v15}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v15, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v9}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    invoke-virtual {v15}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    move-result-object v9
 
-    move-result-object v7
+    const/4 v15, 0x0
 
-    invoke-virtual {v6, v14, v7}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    invoke-virtual {v6, v15, v9}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    :goto_3
+    :goto_4
     iget-object v6, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
-    const-string/jumbo v7, "lockscreen.pwdata.ver"
+    const-string/jumbo v9, "lockscreen.pwdata.ver"
 
     sget-object v15, Lcom/android/server/locksettings/LockSettingsServiceLog;->SECURITY_LOG_VERSION:Ljava/lang/String;
 
-    invoke-virtual {v6, v7, v15, v10}, Lcom/android/server/locksettings/LockSettingsStorage;->setString(Ljava/lang/String;Ljava/lang/String;I)V
+    invoke-virtual {v6, v9, v15, v11}, Lcom/android/server/locksettings/LockSettingsStorage;->setString(Ljava/lang/String;Ljava/lang/String;I)V
 
-    invoke-static {v11, v12}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+    invoke-static {v12, v13}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
 
     move-result-object v6
 
     invoke-static/range {p7 .. p7}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v7
+    move-result-object v9
 
-    filled-new-array {v6, v7}, [Ljava/lang/Object;
+    filled-new-array {v6, v9}, [Ljava/lang/Object;
 
     move-result-object v6
 
-    const-string v7, "SyntheticPasswordManager"
+    const-string v9, "SyntheticPasswordManager"
 
     const-string v15, "Creating LSKF-based protector %016x for user %d"
 
-    invoke-static {v7, v15, v6}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v9, v15, v6}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
 
     move-result v6
 
-    const-wide/16 v15, 0x0
+    const-wide/16 v16, 0x0
 
-    if-eqz v6, :cond_5
+    if-eqz v6, :cond_7
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getNextAvailableWeaverSlot()I
 
@@ -1102,37 +1272,44 @@
 
     const-string v3, "Enrolling LSKF for user %d into Weaver slot %d"
 
-    invoke-static {v7, v3, v2}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v9, v3, v2}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
-    invoke-static {v14, v1, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
+    const/4 v2, 0x0
 
-    invoke-virtual {v0, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToWeaverKey([B)[B
+    invoke-static {v2, v1, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
 
-    move-result-object v2
+    invoke-virtual {v0, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToWeaverKey([B)[B
 
-    invoke-virtual {v0, v1, v2, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverEnroll(I[B[B)[B
+    move-result-object v3
 
-    move-result-object v2
+    const/4 v4, 0x0
+
+    invoke-virtual {v0, v1, v3, v4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverEnroll(I[B[B)[B
+
+    move-result-object v3
 
     invoke-static/range {p7 .. p7}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finish(I)V
 
-    if-eqz v2, :cond_4
+    if-eqz v3, :cond_6
 
-    invoke-virtual {v0, v1, v11, v12, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveWeaverSlot(IJI)V
+    invoke-virtual {v0, v1, v12, v13, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveWeaverSlot(IJI)V
 
-    iget-object v3, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mPasswordSlotManager:Lcom/android/server/locksettings/PasswordSlotManager;
+    iget-object v4, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mPasswordSlotManager:Lcom/android/server/locksettings/PasswordSlotManager;
 
-    invoke-virtual {v3, v1}, Lcom/android/server/locksettings/PasswordSlotManager;->markSlotInUse(I)V
+    invoke-virtual {v4, v1}, Lcom/android/server/locksettings/PasswordSlotManager;->markSlotInUse(I)V
 
-    invoke-virtual {v0, v5, v14, v10, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeWeaverFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;III)V
+    invoke-virtual {v0, v5, v2, v11, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeWeaverFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;III)V
 
-    invoke-virtual {v0, v13, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderWeaverSecret([B[B)[B
+    invoke-virtual {v0, v10, v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderWeaverSecret([B[B)[B
 
     move-result-object v1
 
-    goto/16 :goto_8
+    :goto_5
+    move-object v9, v1
 
-    :cond_4
+    goto/16 :goto_c
+
+    :cond_6
     new-instance v1, Ljava/lang/StringBuilder;
 
     invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
@@ -1141,13 +1318,13 @@
 
     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v1, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
     move-result-object v1
 
-    invoke-virtual {v0, v10, v11, v12, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->makeSpmLog(IJLjava/lang/String;)V
+    invoke-virtual {v0, v11, v12, v13, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->makeSpmLog(IJLjava/lang/String;)V
 
     new-instance v0, Ljava/lang/StringBuilder;
 
@@ -1157,7 +1334,7 @@
 
     invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v0, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
@@ -1175,7 +1352,7 @@
 
     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v1, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
@@ -1185,12 +1362,12 @@
 
     throw v0
 
-    :cond_5
+    :cond_7
     invoke-virtual/range {p5 .. p5}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
     move-result v6
 
-    if-nez v6, :cond_a
+    if-nez v6, :cond_d
 
     :try_start_0
     invoke-static/range {p7 .. p7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
@@ -1201,14 +1378,14 @@
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
 
-    goto :goto_4
+    goto :goto_6
 
     :catch_0
     const-string v6, "Failed to clear SID from gatekeeper"
 
-    invoke-static {v7, v6}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v9, v6}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    :goto_4
+    :goto_6
     invoke-static/range {p7 .. p7}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v6
@@ -1217,44 +1394,68 @@
 
     move-result-object v6
 
-    const-string v14, "Enrolling LSKF for user %d into Gatekeeper"
+    const-string v15, "Enrolling LSKF for user %d into Gatekeeper"
 
-    invoke-static {v7, v14, v6}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v9, v15, v6}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
     const-string v6, "Failed to enroll LSKF for new SP protector for user "
 
-    if-eqz v2, :cond_8
+    if-eqz v7, :cond_8
 
     :try_start_1
+    invoke-static/range {p7 .. p7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
+
+    move-result v2
+
+    invoke-virtual {v14}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getGkInput()[B
+
+    move-result-object v3
+
+    const/4 v4, 0x0
+
+    invoke-interface {v1, v2, v4, v4, v3}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+
+    move-result-object v1
+
+    goto :goto_8
+
+    :catch_1
+    move-exception v0
+
+    goto/16 :goto_9
+
+    :cond_8
+    if-eqz v2, :cond_b
+
     invoke-virtual/range {p2 .. p2}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
-    move-result v14
+    move-result v15
 
-    if-nez v14, :cond_8
+    if-nez v15, :cond_b
 
-    cmp-long v14, v3, v15
+    cmp-long v15, v3, v16
 
-    if-eqz v14, :cond_8
+    if-eqz v15, :cond_b
 
-    const-string/jumbo v14, "pwd"
+    const-string/jumbo v15, "pwd"
 
-    invoke-virtual {v0, v14, v3, v4, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadState(Ljava/lang/String;JI)[B
+    invoke-virtual {v0, v15, v3, v4, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadState(Ljava/lang/String;JI)[B
 
     move-result-object v3
 
-    if-eqz v3, :cond_6
+    if-eqz v3, :cond_9
 
     invoke-static {v3}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->fromBytes([B)Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;
 
     move-result-object v3
 
-    goto :goto_5
+    goto :goto_7
 
-    :cond_6
-    move-object v3, v9
+    :cond_9
+    const/4 v3, 0x0
 
-    :goto_5
-    if-eqz v3, :cond_7
+    :goto_7
+    if-eqz v3, :cond_a
 
     invoke-virtual {v0, v2, v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchLskf(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;)[B
 
@@ -1270,56 +1471,60 @@
 
     move-result-object v2
 
-    invoke-virtual {v0, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
+    invoke-virtual {v0, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
 
-    move-result-object v7
+    move-result-object v9
 
-    invoke-interface {v1, v4, v3, v2, v7}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+    invoke-interface {v1, v4, v3, v2, v9}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
 
     move-result-object v1
 
-    goto :goto_6
+    goto :goto_8
 
-    :cond_7
+    :cond_a
     const-string/jumbo v2, "previous pwd is null!"
 
-    invoke-static {v7, v2}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v9, v2}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;)I
 
     invoke-static/range {p7 .. p7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
 
     move-result v2
 
-    invoke-virtual {v0, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
+    invoke-virtual {v0, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
 
     move-result-object v3
 
-    invoke-interface {v1, v2, v9, v9, v3}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+    const/4 v4, 0x0
+
+    invoke-interface {v1, v2, v4, v4, v3}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
 
     move-result-object v1
 
-    goto :goto_6
+    goto :goto_8
 
-    :cond_8
+    :cond_b
     invoke-static/range {p7 .. p7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
 
     move-result v2
 
-    invoke-virtual {v0, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
+    invoke-virtual {v0, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
 
     move-result-object v3
 
-    invoke-interface {v1, v2, v9, v9, v3}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+    const/4 v4, 0x0
+
+    invoke-interface {v1, v2, v4, v4, v3}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
 
     move-result-object v1
     :try_end_1
     .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_1
 
-    :goto_6
+    :goto_8
     invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getResponseCode()I
 
     move-result v2
 
-    if-nez v2, :cond_9
+    if-nez v2, :cond_c
 
     invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getPayload()[B
 
@@ -1329,11 +1534,11 @@
 
     invoke-virtual {v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->sidFromPasswordHandle([B)J
 
-    move-result-wide v15
+    move-result-wide v16
 
-    goto :goto_7
+    goto :goto_a
 
-    :cond_9
+    :cond_c
     new-instance v2, Ljava/lang/StringBuilder;
 
     invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
@@ -1352,7 +1557,7 @@
 
     move-result-object v1
 
-    invoke-virtual {v0, v10, v11, v12, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->makeSpmLog(IJLjava/lang/String;)V
+    invoke-virtual {v0, v11, v12, v13, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->makeSpmLog(IJLjava/lang/String;)V
 
     new-instance v0, Ljava/lang/IllegalStateException;
 
@@ -1362,7 +1567,7 @@
 
     invoke-virtual {v1, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v1, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
@@ -1372,9 +1577,7 @@
 
     throw v0
 
-    :catch_1
-    move-exception v0
-
+    :goto_9
     new-instance v1, Ljava/lang/IllegalStateException;
 
     new-instance v2, Ljava/lang/StringBuilder;
@@ -1383,7 +1586,7 @@
 
     invoke-virtual {v2, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v2, v10}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v11}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
@@ -1393,28 +1596,38 @@
 
     throw v1
 
-    :cond_a
-    :goto_7
-    invoke-virtual {v0, v11, v12, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSecdiscardable(JI)[B
-
+    :cond_d
+    :goto_a
+    if-eqz v7, :cond_e
+
+    invoke-virtual {v14}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAppId()[B
+
+    move-result-object v1
+
+    goto :goto_b
+
+    :cond_e
+    invoke-virtual {v0, v12, v13, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSecdiscardable(JI)[B
+
     move-result-object v1
 
-    invoke-virtual {v0, v13, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
+    invoke-virtual {v0, v10, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
 
     move-result-object v1
 
+    :goto_b
     const/4 v2, 0x0
 
-    invoke-virtual {v0, v5, v2, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeGatekeeperFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;II)V
+    invoke-virtual {v0, v5, v2, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeGatekeeperFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;II)V
 
-    :goto_8
-    move-object v7, v1
+    goto/16 :goto_5
 
+    :goto_c
     invoke-virtual/range {p5 .. p5}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
     move-result v1
 
-    if-nez v1, :cond_b
+    if-nez v1, :cond_f
 
     const-string/jumbo v2, "pwd"
 
@@ -1424,7 +1637,7 @@
 
     move-object/from16 v1, p0
 
-    move-wide v4, v11
+    move-wide v4, v12
 
     move/from16 v6, p7
 
@@ -1436,26 +1649,52 @@
 
     invoke-virtual/range {v1 .. v6}, Lcom/android/server/locksettings/SyntheticPasswordManager;->savePasswordMetrics(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;JI)V
 
-    :cond_b
+    :cond_f
+    if-eqz v7, :cond_10
+
+    iget-object v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    const/4 v4, 0x0
+
+    move-wide v2, v12
+
+    move-object/from16 v5, p6
+
+    move-object v6, v9
+
+    move-wide/from16 v7, v16
+
+    move/from16 v9, p7
+
+    move-object v10, v14
+
+    invoke-static/range {v1 .. v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mcreateSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
+
+    invoke-virtual {v14}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
+
+    goto :goto_d
+
+    :cond_10
     const/4 v4, 0x0
 
     move-object/from16 v1, p0
 
-    move-wide v2, v11
+    move-wide v2, v12
 
     move-object/from16 v5, p6
 
-    move-object v6, v7
+    move-object v6, v9
 
-    move-wide v7, v15
+    move-wide/from16 v7, v16
 
     move/from16 v9, p7
 
     invoke-virtual/range {v1 .. v9}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSyntheticPasswordBlob(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
 
-    invoke-virtual {v0, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
+    :goto_d
+    invoke-virtual {v0, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
 
-    return-wide v11
+    return-wide v12
 .end method
 
 .method public createLskfBasedProtector(Landroid/service/gatekeeper/IGateKeeperService;Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)J
@@ -1584,11 +1823,17 @@
 .end method
 
 .method public createTokenBasedProtector(JLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
-    .locals 11
+    .locals 21
 
-    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
+    move-object/from16 v9, p0
 
-    invoke-static {p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    move-wide/from16 v6, p1
+
+    move/from16 v8, p4
+
+    iget-object v0, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
+
+    invoke-static/range {p4 .. p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v1
 
@@ -1603,9 +1848,9 @@
     return v1
 
     :cond_0
-    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
+    iget-object v0, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
 
-    invoke-static {p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-static/range {p4 .. p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v2
 
@@ -1615,7 +1860,7 @@
 
     check-cast v0, Landroid/util/ArrayMap;
 
-    invoke-static {p1, p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+    invoke-static/range {p1 .. p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
 
     move-result-object v2
 
@@ -1623,168 +1868,247 @@
 
     move-result-object v0
 
-    check-cast v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;
+    move-object v5, v0
 
-    if-nez v0, :cond_1
+    check-cast v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;
+
+    if-nez v5, :cond_1
 
     return v1
 
     :cond_1
-    invoke-virtual {p0, p3, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
+    invoke-virtual/range {p3 .. p3}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->isSdpMdfppMode()Z
 
-    move-result v2
+    move-result v0
 
-    const-string v3, "SyntheticPasswordManager"
+    const-string v2, "SyntheticPasswordManager"
 
-    if-nez v2, :cond_2
+    move-object/from16 v4, p3
 
-    const-string p0, "User is not escrowable"
+    if-nez v0, :cond_2
+
+    invoke-virtual {v9, v4, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)Z
+
+    move-result v0
 
-    invoke-static {v3, p0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    if-nez v0, :cond_2
+
+    const-string/jumbo v0, "user is not escrowable"
+
+    invoke-static {v2, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     return v1
 
     :cond_2
-    invoke-static {p1, p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+    invoke-static/range {p1 .. p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
 
-    move-result-object v2
+    move-result-object v0
 
-    invoke-static {p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-static/range {p4 .. p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v4
+    move-result-object v3
 
-    filled-new-array {v2, v4}, [Ljava/lang/Object;
+    filled-new-array {v0, v3}, [Ljava/lang/Object;
 
-    move-result-object v2
+    move-result-object v0
 
-    const-string v4, "Creating token-based protector %016x for user %d"
+    const-string v3, "Creating token-based protector %016x for user %d"
 
-    invoke-static {v3, v4, v2}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v2, v3, v0}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
-    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
+    invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
 
-    move-result v2
+    move-result v0
 
-    if-eqz v2, :cond_4
+    if-eqz v0, :cond_4
 
-    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getNextAvailableWeaverSlot()I
+    invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getNextAvailableWeaverSlot()I
 
-    move-result v2
+    move-result v0
 
-    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-static {v0}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v4
+    move-result-object v3
 
-    filled-new-array {v4}, [Ljava/lang/Object;
+    filled-new-array {v3}, [Ljava/lang/Object;
 
-    move-result-object v4
+    move-result-object v3
 
-    const-string v5, "Using Weaver slot %d for new token-based protector"
+    const-string v10, "Using Weaver slot %d for new token-based protector"
 
-    invoke-static {v3, v5, v4}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v2, v10, v3}, Lcom/android/server/utils/Slogf;->i(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
-    invoke-static {v1, v2, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
+    invoke-static {v1, v0, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
 
-    const/4 v4, 0x0
+    const/4 v3, 0x0
 
-    iget-object v5, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->weaverSecret:[B
+    iget-object v10, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->weaverSecret:[B
 
-    invoke-virtual {p0, v2, v4, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverEnroll(I[B[B)[B
+    invoke-virtual {v9, v0, v3, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverEnroll(I[B[B)[B
 
-    move-result-object v4
+    move-result-object v3
 
-    if-nez v4, :cond_3
+    if-nez v3, :cond_3
 
-    const-string p0, "Failed to enroll weaver secret when activating token"
+    const-string v3, "Failed to enroll weaver secret when activating token"
 
-    invoke-static {v3, p0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v2, v3}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    new-instance p0, Ljava/lang/StringBuilder;
+    new-instance v2, Ljava/lang/StringBuilder;
 
-    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string p1, "Failed to enroll token for user "
+    const-string v3, "Failed to enroll token for user "
 
-    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {p0, p4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v8}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object p0
+    move-result-object v2
 
-    invoke-static {v2, p0}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finishOff(ILjava/lang/String;)V
+    invoke-static {v0, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finishOff(ILjava/lang/String;)V
 
     return v1
 
     :cond_3
-    invoke-static {p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finish(I)V
+    invoke-static/range {p4 .. p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finish(I)V
 
-    invoke-virtual {p0, v2, p1, p2, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveWeaverSlot(IJI)V
+    invoke-virtual {v9, v0, v6, v7, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveWeaverSlot(IJI)V
 
-    iget-object v1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mPasswordSlotManager:Lcom/android/server/locksettings/PasswordSlotManager;
+    iget-object v1, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mPasswordSlotManager:Lcom/android/server/locksettings/PasswordSlotManager;
 
-    invoke-virtual {v1, v2}, Lcom/android/server/locksettings/PasswordSlotManager;->markSlotInUse(I)V
+    invoke-virtual {v1, v0}, Lcom/android/server/locksettings/PasswordSlotManager;->markSlotInUse(I)V
 
     :cond_4
-    iget-object v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->secdiscardableOnDisk:[B
+    iget-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->secdiscardableOnDisk:[B
 
-    invoke-virtual {p0, p1, p2, v1, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveSecdiscardable(J[BI)V
+    invoke-virtual {v9, v6, v7, v0, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveSecdiscardable(J[BI)V
 
-    iget-object v1, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+    iget-object v0, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v1, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    invoke-static {v0, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
 
-    iget v1, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mType:I
+    move-result v0
 
-    invoke-virtual {p0, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getTokenBasedProtectorType(I)B
+    const/16 v20, 0x1
 
-    move-result v5
+    if-nez v0, :cond_5
 
-    iget-object v7, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->aggregatedSecret:[B
+    iget-object v1, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    const-wide/16 v8, 0x0
+    invoke-static {v1, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
 
-    move-object v2, p0
+    move-result v1
 
-    move-wide v3, p1
+    if-eqz v1, :cond_5
 
-    move-object v6, p3
+    const-string v0, "createTokenBasedProtector for System. Need to enable SdpMdfppMode."
 
-    move v10, p4
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
 
-    invoke-virtual/range {v2 .. v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSyntheticPasswordBlob(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
+    move/from16 v0, v20
 
-    invoke-virtual {p0, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
+    :cond_5
+    if-eqz v0, :cond_6
 
-    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
+    iget-object v10, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    iget v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mType:I
 
-    move-result-object p3
+    invoke-virtual {v9, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getTokenBasedProtectorType(I)B
 
-    invoke-virtual {p0, p3}, Landroid/util/ArrayMap;->get(Ljava/lang/Object;)Ljava/lang/Object;
+    move-result v13
 
-    move-result-object p0
+    iget-object v15, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->aggregatedSecret:[B
 
-    check-cast p0, Landroid/util/ArrayMap;
+    const-wide/16 v16, 0x0
 
-    invoke-static {p1, p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+    iget-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->km:Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    move-result-object p3
+    move-wide/from16 v11, p1
 
-    invoke-virtual {p0, p3}, Landroid/util/ArrayMap;->remove(Ljava/lang/Object;)Ljava/lang/Object;
+    move-object/from16 v14, p3
 
-    iget-object p0, v0, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mCallback:Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;
+    move/from16 v18, p4
 
-    if-eqz p0, :cond_5
+    move-object/from16 v19, v0
 
-    invoke-interface {p0, p1, p2, p4}, Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;->onEscrowTokenActivated(JI)V
+    invoke-static/range {v10 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mcreateSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)V
 
-    :cond_5
-    const/4 p0, 0x1
+    iget-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->km:Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    return p0
+    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
+
+    move-object v13, v5
+
+    move-wide v14, v6
+
+    move v10, v8
+
+    goto :goto_0
+
+    :cond_6
+    iget v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mType:I
+
+    invoke-virtual {v9, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->getTokenBasedProtectorType(I)B
+
+    move-result v3
+
+    iget-object v10, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->aggregatedSecret:[B
+
+    const-wide/16 v11, 0x0
+
+    move-object/from16 v0, p0
+
+    move-wide/from16 v1, p1
+
+    move-object/from16 v4, p3
+
+    move-object v13, v5
+
+    move-object v5, v10
+
+    move-wide v14, v6
+
+    move-wide v6, v11
+
+    move v10, v8
+
+    move/from16 v8, p4
+
+    invoke-virtual/range {v0 .. v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->createSyntheticPasswordBlob(JBLcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;[BJI)V
+
+    :goto_0
+    invoke-virtual {v9, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
+
+    iget-object v0, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->tokenMap:Landroid/util/ArrayMap;
+
+    invoke-static/range {p4 .. p4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v1
+
+    invoke-virtual {v0, v1}, Landroid/util/ArrayMap;->get(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Landroid/util/ArrayMap;
+
+    invoke-static/range {p1 .. p2}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+
+    move-result-object v1
+
+    invoke-virtual {v0, v1}, Landroid/util/ArrayMap;->remove(Ljava/lang/Object;)Ljava/lang/Object;
+
+    iget-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$TokenData;->mCallback:Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;
+
+    if-eqz v0, :cond_7
+
+    invoke-interface {v0, v14, v15, v10}, Lcom/android/internal/widget/LockPatternUtils$EscrowTokenStateChangeCallback;->onEscrowTokenActivated(JI)V
+
+    :cond_7
+    return v20
 .end method
 
 .method public decryptSpBlob(Ljava/lang/String;[B[B)[B
@@ -2023,10 +2347,23 @@
     invoke-virtual {p0, p4, p2, p3, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->makeSpmLog(IJLjava/lang/String;)V
 
     :cond_0
-    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+
+    invoke-virtual {v0, p4, p2, p3, p1}, Lcom/android/server/locksettings/LockSettingsStorage;->deleteSyntheticPasswordState(IJLjava/lang/String;)V
 
-    invoke-virtual {p0, p4, p2, p3, p1}, Lcom/android/server/locksettings/LockSettingsStorage;->deleteSyntheticPasswordState(IJLjava/lang/String;)V
+    iget-object p2, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
+    invoke-static {p2, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpUser(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result p2
+
+    if-eqz p2, :cond_1
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {p0, p1, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mpostDeleteState(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;Ljava/lang/String;I)V
+
+    :cond_1
     return-void
 .end method
 
@@ -2196,12 +2533,48 @@
 .end method
 
 .method public getActiveTokenForDualDar(I[B)[B
-    .locals 0
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSpecificProcessRequired(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+
+    move-result p0
+
+    new-instance p1, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
+
+    const/4 v0, 0x1
+
+    invoke-direct {p1, p2, p0, v0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BIZ)V
+
+    invoke-virtual {p1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAppId()[B
+
+    move-result-object p0
+
+    goto :goto_0
 
+    :cond_0
     invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deriveResetTokenForDualDAR([B)[B
 
     move-result-object p0
 
+    :goto_0
     return-object p0
 .end method
 
@@ -2576,6 +2949,48 @@
     return-object p0
 .end method
 
+.method public final getSdpManager()Ljava/util/Optional;
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    if-nez v0, :cond_1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    if-nez v0, :cond_0
+
+    const-string v0, "dar"
+
+    invoke-static {v0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/DarManagerService;
+
+    iput-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {v0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    :cond_1
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public getSecureMode(JI)I
     .locals 1
 
@@ -3137,35 +3552,46 @@
 .end method
 
 .method public hasEscrowData(I)Z
-    .locals 3
+    .locals 4
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v0
+
+    const/4 v1, 0x1
+
+    if-eqz v0, :cond_0
+
+    return v1
 
+    :cond_0
     const-string v0, "e0"
 
-    const-wide/16 v1, 0x0
+    const-wide/16 v2, 0x0
 
-    invoke-virtual {p0, v0, v1, v2, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasState(Ljava/lang/String;JI)Z
+    invoke-virtual {p0, v0, v2, v3, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasState(Ljava/lang/String;JI)Z
 
     move-result v0
 
-    if-eqz v0, :cond_0
+    if-eqz v0, :cond_1
 
     const-string/jumbo v0, "p1"
 
-    invoke-virtual {p0, v0, v1, v2, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasState(Ljava/lang/String;JI)Z
+    invoke-virtual {p0, v0, v2, v3, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasState(Ljava/lang/String;JI)Z
 
     move-result p0
 
-    if-eqz p0, :cond_0
-
-    const/4 p0, 0x1
+    if-eqz p0, :cond_1
 
     goto :goto_0
 
-    :cond_0
-    const/4 p0, 0x0
+    :cond_1
+    const/4 v1, 0x0
 
     :goto_0
-    return p0
+    return v1
 .end method
 
 .method public hasPasswordData(JI)Z
@@ -3429,8 +3855,29 @@
 .end method
 
 .method public final loadState(Ljava/lang/String;JI)[B
-    .locals 0
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpUser(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+
+    invoke-virtual {v0, p4, p2, p3, p1}, Lcom/android/server/locksettings/LockSettingsStorage;->readSyntheticPasswordState(IJLjava/lang/String;)[B
+
+    move-result-object p2
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
+    invoke-static {p0, p1, p2, p4}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mpostReadOrWriteState(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;Ljava/lang/String;[BI)V
+
+    return-object p2
+
+    :cond_0
     iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
     invoke-virtual {p0, p4, p2, p3, p1}, Lcom/android/server/locksettings/LockSettingsStorage;->readSyntheticPasswordState(IJLjava/lang/String;)[B
@@ -4212,17 +4659,63 @@
 .end method
 
 .method public newSyntheticPassword(I)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
-    .locals 1
+    .locals 8
 
     invoke-virtual {p0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->clearSidForUser(I)V
 
-    invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->create()Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    new-instance v0, Ljava/lang/StringBuilder;
+
+    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string/jumbo v1, "newSyntheticPassword "
+
+    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
     move-result-object v0
 
-    invoke-virtual {p0, v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+    const-string v1, "SyntheticPasswordManager"
 
-    return-object v0
+    invoke-static {v1, v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;Ljava/lang/String;)V
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureModeForNewSyntheticPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+
+    move-result v0
+
+    invoke-static {v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;->createSdpMdfppMode(I)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    move-result-object v7
+
+    const-string/jumbo v1, "userId"
+
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v2
+
+    const-string/jumbo v3, "secureMode"
+
+    invoke-static {v0}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v4
+
+    const-string/jumbo v5, "result"
+
+    move-object v6, v7
+
+    filled-new-array/range {v1 .. v6}, [Ljava/lang/Object;
+
+    move-result-object v0
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->p([Ljava/lang/Object;)V
+
+    invoke-virtual {p0, v7, p1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveEscrowData(Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;I)V
+
+    return-object v7
 .end method
 
 .method public final notifyWeakEscrowTokenRemovedListeners(JI)V
@@ -4542,6 +5035,8 @@
     invoke-static {p0, p1}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     :goto_1
+    invoke-static {p2}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->removeUser(I)V
+
     return-void
 .end method
 
@@ -4664,7 +5159,7 @@
 .end method
 
 .method public final saveState(Ljava/lang/String;[BJI)V
-    .locals 7
+    .locals 9
 
     const-string/jumbo v0, "spblob"
 
@@ -4703,6 +5198,45 @@
 
     invoke-virtual/range {v1 .. v6}, Lcom/android/server/locksettings/LockSettingsStorage;->writeSyntheticPasswordState(IJLjava/lang/String;[B)V
 
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v0, p5}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpUser(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    const-string/jumbo v1, "userId"
+
+    invoke-static {p5}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v2
+
+    const-string/jumbo v3, "protectorId"
+
+    invoke-static {p3, p4}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+
+    move-result-object v4
+
+    const-string/jumbo v5, "stateName"
+
+    const-string v7, "data"
+
+    move-object v6, p1
+
+    move-object v8, p2
+
+    filled-new-array/range {v1 .. v8}, [Ljava/lang/Object;
+
+    move-result-object p3
+
+    invoke-static {p3}, Lcom/android/server/knox/dar/sdp/SDPLog;->p([Ljava/lang/Object;)V
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {p0, p1, p2, p5}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mpostReadOrWriteState(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;Ljava/lang/String;[BI)V
+
+    :cond_1
     return-void
 .end method
 
@@ -4882,7 +5416,30 @@
     :goto_1
     move-object v2, v0
 
-    if-nez p2, :cond_2
+    const/16 v0, 0x20
+
+    if-eqz p2, :cond_2
+
+    invoke-virtual {p2}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->isSdpMdfppMode()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_2
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    iget-object p1, p2, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
+
+    const/16 p2, 0x4000
+
+    invoke-virtual {p0, v2, p1, p2, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->pbkdf2([B[BII)[B
+
+    move-result-object p0
+
+    return-object p0
+
+    :cond_2
+    if-nez p2, :cond_3
 
     invoke-virtual {p1}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
@@ -4890,15 +5447,13 @@
 
     invoke-static {p0}, Lcom/android/internal/util/Preconditions;->checkArgument(Z)V
 
-    const/16 p0, 0x20
-
-    invoke-static {v2, p0}, Ljava/util/Arrays;->copyOf([BI)[B
+    invoke-static {v2, v0}, Ljava/util/Arrays;->copyOf([BI)[B
 
     move-result-object p0
 
     return-object p0
 
-    :cond_2
+    :cond_3
     iget-object v3, p2, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
 
     iget-byte p1, p2, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->scryptLogN:B
@@ -5148,25 +5703,25 @@
 .end method
 
 .method public unlockLskfBasedProtector(Landroid/service/gatekeeper/IGateKeeperService;JLcom/android/internal/widget/LockscreenCredential;ILcom/android/internal/widget/ICheckCredentialProgressCallback;)Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
-    .locals 22
+    .locals 26
 
     move-object/from16 v9, p0
 
-    move-wide/from16 v10, p2
+    move-wide/from16 v7, p2
 
-    move-object/from16 v12, p4
+    move-object/from16 v15, p4
 
-    move/from16 v13, p5
+    move/from16 v14, p5
 
-    new-instance v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
+    new-instance v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
 
-    invoke-direct {v14}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;-><init>()V
+    invoke-direct {v13}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;-><init>()V
 
     const-wide/16 v0, 0x0
 
-    cmp-long v2, v10, v0
+    cmp-long v2, v7, v0
 
-    const-string v7, "SyntheticPasswordManager"
+    const-string v10, "SyntheticPasswordManager"
 
     if-nez v2, :cond_0
 
@@ -5180,18 +5735,18 @@
 
     const-string v1, "Synthetic password not found for user %d"
 
-    invoke-static {v7, v1, v0}, Lcom/android/server/utils/Slogf;->wtf(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v10, v1, v0}, Lcom/android/server/utils/Slogf;->wtf(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v14
+    return-object v13
 
     :cond_0
     const-string/jumbo v2, "pwd"
 
-    invoke-virtual {v9, v2, v10, v11, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadState(Ljava/lang/String;JI)[B
+    invoke-virtual {v9, v2, v7, v8, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadState(Ljava/lang/String;JI)[B
 
     move-result-object v2
 
@@ -5205,19 +5760,19 @@
 
     iget v4, v2, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->credentialType:I
 
-    move-object v8, v2
+    move-object v11, v2
 
     goto :goto_0
 
     :cond_1
     const/4 v2, 0x0
 
-    move-object v8, v2
+    move-object v11, v2
 
     move v4, v3
 
     :goto_0
-    invoke-virtual {v12, v4}, Lcom/android/internal/widget/LockscreenCredential;->checkAgainstStoredType(I)Z
+    invoke-virtual {v15, v4}, Lcom/android/internal/widget/LockscreenCredential;->checkAgainstStoredType(I)Z
 
     move-result v2
 
@@ -5241,60 +5796,64 @@
 
     const-string v1, "Credential type mismatch: stored type is %s but provided type is %s"
 
-    invoke-static {v7, v1, v0}, Lcom/android/server/utils/Slogf;->e(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
+    invoke-static {v10, v1, v0}, Lcom/android/server/utils/Slogf;->e(Ljava/lang/String;Ljava/lang/String;[Ljava/lang/Object;)V
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v14
+    return-object v13
 
     :cond_2
-    invoke-virtual {v9, v12, v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchLskf(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;)[B
+    invoke-virtual {v9, v15, v11}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchLskf(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;)[B
 
-    move-result-object v15
+    move-result-object v12
 
     iget-object v2, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v2, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    invoke-static {v2, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
 
-    move-result v2
+    move-result v6
 
-    new-instance v4, Ljava/lang/StringBuilder;
+    new-instance v2, Ljava/lang/StringBuilder;
 
-    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string/jumbo v5, "unlockLskfBasedProtector isSdpMdfppMode ? "
+    const-string/jumbo v4, "unlockLskfBasedProtector isSdpMdfppMode ? "
 
-    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v4, v2}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v6}, Ljava/lang/StringBuilder;->append(Z)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v4
+    move-result-object v2
 
-    invoke-static {v7, v4}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
+    invoke-static {v10, v2}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;Ljava/lang/String;)V
 
-    if-eqz v2, :cond_3
+    if-eqz v6, :cond_3
 
     new-instance v2, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
     iget-object v4, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v4, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+    invoke-static {v4, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
 
     move-result v4
 
-    invoke-direct {v2, v15, v4}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BI)V
+    invoke-direct {v2, v12, v4}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BI)V
 
     goto :goto_1
 
     :cond_3
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getNull()Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
+    move-result-object v2
+
     :goto_1
-    invoke-virtual {v9, v10, v11, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadWeaverSlot(JI)I
+    move-object/from16 v19, v2
+
+    invoke-virtual {v9, v7, v8, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadWeaverSlot(JI)I
 
     move-result v2
 
@@ -5302,250 +5861,261 @@
 
     const-string v5, ", request salt : "
 
-    const/4 v6, 0x1
+    const/4 v0, 0x1
 
     if-eq v2, v3, :cond_7
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
 
-    move-result v3
+    move-result v1
 
-    if-nez v3, :cond_4
+    if-nez v1, :cond_4
 
-    const-string v0, "Protector uses Weaver, but Weaver is unavailable"
+    const-string v1, "Protector uses Weaver, but Weaver is unavailable"
 
-    invoke-static {v7, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v10, v1}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
-    sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
+    sget-object v1, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v1, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iget-object v0, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+    iget-object v1, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
-    new-instance v1, Ljava/lang/StringBuilder;
+    new-instance v2, Ljava/lang/StringBuilder;
 
-    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v2, "No weaver service to unwrap password based SP!  userid = "
+    const-string v3, "No weaver service to unwrap password based SP!  userid = "
 
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v1
+    move-result-object v2
 
-    invoke-virtual {v0, v6, v1}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    invoke-virtual {v1, v0, v2}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    return-object v14
+    return-object v13
 
     :cond_4
-    invoke-static {v6, v2, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
+    invoke-static {v0, v2, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
 
-    invoke-virtual {v9, v15}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToWeaverKey([B)[B
+    invoke-virtual {v9, v12}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToWeaverKey([B)[B
 
-    move-result-object v3
+    move-result-object v1
 
-    invoke-virtual {v9, v2, v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverVerify(I[B)Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-virtual {v9, v2, v1}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverVerify(I[B)Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    move-result-object v2
+    move-result-object v1
 
-    iput-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v1, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
     invoke-static/range {p5 .. p5}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finish(I)V
 
-    iget-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iget-object v1, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    invoke-virtual {v2}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
+    invoke-virtual {v1}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
 
-    move-result v2
+    move-result v1
 
-    if-eqz v2, :cond_6
+    if-eqz v1, :cond_6
 
-    iget-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iget-object v1, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->getTimeout()I
+    invoke-virtual {v1}, Lcom/android/internal/widget/VerifyCredentialResponse;->getTimeout()I
 
-    move-result v0
+    move-result v1
 
-    new-instance v1, Ljava/lang/StringBuilder;
+    new-instance v2, Ljava/lang/StringBuilder;
 
-    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v1, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    if-nez v8, :cond_5
+    if-nez v11, :cond_5
 
-    const-string/jumbo v2, "null"
+    const-string/jumbo v3, "null"
 
     goto :goto_2
 
     :cond_5
-    iget-object v2, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
+    iget-object v3, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
 
-    invoke-static {v2}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
+    invoke-static {v3}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
 
-    move-result-object v2
+    move-result-object v3
 
     :goto_2
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v1
+    move-result-object v2
 
-    iget-object v2, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
+    iget-object v3, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
-    new-instance v3, Ljava/lang/StringBuilder;
+    new-instance v5, Ljava/lang/StringBuilder;
 
-    invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v5, "Weaver failed!! User "
+    const-string v6, "Weaver failed!! User "
 
-    invoke-virtual {v3, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v0
+    move-result-object v1
 
-    invoke-virtual {v2, v6, v0}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    invoke-virtual {v3, v0, v1}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    return-object v14
+    return-object v13
 
     :cond_6
-    iget-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iget-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    invoke-virtual {v2}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
+    invoke-virtual {v0}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
 
-    move-result-object v2
+    move-result-object v0
 
-    invoke-virtual {v9, v15, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderWeaverSecret([B[B)[B
+    invoke-virtual {v9, v12, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderWeaverSecret([B[B)[B
 
-    move-result-object v2
+    move-result-object v0
 
-    :goto_3
-    move-wide v15, v0
+    move-object v5, v0
 
-    move-object v5, v2
+    move/from16 v20, v6
 
-    goto/16 :goto_9
+    const-wide/16 v15, 0x0
+
+    goto/16 :goto_a
 
     :cond_7
-    if-eqz v8, :cond_e
+    if-eqz v11, :cond_f
 
-    iget-object v2, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iget-object v1, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
-    if-nez v2, :cond_8
+    if-nez v1, :cond_8
 
     goto/16 :goto_7
 
     :cond_8
-    invoke-virtual {v9, v15}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
+    if-eqz v6, :cond_9
 
-    move-result-object v0
+    invoke-virtual/range {v19 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getGkInput()[B
+
+    move-result-object v1
 
+    goto :goto_3
+
+    :cond_9
+    invoke-virtual {v9, v12}, Lcom/android/server/locksettings/SyntheticPasswordManager;->stretchedLskfToGkPassword([B)[B
+
+    move-result-object v1
+
+    :goto_3
     invoke-static/range {p5 .. p5}, Landroid/os/UserManager;->isVirtualUserId(I)Z
 
-    move-result v1
+    move-result v2
 
     const/4 v3, 0x0
 
-    if-eqz v1, :cond_9
+    if-eqz v2, :cond_a
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
 
-    move-result v1
+    move-result v2
 
-    if-eqz v1, :cond_9
+    if-eqz v2, :cond_a
 
-    iget-object v1, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iget-object v2, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
-    if-nez v1, :cond_9
+    if-nez v2, :cond_a
 
-    new-instance v1, Ljava/lang/StringBuilder;
+    new-instance v2, Ljava/lang/StringBuilder;
 
-    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v2, "Virtual User "
+    const-string v0, "Virtual User "
 
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    const-string v2, " may lost weaver slot."
+    const-string v0, " may lost weaver slot."
 
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v1
+    move-result-object v0
 
-    invoke-static {v1}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
+    invoke-static {v0}, Lcom/android/server/knox/dar/sdp/SDPLog;->d(Ljava/lang/String;)V
 
-    new-array v1, v3, [B
+    new-array v0, v3, [B
 
-    iput-object v1, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
-    :cond_9
+    :cond_a
     :try_start_0
     invoke-static/range {p5 .. p5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
 
-    move-result v17
+    move-result v21
 
-    const-wide/16 v18, 0x0
+    const-wide/16 v22, 0x0
 
-    iget-object v1, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iget-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
-    move-object/from16 v16, p1
+    move-object/from16 v20, p1
 
-    move-object/from16 v20, v1
+    move-object/from16 v24, v0
 
-    move-object/from16 v21, v0
+    move-object/from16 v25, v1
 
-    invoke-interface/range {v16 .. v21}, Landroid/service/gatekeeper/IGateKeeperService;->verifyChallenge(IJ[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+    invoke-interface/range {v20 .. v25}, Landroid/service/gatekeeper/IGateKeeperService;->verifyChallenge(IJ[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
 
-    move-result-object v1
+    move-result-object v0
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_2
 
-    invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getResponseCode()I
+    invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getResponseCode()I
 
     move-result v2
 
-    if-nez v2, :cond_c
+    if-nez v2, :cond_d
 
     sget-object v2, Lcom/android/internal/widget/VerifyCredentialResponse;->OK:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v2, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getShouldReEnroll()Z
+    invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getShouldReEnroll()Z
 
-    move-result v1
+    move-result v0
 
-    if-eqz v1, :cond_b
+    if-eqz v0, :cond_c
 
     :try_start_1
     invoke-static/range {p5 .. p5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->fakeUserId(I)I
 
-    move-result v1
+    move-result v0
 
-    iget-object v2, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iget-object v2, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
     :try_end_1
     .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_1
 
-    move-object/from16 v6, p1
+    move-object/from16 v4, p1
 
     :try_start_2
-    invoke-interface {v6, v1, v2, v0, v0}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
+    invoke-interface {v4, v0, v2, v1, v1}, Landroid/service/gatekeeper/IGateKeeperService;->enroll(I[B[B[B)Landroid/service/gatekeeper/GateKeeperResponse;
 
     move-result-object v0
     :try_end_2
@@ -5561,12 +6131,12 @@
     :catch_1
     move-exception v0
 
-    move-object/from16 v6, p1
+    move-object/from16 v4, p1
 
     :goto_4
     const-string v1, "Fail to invoke gatekeeper.enroll"
 
-    invoke-static {v7, v1, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+    invoke-static {v10, v1, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
     sget-object v0, Landroid/service/gatekeeper/GateKeeperResponse;->ERROR:Landroid/service/gatekeeper/GateKeeperResponse;
 
@@ -5575,47 +6145,51 @@
 
     move-result v1
 
-    if-nez v1, :cond_a
+    if-nez v1, :cond_b
 
     invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getPayload()[B
 
     move-result-object v0
 
-    iput-object v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
     invoke-virtual/range {p4 .. p4}, Lcom/android/internal/widget/LockscreenCredential;->getType()I
 
     move-result v0
 
-    iput v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->credentialType:I
+    iput v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->credentialType:I
 
     const-string/jumbo v2, "pwd"
 
-    invoke-virtual {v8}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->toBytes()[B
+    invoke-virtual {v11}, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->toBytes()[B
 
     move-result-object v0
 
     move-object/from16 v1, p0
 
-    move v4, v3
+    move v5, v3
 
     move-object v3, v0
 
-    move v12, v4
+    move v15, v5
 
     move-wide/from16 v4, p2
 
+    move/from16 v20, v6
+
     move/from16 v6, p5
 
     invoke-virtual/range {v1 .. v6}, Lcom/android/server/locksettings/SyntheticPasswordManager;->saveState(Ljava/lang/String;[BJI)V
 
-    invoke-virtual {v9, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
+    invoke-virtual {v9, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
 
-    invoke-virtual {v9, v8, v12, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeGatekeeperFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;II)V
+    invoke-virtual {v9, v11, v15, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->synchronizeGatekeeperFrpPassword(Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;II)V
 
     goto :goto_6
 
-    :cond_a
+    :cond_b
+    move/from16 v20, v6
+
     new-instance v0, Ljava/lang/StringBuilder;
 
     invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
@@ -5624,17 +6198,21 @@
 
     invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v0, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
     move-result-object v0
 
-    invoke-static {v7, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v10, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_6
+
+    :cond_c
+    move/from16 v20, v6
 
-    :cond_b
     :goto_6
-    iget-object v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
+    iget-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->passwordHandle:[B
 
     invoke-virtual {v9, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->sidFromPasswordHandle([B)J
 
@@ -5642,12 +6220,14 @@
 
     goto/16 :goto_8
 
-    :cond_c
-    const-string v0, "gatekeeper failed!! User "
+    :cond_d
+    const-string v1, "gatekeeper failed!! User "
+
+    const/4 v3, 0x1
 
-    if-ne v2, v6, :cond_d
+    if-ne v2, v3, :cond_e
 
-    invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
+    invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
 
     move-result v2
 
@@ -5655,7 +6235,9 @@
 
     move-result-object v2
 
-    iput-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v2, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    invoke-virtual/range {v19 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
 
     iget-object v2, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
@@ -5663,13 +6245,13 @@
 
     invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v3, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v3, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
+    invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
 
     move-result v0
 
@@ -5677,7 +6259,7 @@
 
     invoke-virtual {v3, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    iget-object v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
+    iget-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
 
     invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
 
@@ -5689,14 +6271,18 @@
 
     move-result-object v0
 
-    invoke-virtual {v2, v6, v0}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    const/4 v1, 0x1
 
-    return-object v14
+    invoke-virtual {v2, v1, v0}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    :cond_d
+    return-object v13
+
+    :cond_e
     sget-object v2, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v2, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v2, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+
+    invoke-virtual/range {v19 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
 
     iget-object v2, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mStorage:Lcom/android/server/locksettings/LockSettingsStorage;
 
@@ -5704,13 +6290,13 @@
 
     invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v3, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v3, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v3, v13}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v3, v14}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
     invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v1}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
+    invoke-virtual {v0}, Landroid/service/gatekeeper/GateKeeperResponse;->getTimeout()I
 
     move-result v0
 
@@ -5718,7 +6304,7 @@
 
     invoke-virtual {v3, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    iget-object v0, v8, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
+    iget-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$PasswordData;->salt:[B
 
     invoke-static {v0}, Lcom/android/server/locksettings/LockSettingsServiceLog;->gethashStr([B)Ljava/lang/String;
 
@@ -5730,75 +6316,95 @@
 
     move-result-object v0
 
-    invoke-virtual {v2, v6, v0}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
+    const/4 v1, 0x1
+
+    invoke-virtual {v2, v1, v0}, Lcom/android/server/locksettings/LockSettingsStorage;->addLog(ILjava/lang/String;)V
 
-    return-object v14
+    return-object v13
 
     :catch_2
     move-exception v0
 
     const-string v1, "gatekeeper verify failed"
 
-    invoke-static {v7, v1, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+    invoke-static {v10, v1, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v14
+    return-object v13
 
-    :cond_e
+    :cond_f
     :goto_7
+    move/from16 v20, v6
+
     invoke-virtual/range {p4 .. p4}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
-    move-result v2
+    move-result v0
 
-    if-nez v2, :cond_f
+    if-nez v0, :cond_10
 
     const-string v0, "Missing Gatekeeper password handle for nonempty LSKF"
 
-    invoke-static {v7, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v10, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v14
+    return-object v13
+
+    :cond_10
+    const-wide/16 v0, 0x0
 
-    :cond_f
     :goto_8
-    invoke-virtual {v9, v10, v11, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadSecdiscardable(JI)[B
+    if-eqz v20, :cond_11
+
+    invoke-virtual/range {v19 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAppId()[B
+
+    move-result-object v2
+
+    :goto_9
+    move-wide v15, v0
+
+    move-object v5, v2
+
+    goto :goto_a
+
+    :cond_11
+    invoke-virtual {v9, v7, v8, v14}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadSecdiscardable(JI)[B
 
     move-result-object v2
 
-    if-nez v2, :cond_10
+    if-nez v2, :cond_12
 
     const-string/jumbo v0, "secdiscardable file not found"
 
-    invoke-static {v7, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v10, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v14
+    return-object v13
 
-    :cond_10
-    invoke-virtual {v9, v15, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
+    :cond_12
+    invoke-virtual {v9, v12, v2}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
 
     move-result-object v2
 
-    goto/16 :goto_3
+    goto :goto_9
 
-    :goto_9
-    if-eqz p6, :cond_11
+    :goto_a
+    if-eqz p6, :cond_13
 
     :try_start_3
     invoke-interface/range {p6 .. p6}, Lcom/android/internal/widget/ICheckCredentialProgressCallback;->onCredentialVerified()V
     :try_end_3
     .catch Landroid/os/RemoteException; {:try_start_3 .. :try_end_3} :catch_3
 
-    goto :goto_a
+    goto :goto_b
 
     :catch_3
     move-exception v0
@@ -5807,28 +6413,80 @@
 
     const-string/jumbo v0, "progressCallback throws exception"
 
-    invoke-static {v7, v0, v1}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
+    invoke-static {v10, v0, v1}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
-    :cond_11
-    :goto_a
-    const/4 v4, 0x0
+    :cond_13
+    :goto_b
+    if-eqz v20, :cond_14
+
+    iget-object v10, v9, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    const/4 v0, 0x0
+
+    move-wide/from16 v11, p2
+
+    move-object v6, v13
+
+    move v13, v0
+
+    move v4, v14
+
+    move-object v14, v5
+
+    move/from16 v17, p5
+
+    move-object/from16 v18, v19
+
+    invoke-static/range {v10 .. v18}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$munwrapSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JB[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    move-result-object v0
+
+    iput-object v0, v6, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-virtual/range {v19 .. v19}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
+
+    move v10, v4
+
+    move-object v13, v6
+
+    move-wide v11, v7
+
+    goto :goto_c
+
+    :cond_14
+    move-object v6, v13
+
+    move v4, v14
+
+    const/4 v0, 0x0
 
     move-object/from16 v1, p0
 
     move-wide/from16 v2, p2
 
+    move v10, v4
+
+    move v4, v0
+
+    move-wide v11, v7
+
     move-wide v6, v15
 
     move/from16 v8, p5
 
     invoke-virtual/range {v1 .. v8}, Lcom/android/server/locksettings/SyntheticPasswordManager;->unwrapSyntheticPasswordBlob(JB[BJI)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    move-result-object v3
+    move-result-object v0
+
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    iput-object v3, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    :goto_c
+    iget-object v3, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
     const-wide/16 v4, 0x0
 
+    move-object/from16 v1, p0
+
     move-object/from16 v2, p1
 
     move/from16 v6, p5
@@ -5837,25 +6495,25 @@
 
     move-result-object v0
 
-    iput-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iget-object v0, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    iget-object v0, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    if-eqz v0, :cond_12
+    if-eqz v0, :cond_15
 
     invoke-virtual/range {p4 .. p4}, Lcom/android/internal/widget/LockscreenCredential;->isNone()Z
 
     move-result v0
 
-    if-nez v0, :cond_12
+    if-nez v0, :cond_15
 
-    invoke-virtual {v9, v10, v11, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasPasswordMetrics(JI)Z
+    invoke-virtual {v9, v11, v12, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->hasPasswordMetrics(JI)Z
 
     move-result v0
 
-    if-nez v0, :cond_12
+    if-nez v0, :cond_15
 
-    iget-object v3, v14, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    iget-object v3, v13, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
     move-object/from16 v1, p0
 
@@ -5867,10 +6525,10 @@
 
     invoke-virtual/range {v1 .. v6}, Lcom/android/server/locksettings/SyntheticPasswordManager;->savePasswordMetrics(Lcom/android/internal/widget/LockscreenCredential;Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;JI)V
 
-    invoke-virtual {v9, v13}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
+    invoke-virtual {v9, v10}, Lcom/android/server/locksettings/SyntheticPasswordManager;->syncState(I)V
 
-    :cond_12
-    return-object v14
+    :cond_15
+    return-object v13
 .end method
 
 .method public unlockTokenBasedProtector(Landroid/service/gatekeeper/IGateKeeperService;J[BI)Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
@@ -5913,98 +6571,100 @@
 .end method
 
 .method public final unlockTokenBasedProtectorInternal(Landroid/service/gatekeeper/IGateKeeperService;JB[BI)Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
-    .locals 11
+    .locals 18
 
-    move-object v8, p0
+    move-object/from16 v8, p0
 
-    move-wide v1, p2
+    move-wide/from16 v1, p2
 
-    move/from16 v9, p6
+    move-object/from16 v0, p5
 
-    new-instance v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
+    move/from16 v7, p6
 
-    invoke-direct {v10}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;-><init>()V
+    new-instance v5, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
 
-    invoke-virtual {p0, p2, p3, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadSecdiscardable(JI)[B
+    invoke-direct {v5}, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;-><init>()V
 
-    move-result-object v0
+    invoke-virtual {v8, v1, v2, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadSecdiscardable(JI)[B
 
-    const-string v3, "SyntheticPasswordManager"
+    move-result-object v3
 
-    if-nez v0, :cond_0
+    const-string v4, "SyntheticPasswordManager"
+
+    if-nez v3, :cond_0
 
     const-string/jumbo v0, "secdiscardable file not found"
 
-    invoke-static {v3, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v4, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v10
+    return-object v5
 
     :cond_0
-    invoke-virtual {p0, p2, p3, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadWeaverSlot(JI)I
+    invoke-virtual {v8, v1, v2, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->loadWeaverSlot(JI)I
 
-    move-result v4
+    move-result v6
 
-    const/4 v5, -0x1
+    const/4 v9, -0x1
 
-    if-eq v4, v5, :cond_4
+    const/4 v10, 0x1
 
-    invoke-virtual {p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
+    if-eq v6, v9, :cond_4
 
-    move-result v5
+    invoke-virtual/range {p0 .. p0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->isWeaverAvailable()Z
 
-    if-nez v5, :cond_1
+    move-result v9
+
+    if-nez v9, :cond_1
 
     const-string v0, "Protector uses Weaver, but Weaver is unavailable"
 
-    invoke-static {v3, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v4, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v10
+    return-object v5
 
     :cond_1
-    const/4 v5, 0x1
-
-    invoke-static {v5, v4, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
+    invoke-static {v10, v6, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->begin(III)V
 
-    const/4 v5, 0x0
+    const/4 v9, 0x0
 
-    invoke-virtual {p0, v4, v5}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverVerify(I[B)Lcom/android/internal/widget/VerifyCredentialResponse;
+    invoke-virtual {v8, v6, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager;->weaverVerify(I[B)Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    move-result-object v4
+    move-result-object v6
 
     invoke-static/range {p6 .. p6}, Lcom/android/server/locksettings/SyntheticPasswordManager$WeaverResult;->finish(I)V
 
-    invoke-virtual {v4}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
+    invoke-virtual {v6}, Lcom/android/internal/widget/VerifyCredentialResponse;->getResponseCode()I
 
-    move-result v5
+    move-result v9
 
-    if-nez v5, :cond_3
+    if-nez v9, :cond_3
 
-    invoke-virtual {v4}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
+    invoke-virtual {v6}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
 
-    move-result-object v5
+    move-result-object v9
 
-    if-nez v5, :cond_2
+    if-nez v9, :cond_2
 
     goto :goto_0
 
     :cond_2
-    invoke-virtual {v4}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
+    invoke-virtual {v6}, Lcom/android/internal/widget/VerifyCredentialResponse;->getGatekeeperHAT()[B
 
-    move-result-object v3
+    move-result-object v4
 
-    sget-object v4, Lcom/android/server/locksettings/SyntheticPasswordManager;->PERSONALIZATION_WEAVER_TOKEN:[B
+    sget-object v6, Lcom/android/server/locksettings/SyntheticPasswordManager;->PERSONALIZATION_WEAVER_TOKEN:[B
 
-    invoke-static {v3, v4, v0}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B)[B
+    invoke-static {v4, v6, v3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->decrypt([B[B[B)[B
 
-    move-result-object v0
+    move-result-object v3
 
     goto :goto_1
 
@@ -6012,55 +6672,132 @@
     :goto_0
     const-string v0, "Failed to retrieve Weaver secret when unlocking token-based protector"
 
-    invoke-static {v3, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v4, v0}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    return-object v10
+    return-object v5
 
     :cond_4
     :goto_1
-    iget-object v3, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+    iget-object v4, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v4, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
 
-    invoke-static {v3, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$mgetSecureMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)I
+    move-result v4
 
-    iget-object v3, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+    iget-object v6, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
 
-    invoke-static {v3, v9}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+    invoke-static {v6, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppMode(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
 
+    move-result v6
+
+    if-nez v6, :cond_5
+
+    iget-object v9, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    invoke-static {v9, v7}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$misSdpMdfppModeForSystem(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;I)Z
+
+    move-result v9
+
+    if-eqz v9, :cond_5
+
+    const-string/jumbo v4, "unlockTokenBasedProtector for System. Need to enable SdpMdfppMode."
+
+    invoke-static {v4}, Lcom/android/server/knox/dar/sdp/SDPLog;->i(Ljava/lang/String;)V
+
+    const/4 v4, 0x2
+
+    move v6, v10
+
+    :cond_5
     invoke-static {}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getNull()Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    move-object/from16 v3, p5
+    move-result-object v9
+
+    if-eqz v6, :cond_6
 
-    invoke-virtual {p0, v3, v0}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
+    new-instance v9, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
 
-    move-result-object v4
+    invoke-direct {v9, v0, v4, v10}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;-><init>([BIZ)V
 
-    const-wide/16 v5, 0x0
+    invoke-virtual {v9}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->getAppId()[B
 
-    move-object v0, p0
+    move-result-object v0
+
+    goto :goto_2
+
+    :cond_6
+    invoke-virtual {v8, v0, v3}, Lcom/android/server/locksettings/SyntheticPasswordManager;->transformUnderSecdiscardable([B[B)[B
+
+    move-result-object v0
+
+    :goto_2
+    move-object v13, v0
+
+    move-object v0, v9
+
+    if-eqz v6, :cond_7
+
+    iget-object v9, v8, Lcom/android/server/locksettings/SyntheticPasswordManager;->mSdpSyntheticPasswordManager:Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;
+
+    const-wide/16 v14, 0x0
 
-    move-wide v1, p2
+    move-wide/from16 v10, p2
+
+    move/from16 v12, p4
+
+    move/from16 v16, p6
+
+    move-object/from16 v17, v0
+
+    invoke-static/range {v9 .. v17}, Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;->-$$Nest$munwrapSyntheticPasswordBlobSpecific(Lcom/android/server/locksettings/SyntheticPasswordManager$SdpSyntheticPasswordManager;JB[BJILcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    move-result-object v1
 
-    move v3, p4
+    iput-object v1, v5, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+
+    invoke-virtual {v0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->destroy()V
+
+    move-object v11, v5
+
+    goto :goto_3
+
+    :cond_7
+    const-wide/16 v9, 0x0
+
+    move-object/from16 v0, p0
+
+    move-wide/from16 v1, p2
+
+    move/from16 v3, p4
+
+    move-object v4, v13
+
+    move-object v11, v5
+
+    move-wide v5, v9
 
     move/from16 v7, p6
 
     invoke-virtual/range {v0 .. v7}, Lcom/android/server/locksettings/SyntheticPasswordManager;->unwrapSyntheticPasswordBlob(JB[BJI)Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    move-result-object v2
+    move-result-object v0
+
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    iput-object v2, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
+    :goto_3
+    iget-object v2, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->syntheticPassword:Lcom/android/server/locksettings/SyntheticPasswordManager$SyntheticPassword;
 
-    if-eqz v2, :cond_5
+    if-eqz v2, :cond_8
 
     const-wide/16 v3, 0x0
 
-    move-object v0, p0
+    move-object/from16 v0, p0
 
-    move-object v1, p1
+    move-object/from16 v1, p1
 
     move/from16 v5, p6
 
@@ -6068,24 +6805,24 @@
 
     move-result-object v0
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    if-nez v0, :cond_6
+    if-nez v0, :cond_9
 
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->OK:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    goto :goto_2
+    goto :goto_4
 
-    :cond_5
+    :cond_8
     sget-object v0, Lcom/android/internal/widget/VerifyCredentialResponse;->ERROR:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    iput-object v0, v10, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
+    iput-object v0, v11, Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;->gkResponse:Lcom/android/internal/widget/VerifyCredentialResponse;
 
-    :cond_6
-    :goto_2
-    return-object v10
+    :cond_9
+    :goto_4
+    return-object v11
 .end method
 
 .method public unlockWeakTokenBasedProtector(Landroid/service/gatekeeper/IGateKeeperService;J[BI)Lcom/android/server/locksettings/SyntheticPasswordManager$AuthenticationResult;
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial.smali
index d695e6211..8cf5f08ee 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial.smali
@@ -8,6 +8,12 @@
 
 
 # instance fields
+.field public applicationId:[B
+
+.field public authenticationData:[B
+
+.field public gkInput:[B
+
 .field public pivot:[B
 
 .field public pivotSafe:Z
@@ -48,6 +54,20 @@
     return-void
 .end method
 
+.method public constructor <init>([BIZ)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivot:[B
+
+    iput-boolean p3, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivotSafe:Z
+
+    iput p2, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->secureMode:I
+
+    return-void
+.end method
+
 .method public static getNull()Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;
     .locals 1
 
@@ -55,3 +75,128 @@
 
     return-object v0
 .end method
+
+
+# virtual methods
+.method public destroy()V
+    .locals 3
+
+    const/4 v0, 0x4
+
+    new-array v0, v0, [Ljava/lang/Object;
+
+    iget-boolean v1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivotSafe:Z
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
+    iget-object v1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivot:[B
+
+    :goto_0
+    const/4 v2, 0x0
+
+    aput-object v1, v0, v2
+
+    const/4 v1, 0x1
+
+    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->gkInput:[B
+
+    aput-object v2, v0, v1
+
+    const/4 v1, 0x2
+
+    iget-object v2, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->applicationId:[B
+
+    aput-object v2, v0, v1
+
+    const/4 v1, 0x3
+
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->authenticationData:[B
+
+    aput-object p0, v0, v1
+
+    invoke-static {v0}, Lcom/android/server/knox/dar/SecureUtil;->clearAll([Ljava/lang/Object;)V
+
+    return-void
+.end method
+
+.method public getAAD()[B
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->authenticationData:[B
+
+    if-nez v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivot:[B
+
+    iget v1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->secureMode:I
+
+    invoke-static {v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateAAD([BI)[B
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->authenticationData:[B
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->authenticationData:[B
+
+    return-object p0
+.end method
+
+.method public getAppId()[B
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->applicationId:[B
+
+    if-nez v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivot:[B
+
+    iget v1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->secureMode:I
+
+    invoke-static {v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateAppId([BI)[B
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->applicationId:[B
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->applicationId:[B
+
+    return-object p0
+.end method
+
+.method public getGkInput()[B
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->gkInput:[B
+
+    if-nez v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->pivot:[B
+
+    iget v1, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->secureMode:I
+
+    invoke-static {v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->generateGkInput([BI)[B
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->gkInput:[B
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->gkInput:[B
+
+    return-object p0
+.end method
+
+.method public getSecureMode()I
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$KeyingMaterial;->secureMode:I
+
+    return p0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$Utils.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$Utils.smali
new file mode 100644
index 000000000..dd17e27de
--- /dev/null
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp$Utils.smali
@@ -0,0 +1,38 @@
+.class public abstract Lcom/android/server/locksettings/SyntheticPasswordMdfpp$Utils;
+.super Ljava/lang/Object;
+.source "SyntheticPasswordMdfpp.java"
+
+
+# direct methods
+.method public static varargs extractAAD([[B)[B
+    .locals 1
+
+    const/4 v0, 0x0
+
+    aget-object p0, p0, v0
+
+    return-object p0
+.end method
+
+.method public static varargs hasAAD([[B)Z
+    .locals 3
+
+    const/4 v0, 0x0
+
+    if-eqz p0, :cond_0
+
+    array-length v1, p0
+
+    const/4 v2, 0x1
+
+    if-lt v1, v2, :cond_0
+
+    aget-object p0, p0, v0
+
+    if-eqz p0, :cond_0
+
+    move v0, v2
+
+    :cond_0
+    return v0
+.end method
diff --git a/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp.smali b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp.smali
index 8211a5a6f..932279f8f 100644
--- a/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp.smali
+++ b/smali_classes2/com/android/server/locksettings/SyntheticPasswordMdfpp.smali
@@ -28,6 +28,34 @@
     return-void
 .end method
 
+.method public static cacheCredentialType(II)V
+    .locals 1
+
+    sget-object v0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->mCredentialTypeCache:Landroid/util/SparseArray;
+
+    monitor-enter v0
+
+    :try_start_0
+    invoke-static {p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object p1
+
+    invoke-virtual {v0, p0, p1}, Landroid/util/SparseArray;->put(ILjava/lang/Object;)V
+
+    monitor-exit v0
+
+    return-void
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+.end method
+
 .method public static cacheSecureMode(II)V
     .locals 1
 
@@ -56,6 +84,54 @@
     throw p0
 .end method
 
+.method public static deleteCredentialType(I)V
+    .locals 1
+
+    sget-object v0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->mCredentialTypeCache:Landroid/util/SparseArray;
+
+    monitor-enter v0
+
+    :try_start_0
+    invoke-virtual {v0, p0}, Landroid/util/SparseArray;->delete(I)V
+
+    monitor-exit v0
+
+    return-void
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+.end method
+
+.method public static deleteSecureMode(I)V
+    .locals 1
+
+    sget-object v0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->mSecureModeCache:Landroid/util/SparseArray;
+
+    monitor-enter v0
+
+    :try_start_0
+    invoke-virtual {v0, p0}, Landroid/util/SparseArray;->delete(I)V
+
+    monitor-exit v0
+
+    return-void
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+.end method
+
 .method public static deriveResetTokenForDualDAR([B)[B
     .locals 2
 
@@ -103,6 +179,159 @@
     return-object p0
 .end method
 
+.method public static generateAAD([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForAuthenticationData"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateAppId([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForApplicationId"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateFileSystemKey([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForFileSystem"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateGatekeeperPassword([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForGateKeeper"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateGkInput([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForUserAuthentication"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateKeystorePassword([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForKeyStore"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static generateSdpMasterKey([BI)[B
+    .locals 2
+
+    const-string v0, "KeyEncryptionKey"
+
+    const-string v1, "ForSdpMasterKey"
+
+    invoke-static {p0, p1, v0, v1}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static getCredentialType(I)I
+    .locals 4
+
+    sget-object v0, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->mCredentialTypeCache:Landroid/util/SparseArray;
+
+    monitor-enter v0
+
+    :try_start_0
+    invoke-virtual {v0, p0}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
+
+    move-result-object v1
+
+    check-cast v1, Ljava/lang/Integer;
+
+    if-eqz v1, :cond_0
+
+    invoke-virtual {v1}, Ljava/lang/Integer;->intValue()I
+
+    move-result p0
+
+    monitor-exit v0
+
+    return p0
+
+    :cond_0
+    new-instance v1, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$EmptySlotException;
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v3, "Empty credential type for user "
+
+    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2, p0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    invoke-direct {v1, p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp$EmptySlotException;-><init>(Ljava/lang/String;)V
+
+    throw v1
+
+    :catchall_0
+    move-exception p0
+
+    monitor-exit v0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw p0
+.end method
+
 .method public static getSecureMode(I)I
     .locals 4
 
@@ -157,3 +386,52 @@
 
     throw p0
 .end method
+
+.method public static personalize([BILjava/lang/String;Ljava/lang/String;)[B
+    .locals 0
+
+    invoke-static {p0, p1, p2, p3}, Lcom/android/server/locksettings/SyntheticPasswordCrypto;->personalize([BILjava/lang/String;Ljava/lang/String;)[B
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static removeUser(I)V
+    .locals 0
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deleteSecureMode(I)V
+
+    invoke-static {p0}, Lcom/android/server/locksettings/SyntheticPasswordMdfpp;->deleteCredentialType(I)V
+
+    return-void
+.end method
+
+.method public static validateCredentialType(I)Z
+    .locals 2
+
+    const/4 v0, 0x4
+
+    const/4 v1, 0x1
+
+    if-eq p0, v0, :cond_1
+
+    const/4 v0, 0x3
+
+    if-eq p0, v0, :cond_1
+
+    if-eq p0, v1, :cond_1
+
+    const/4 v0, -0x1
+
+    if-ne p0, v0, :cond_0
+
+    goto :goto_0
+
+    :cond_0
+    const/4 v1, 0x0
+
+    :cond_1
+    :goto_0
+    return v1
+.end method
diff --git a/smali_classes3/com/android/server/pm/PackageManagerService$IPackageManagerImpl.smali b/smali_classes3/com/android/server/pm/PackageManagerService$IPackageManagerImpl.smali
index cd9013be8..8d85aa587 100644
--- a/smali_classes3/com/android/server/pm/PackageManagerService$IPackageManagerImpl.smali
+++ b/smali_classes3/com/android/server/pm/PackageManagerService$IPackageManagerImpl.smali
@@ -2144,7 +2144,11 @@
 .method public createEncAppData(Ljava/lang/String;I)Z
     .locals 0
 
-    const/4 p0, 0x0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/pm/PackageManagerService;->createEncAppData(Ljava/lang/String;I)Z
+
+    move-result p0
 
     return p0
 .end method
@@ -6774,7 +6778,11 @@
 .method public removeEncPkgDir(ILjava/lang/String;)Z
     .locals 0
 
-    const/4 p0, 0x0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/pm/PackageManagerService;->removeEncPkgDir(ILjava/lang/String;)Z
+
+    move-result p0
 
     return p0
 .end method
@@ -6782,7 +6790,11 @@
 .method public removeEncUserDir(I)Z
     .locals 0
 
-    const/4 p0, 0x0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService$IPackageManagerImpl;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/PackageManagerService;->removeEncUserDir(I)Z
+
+    move-result p0
 
     return p0
 .end method
diff --git a/smali_classes3/com/android/server/pm/PackageManagerService.smali b/smali_classes3/com/android/server/pm/PackageManagerService.smali
index 99b18d9dc..8a107c251 100644
--- a/smali_classes3/com/android/server/pm/PackageManagerService.smali
+++ b/smali_classes3/com/android/server/pm/PackageManagerService.smali
@@ -8499,6 +8499,77 @@
     throw p0
 .end method
 
+.method public createEncAppData(Ljava/lang/String;I)Z
+    .locals 6
+
+    invoke-virtual {p0}, Lcom/android/server/pm/PackageManagerService;->snapshotComputer()Lcom/android/server/pm/Computer;
+
+    move-result-object v0
+
+    const-wide/16 v2, 0x0
+
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+
+    move-result v4
+
+    move-object v1, p1
+
+    move v5, p2
+
+    invoke-interface/range {v0 .. v5}, Lcom/android/server/pm/Computer;->getApplicationInfoInternal(Ljava/lang/String;JII)Landroid/content/pm/ApplicationInfo;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    if-nez v0, :cond_0
+
+    new-instance p0, Ljava/lang/StringBuilder;
+
+    invoke-direct {p0}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string p2, "No application info: "
+
+    invoke-virtual {p0, p2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0, p1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    invoke-virtual {p0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object p0
+
+    const-string p1, "PackageManager"
+
+    invoke-static {p1, p0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    return v1
+
+    :cond_0
+    iget v2, v0, Landroid/content/pm/ApplicationInfo;->uid:I
+
+    invoke-static {v2}, Landroid/os/UserHandle;->getAppId(I)I
+
+    move-result v2
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
+
+    iget v0, v0, Landroid/content/pm/ApplicationInfo;->targetSdkVersion:I
+
+    invoke-virtual {p0, p1, p2, v2, v0}, Lcom/android/server/pm/Installer;->createEncAppData(Ljava/lang/String;III)Z
+
+    move-result p0
+    :try_end_0
+    .catch Lcom/android/server/pm/Installer$InstallerException; {:try_start_0 .. :try_end_0} :catch_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    return p0
+
+    :catch_0
+    :catchall_0
+    return v1
+.end method
+
 .method public final createLiveComputer()Lcom/android/server/pm/ComputerLocked;
     .locals 3
 
@@ -15166,6 +15237,96 @@
     return-void
 .end method
 
+.method public removeEncPkgDir(ILjava/lang/String;)Z
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mInstallLock:Ljava/lang/Object;
+
+    monitor-enter v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
+
+    invoke-virtual {p0, p1, p2}, Lcom/android/server/pm/Installer;->removeEncPkgDir(ILjava/lang/String;)Z
+
+    move-result p0
+    :try_end_0
+    .catch Lcom/android/server/pm/Installer$InstallerException; {:try_start_0 .. :try_end_0} :catch_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    goto :goto_1
+
+    :catch_0
+    move-exception p0
+
+    :try_start_1
+    invoke-virtual {p0}, Ljava/lang/Exception;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    monitor-exit v0
+
+    return p0
+
+    :goto_1
+    monitor-exit v0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    throw p0
+.end method
+
+.method public removeEncUserDir(I)Z
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mInstallLock:Ljava/lang/Object;
+
+    monitor-enter v0
+
+    :try_start_0
+    iget-object p0, p0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/Installer;->removeEncUserDir(I)Z
+
+    move-result p0
+    :try_end_0
+    .catch Lcom/android/server/pm/Installer$InstallerException; {:try_start_0 .. :try_end_0} :catch_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    goto :goto_0
+
+    :catchall_0
+    move-exception p0
+
+    goto :goto_1
+
+    :catch_0
+    move-exception p0
+
+    :try_start_1
+    invoke-virtual {p0}, Ljava/lang/Exception;->printStackTrace()V
+
+    const/4 p0, 0x0
+
+    :goto_0
+    monitor-exit v0
+
+    return p0
+
+    :goto_1
+    monitor-exit v0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    throw p0
+.end method
+
 .method public requestChecksumsInternal(Lcom/android/server/pm/Computer;Ljava/lang/String;ZIILjava/util/List;Landroid/content/pm/IOnChecksumsReadyListener;ILjava/util/concurrent/Executor;Landroid/os/Handler;)V
     .locals 12
 
diff --git a/smali_classes3/com/android/server/pm/RemovePackageHelper.smali b/smali_classes3/com/android/server/pm/RemovePackageHelper.smali
index b5ef9e9e6..e4d85f53e 100644
--- a/smali_classes3/com/android/server/pm/RemovePackageHelper.smali
+++ b/smali_classes3/com/android/server/pm/RemovePackageHelper.smali
@@ -1346,7 +1346,105 @@
 .end method
 
 .method public final removeSdpPackageDir(Lcom/android/server/pm/PackageRemovedInfo;)V
-    .locals 0
+    .locals 4
+
+    if-eqz p1, :cond_4
+
+    iget-boolean v0, p1, Lcom/android/server/pm/PackageRemovedInfo;->mIsUpdate:Z
+
+    const-string v1, "PackageManager.SDP"
+
+    if-nez v0, :cond_0
+
+    iget-boolean v0, p1, Lcom/android/server/pm/PackageRemovedInfo;->mIsRemovedPackageSystemUpdate:Z
+
+    if-eqz v0, :cond_1
+
+    :cond_0
+    iget-boolean v0, p1, Lcom/android/server/pm/PackageRemovedInfo;->mDataRemoved:Z
+
+    if-nez v0, :cond_1
+
+    const-string p0, "Skip removing package directory"
+
+    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_0
+
+    :cond_1
+    const-string v0, "Try removing package directory"
+
+    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    const-string v0, "dar"
+
+    invoke-static {v0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/DarManagerService;
+
+    if-eqz v0, :cond_3
+
+    invoke-virtual {v0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v2
+
+    if-eqz v2, :cond_3
+
+    invoke-virtual {v0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v0
 
+    iget v2, p1, Lcom/android/server/pm/PackageRemovedInfo;->mUid:I
+
+    invoke-static {v2}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v2
+
+    iget-object v3, p1, Lcom/android/server/pm/PackageRemovedInfo;->mRemovedPackage:Ljava/lang/String;
+
+    invoke-virtual {v0, v2, v3}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->isSdpPackage(ILjava/lang/String;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_3
+
+    iget-object p0, p0, Lcom/android/server/pm/RemovePackageHelper;->mPm:Lcom/android/server/pm/PackageManagerService;
+
+    iget v0, p1, Lcom/android/server/pm/PackageRemovedInfo;->mUid:I
+
+    invoke-static {v0}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v0
+
+    iget-object p1, p1, Lcom/android/server/pm/PackageRemovedInfo;->mRemovedPackage:Ljava/lang/String;
+
+    invoke-virtual {p0, v0, p1}, Lcom/android/server/pm/PackageManagerService;->removeEncPkgDir(ILjava/lang/String;)Z
+
+    move-result p0
+
+    if-eqz p0, :cond_2
+
+    const-string p0, "Successfully removed Sdp package directory!"
+
+    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_0
+
+    :cond_2
+    const-string p0, "Failed to removed Sdp package directory..."
+
+    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_0
+
+    :cond_3
+    const-string/jumbo p0, "not Sdp package..."
+
+    invoke-static {v1, p0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    :cond_4
+    :goto_0
     return-void
 .end method
diff --git a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda6.smali b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda6.smali
index 0735bcbeb..16a2ff78a 100644
--- a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda6.smali
+++ b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda6.smali
@@ -3,44 +3,34 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Lcom/android/internal/util/FunctionalUtils$ThrowingRunnable;
+.implements Ljava/util/function/Consumer;
 
 
 # instance fields
-.field public final synthetic f$0:Lcom/android/server/pm/UserManagerService;
-
-.field public final synthetic f$1:Landroid/content/pm/UserInfo;
-
-.field public final synthetic f$2:Ljava/lang/Object;
+.field public final synthetic f$0:I
 
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
+.method public synthetic constructor <init>(I)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
-    iput-object p1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$0:Lcom/android/server/pm/UserManagerService;
-
-    iput-object p2, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$1:Landroid/content/pm/UserInfo;
-
-    iput-object p3, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$2:Ljava/lang/Object;
+    iput p1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$0:I
 
     return-void
 .end method
 
 
 # virtual methods
-.method public final runOrThrow()V
-    .locals 2
-
-    iget-object v0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$0:Lcom/android/server/pm/UserManagerService;
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
 
-    iget-object v1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$1:Landroid/content/pm/UserInfo;
+    iget p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$0:I
 
-    iget-object p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;->f$2:Ljava/lang/Object;
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
 
-    invoke-static {v0, v1, p0}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$yyPAeScVE75zLpsNl4w1GusRU_4(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
+    invoke-static {p0, p1}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$4kvZtyNq_IB9Hmq6i67wYqc5HNI(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
 
     return-void
 .end method
diff --git a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda7.smali b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda7.smali
index 787942535..2e44fdb52 100644
--- a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda7.smali
+++ b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda7.smali
@@ -3,34 +3,44 @@
 .source "R8$$SyntheticClass"
 
 # interfaces
-.implements Landroid/app/StatsManager$StatsPullAtomCallback;
+.implements Lcom/android/internal/util/FunctionalUtils$ThrowingRunnable;
 
 
 # instance fields
 .field public final synthetic f$0:Lcom/android/server/pm/UserManagerService;
 
+.field public final synthetic f$1:Landroid/content/pm/UserInfo;
+
+.field public final synthetic f$2:Ljava/lang/Object;
+
 
 # direct methods
-.method public synthetic constructor <init>(Lcom/android/server/pm/UserManagerService;)V
+.method public synthetic constructor <init>(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
     .locals 0
 
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V
 
     iput-object p1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$0:Lcom/android/server/pm/UserManagerService;
 
+    iput-object p2, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$1:Landroid/content/pm/UserInfo;
+
+    iput-object p3, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$2:Ljava/lang/Object;
+
     return-void
 .end method
 
 
 # virtual methods
-.method public final onPullAtom(ILjava/util/List;)I
-    .locals 0
+.method public final runOrThrow()V
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$0:Lcom/android/server/pm/UserManagerService;
 
-    iget-object p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$0:Lcom/android/server/pm/UserManagerService;
+    iget-object v1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$1:Landroid/content/pm/UserInfo;
 
-    invoke-static {p0, p1, p2}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$GDCoZapEtTsnmO5b-65d4lG89TA(Lcom/android/server/pm/UserManagerService;ILjava/util/List;)I
+    iget-object p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;->f$2:Ljava/lang/Object;
 
-    move-result p0
+    invoke-static {v0, v1, p0}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$yyPAeScVE75zLpsNl4w1GusRU_4(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
 
-    return p0
+    return-void
 .end method
diff --git a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda8.smali b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda8.smali
new file mode 100644
index 000000000..690602a57
--- /dev/null
+++ b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda8.smali
@@ -0,0 +1,38 @@
+.class public final synthetic Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda8;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Function;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda8;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final apply(Ljava/lang/Object;)Ljava/lang/Object;
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda8;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    invoke-static {p0, p1}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$1JHDdFcWXET1pec83uKKpwir8tg(ILcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
diff --git a/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda9.smali b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda9.smali
new file mode 100644
index 000000000..fe363849a
--- /dev/null
+++ b/smali_classes3/com/android/server/pm/UserManagerService$$ExternalSyntheticLambda9.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Landroid/app/StatsManager$StatsPullAtomCallback;
+
+
+# instance fields
+.field public final synthetic f$0:Lcom/android/server/pm/UserManagerService;
+
+
+# direct methods
+.method public synthetic constructor <init>(Lcom/android/server/pm/UserManagerService;)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput-object p1, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;->f$0:Lcom/android/server/pm/UserManagerService;
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final onPullAtom(ILjava/util/List;)I
+    .locals 0
+
+    iget-object p0, p0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;->f$0:Lcom/android/server/pm/UserManagerService;
+
+    invoke-static {p0, p1, p2}, Lcom/android/server/pm/UserManagerService;->$r8$lambda$GDCoZapEtTsnmO5b-65d4lG89TA(Lcom/android/server/pm/UserManagerService;ILjava/util/List;)I
+
+    move-result p0
+
+    return p0
+.end method
diff --git a/smali_classes3/com/android/server/pm/UserManagerService.smali b/smali_classes3/com/android/server/pm/UserManagerService.smali
index ba9f38137..0f2e63572 100644
--- a/smali_classes3/com/android/server/pm/UserManagerService.smali
+++ b/smali_classes3/com/android/server/pm/UserManagerService.smali
@@ -134,6 +134,24 @@
 
 
 # direct methods
+.method public static synthetic $r8$lambda$1JHDdFcWXET1pec83uKKpwir8tg(ILcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/pm/UserManagerService;->lambda$setSdpPolicy$8(ILcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public static synthetic $r8$lambda$4kvZtyNq_IB9Hmq6i67wYqc5HNI(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/pm/UserManagerService;->lambda$createUserInternalUncheckedNoTracing$5(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
 .method public static synthetic $r8$lambda$EcDEho9HyNuyPAj6l6_-Lp_QE38(Ljava/lang/String;ZIILjava/lang/String;)V
     .locals 0
 
@@ -1948,6 +1966,14 @@
     return-void
 .end method
 
+.method public static synthetic lambda$createUserInternalUncheckedNoTracing$5(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->welcomeNewUser(I)V
+
+    return-void
+.end method
+
 .method private synthetic lambda$getUserFile$4(IILjava/lang/String;)V
     .locals 0
 
@@ -1979,6 +2005,20 @@
     return-void
 .end method
 
+.method public static synthetic lambda$setSdpPolicy$8(ILcom/android/server/knox/dar/sdp/SdpManagerInternal;)Ljava/lang/Boolean;
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;->setSdpPolicy(I)Z
+
+    move-result p0
+
+    invoke-static {p0}, Ljava/lang/Boolean;->valueOf(Z)Ljava/lang/Boolean;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static synthetic lambda$setUserRestriction$1(Ljava/lang/String;ZIILjava/lang/String;)V
     .locals 2
 
@@ -4385,9 +4425,9 @@
 
     invoke-virtual {p0}, Lcom/android/server/pm/UserManagerService;->updateUserIds()V
 
-    new-instance p1, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;
+    new-instance p1, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;
 
-    invoke-direct {p1, p0, v2, p4}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;-><init>(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
+    invoke-direct {p1, p0, v2, p4}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;-><init>(Lcom/android/server/pm/UserManagerService;Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
 
     invoke-static {p1}, Landroid/os/Binder;->withCleanCallingIdentity(Lcom/android/internal/util/FunctionalUtils$ThrowingRunnable;)V
 
@@ -4843,7 +4883,7 @@
 .end method
 
 .method public final createUserInternalUncheckedNoTracing(Ljava/lang/String;Ljava/lang/String;IIZ[Ljava/lang/String;Lcom/android/server/utils/TimingsTraceAndSlog;Ljava/lang/Object;)Landroid/content/pm/UserInfo;
-    .locals 29
+    .locals 30
 
     move-object/from16 v1, p0
 
@@ -5227,24 +5267,40 @@
     if-eqz v22, :cond_13
 
     :cond_12
-    move/from16 v22, v13
+    move/from16 v23, v13
 
     goto :goto_8
 
     :cond_13
-    const/16 v22, 0x0
+    const/16 v23, 0x0
 
     :goto_8
-    if-eqz v12, :cond_14
+    if-eqz v20, :cond_14
 
-    const/high16 v23, 0x40000
+    if-nez v12, :cond_14
 
-    or-int v7, v7, v23
+    if-nez v22, :cond_14
+
+    if-nez v19, :cond_14
+
+    move/from16 v22, v13
+
+    goto :goto_9
 
     :cond_14
+    const/16 v22, 0x0
+
+    :goto_9
+    if-eqz v12, :cond_15
+
+    const/high16 v24, 0x40000
+
+    or-int v7, v7, v24
+
+    :cond_15
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
-    move-result-wide v23
+    move-result-wide v24
 
     :try_start_1
     iget-object v10, v1, Lcom/android/server/pm/UserManagerService;->mPackagesLock:Ljava/lang/Object;
@@ -5255,7 +5311,7 @@
 
     const/16 v13, -0x2710
 
-    if-eq v2, v13, :cond_16
+    if-eq v2, v13, :cond_17
 
     :try_start_2
     iget-object v13, v1, Lcom/android/server/pm/UserManagerService;->mUsersLock:Ljava/lang/Object;
@@ -5267,13 +5323,13 @@
     :try_start_3
     invoke-virtual {v1, v2}, Lcom/android/server/pm/UserManagerService;->getUserDataLU(I)Lcom/android/server/pm/UserManagerService$UserData;
 
-    move-result-object v25
+    move-result-object v26
 
     monitor-exit v13
     :try_end_3
     .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
-    if-nez v25, :cond_15
+    if-nez v26, :cond_16
 
     :try_start_4
     new-instance v13, Ljava/lang/StringBuilder;
@@ -5296,10 +5352,10 @@
     :try_end_4
     .catchall {:try_start_4 .. :try_end_4} :catchall_1
 
-    :cond_15
-    move-object/from16 v5, v25
+    :cond_16
+    move-object/from16 v5, v26
 
-    goto :goto_a
+    goto :goto_b
 
     :catchall_0
     move-exception v0
@@ -5315,34 +5371,34 @@
     :catchall_1
     move-exception v0
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
     const/4 v9, 0x0
 
-    :goto_9
+    :goto_a
     const/4 v12, 0x0
 
-    goto/16 :goto_1e
+    goto/16 :goto_1f
 
-    :cond_16
+    :cond_17
     const/4 v5, 0x0
 
-    :goto_a
-    if-nez v3, :cond_17
+    :goto_b
+    if-nez v3, :cond_18
 
     invoke-virtual {v1, v6}, Lcom/android/server/pm/UserManagerService;->canAddMoreUsersOfType(Lcom/android/server/pm/UserTypeDetails;)Z
 
     move-result v13
 
-    if-nez v13, :cond_17
+    if-nez v13, :cond_18
 
-    if-nez v15, :cond_17
+    if-nez v15, :cond_18
 
     new-instance v13, Ljava/lang/StringBuilder;
 
     invoke-direct {v13}, Ljava/lang/StringBuilder;-><init>()V
 
-    move/from16 v25, v14
+    move/from16 v26, v14
 
     const-string v14, "Cannot add more users of type "
 
@@ -5362,29 +5418,29 @@
 
     invoke-virtual {v1, v13, v14}, Lcom/android/server/pm/UserManagerService;->throwCheckedUserOperationException(Ljava/lang/String;I)V
 
-    goto :goto_b
+    goto :goto_c
 
-    :cond_17
-    move/from16 v25, v14
+    :cond_18
+    move/from16 v26, v14
 
-    :goto_b
-    if-nez v17, :cond_18
+    :goto_c
+    if-nez v17, :cond_19
 
-    if-nez v20, :cond_18
+    if-nez v20, :cond_19
 
-    if-nez v8, :cond_18
+    if-nez v8, :cond_19
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->isUserLimitReached()Z
 
     move-result v8
 
-    if-eqz v8, :cond_18
+    if-eqz v8, :cond_19
 
-    if-nez v15, :cond_18
+    if-nez v15, :cond_19
 
-    if-nez v11, :cond_18
+    if-nez v11, :cond_19
 
-    if-nez v19, :cond_18
+    if-nez v19, :cond_19
 
     const-string v8, "Cannot add user. Maximum user limit is reached."
 
@@ -5394,8 +5450,8 @@
     :try_end_6
     .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
-    :cond_18
-    if-eqz v16, :cond_19
+    :cond_19
+    if-eqz v16, :cond_1a
 
     const/4 v8, 0x0
 
@@ -5406,7 +5462,7 @@
     :try_end_7
     .catchall {:try_start_7 .. :try_end_7} :catchall_2
 
-    if-nez v13, :cond_19
+    if-nez v13, :cond_1a
 
     :try_start_8
     new-instance v8, Ljava/lang/StringBuilder;
@@ -5435,27 +5491,27 @@
     :try_end_8
     .catchall {:try_start_8 .. :try_end_8} :catchall_1
 
-    goto :goto_c
+    goto :goto_d
 
     :catchall_2
     move-exception v0
 
     move v9, v8
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
-    goto :goto_9
+    goto :goto_a
 
-    :cond_19
-    :goto_c
+    :cond_1a
+    :goto_d
     :try_start_9
     sget-boolean v8, Lcom/samsung/android/rune/PMRune;->UM_BMODE:Z
     :try_end_9
     .catchall {:try_start_9 .. :try_end_9} :catchall_16
 
-    if-eqz v8, :cond_1b
+    if-eqz v8, :cond_1c
 
-    if-eqz v19, :cond_1b
+    if-eqz v19, :cond_1c
 
     const/4 v8, 0x1
 
@@ -5468,7 +5524,7 @@
 
     move-result-object v8
 
-    if-eqz v8, :cond_1b
+    if-eqz v8, :cond_1c
 
     monitor-exit v10
     :try_end_a
@@ -5476,12 +5532,12 @@
 
     const/4 v13, 0x0
 
-    if-eqz v15, :cond_1a
+    if-eqz v15, :cond_1b
 
     invoke-virtual {v1, v13}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_1a
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_1b
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     return-object v13
 
@@ -5490,29 +5546,29 @@
 
     const/4 v13, 0x0
 
-    :goto_d
-    move-object/from16 v27, v10
+    :goto_e
+    move-object/from16 v28, v10
 
     move-object v12, v13
 
-    :goto_e
+    :goto_f
     const/4 v9, 0x0
 
-    goto/16 :goto_1e
+    goto/16 :goto_1f
 
-    :cond_1b
+    :cond_1c
     const/4 v13, 0x0
 
-    if-eqz v18, :cond_1c
+    if-eqz v18, :cond_1d
 
-    if-eqz v2, :cond_1c
+    if-eqz v2, :cond_1d
 
     :try_start_b
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->isCreationOverrideEnabled()Z
 
     move-result v8
 
-    if-nez v8, :cond_1c
+    if-nez v8, :cond_1d
 
     const-string v8, "Cannot add restricted profile - parent user must be system"
 
@@ -5522,33 +5578,33 @@
     :try_end_b
     .catchall {:try_start_b .. :try_end_b} :catchall_4
 
-    goto :goto_f
+    goto :goto_10
 
     :catchall_4
     move-exception v0
 
-    goto :goto_d
+    goto :goto_e
 
-    :cond_1c
-    :goto_f
-    if-eqz v15, :cond_1d
+    :cond_1d
+    :goto_10
+    if-eqz v15, :cond_1e
 
     const/16 v8, 0x4d
 
-    :goto_10
+    :goto_11
     move v14, v8
 
-    goto :goto_11
+    goto :goto_12
 
-    :cond_1d
+    :cond_1e
     :try_start_c
     invoke-virtual {v1, v12, v11}, Lcom/android/server/pm/UserManagerService;->getNextAvailableId(ZZ)I
 
     move-result v8
 
-    goto :goto_10
+    goto :goto_11
 
-    :goto_11
+    :goto_12
     const-string v8, "UserManagerService"
 
     new-instance v11, Ljava/lang/StringBuilder;
@@ -5588,7 +5644,7 @@
     :try_end_d
     .catchall {:try_start_d .. :try_end_d} :catchall_16
 
-    if-eqz v5, :cond_1e
+    if-eqz v5, :cond_1f
 
     :try_start_e
     iget-object v8, v5, Lcom/android/server/pm/UserManagerService$UserData;->info:Landroid/content/pm/UserInfo;
@@ -5599,37 +5655,37 @@
     :try_end_e
     .catchall {:try_start_e .. :try_end_e} :catchall_5
 
-    if-eqz v8, :cond_1e
+    if-eqz v8, :cond_1f
 
     or-int/lit16 v7, v7, 0x100
 
-    goto :goto_12
+    goto :goto_13
 
     :catchall_5
     move-exception v0
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
     const/4 v9, 0x0
 
     const/4 v12, 0x0
 
-    goto/16 :goto_1c
+    goto/16 :goto_1d
 
-    :cond_1e
-    :goto_12
-    if-eqz v3, :cond_1f
+    :cond_1f
+    :goto_13
+    if-eqz v3, :cond_20
 
     and-int/lit16 v7, v7, -0x101
 
-    :cond_1f
+    :cond_20
     and-int/lit16 v8, v7, 0x100
 
-    if-eqz v8, :cond_20
+    if-eqz v8, :cond_21
 
     or-int/lit16 v7, v7, 0x2000
 
-    :cond_20
+    :cond_21
     move v8, v7
 
     :try_start_f
@@ -5637,7 +5693,7 @@
     :try_end_f
     .catchall {:try_start_f .. :try_end_f} :catchall_13
 
-    const/16 v26, 0x0
+    const/16 v27, 0x0
 
     move-object v7, v11
 
@@ -5645,15 +5701,15 @@
 
     move v8, v14
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
-    move-object/from16 v10, v26
+    move-object/from16 v10, v27
 
-    move-object/from16 v28, v11
+    move-object/from16 v29, v11
 
     move/from16 v11, p3
 
-    move/from16 v26, v12
+    move/from16 v27, v12
 
     const/4 v4, 0x0
 
@@ -5664,9 +5720,9 @@
     :try_end_10
     .catchall {:try_start_10 .. :try_end_10} :catchall_12
 
-    if-eqz v16, :cond_21
+    if-eqz v16, :cond_22
 
-    move-object/from16 v7, v28
+    move-object/from16 v7, v29
 
     :try_start_11
     iput v14, v7, Landroid/content/pm/UserInfo;->serialNumber:I
@@ -5681,20 +5737,20 @@
     :try_end_11
     .catchall {:try_start_11 .. :try_end_11} :catchall_6
 
-    goto :goto_14
+    goto :goto_15
 
     :catchall_6
     move-exception v0
 
     move-object v12, v4
 
-    :goto_13
+    :goto_14
     const/4 v9, 0x0
 
-    goto/16 :goto_1c
+    goto/16 :goto_1d
 
-    :cond_21
-    move-object/from16 v7, v28
+    :cond_22
+    move-object/from16 v7, v29
 
     :try_start_12
     iget v8, v1, Lcom/android/server/pm/UserManagerService;->mNextSerialNumber:I
@@ -5705,7 +5761,7 @@
 
     iput v8, v7, Landroid/content/pm/UserInfo;->serialNumber:I
 
-    :goto_14
+    :goto_15
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->getCreationTime()J
 
     move-result-wide v8
@@ -5728,11 +5784,11 @@
     :try_end_12
     .catchall {:try_start_12 .. :try_end_12} :catchall_12
 
-    if-eqz v8, :cond_22
+    if-eqz v8, :cond_23
 
     const/16 v8, -0x2710
 
-    if-eq v2, v8, :cond_22
+    if-eq v2, v8, :cond_23
 
     :try_start_13
     invoke-virtual {v1, v2, v0}, Lcom/android/server/pm/UserManagerService;->getFreeProfileBadgeLU(ILjava/lang/String;)I
@@ -5743,7 +5799,7 @@
     :try_end_13
     .catchall {:try_start_13 .. :try_end_13} :catchall_6
 
-    :cond_22
+    :cond_23
     :try_start_14
     new-instance v12, Lcom/android/server/pm/UserManagerService$UserData;
 
@@ -5777,9 +5833,9 @@
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->writeUserListLP()V
 
-    if-eqz v5, :cond_26
+    if-eqz v5, :cond_27
 
-    if-eqz v16, :cond_24
+    if-eqz v16, :cond_25
 
     iget-object v8, v5, Lcom/android/server/pm/UserManagerService$UserData;->info:Landroid/content/pm/UserInfo;
 
@@ -5787,7 +5843,7 @@
 
     const/16 v10, -0x2710
 
-    if-ne v9, v10, :cond_23
+    if-ne v9, v10, :cond_24
 
     iget v9, v8, Landroid/content/pm/UserInfo;->id:I
 
@@ -5795,17 +5851,17 @@
 
     invoke-virtual {v1, v5}, Lcom/android/server/pm/UserManagerService;->writeUserLP(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_23
+    :cond_24
     iget-object v5, v5, Lcom/android/server/pm/UserManagerService$UserData;->info:Landroid/content/pm/UserInfo;
 
     iget v5, v5, Landroid/content/pm/UserInfo;->profileGroupId:I
 
     iput v5, v7, Landroid/content/pm/UserInfo;->profileGroupId:I
 
-    goto :goto_15
+    goto :goto_16
 
-    :cond_24
-    if-eqz v18, :cond_26
+    :cond_25
+    if-eqz v18, :cond_27
 
     iget-object v8, v5, Lcom/android/server/pm/UserManagerService$UserData;->info:Landroid/content/pm/UserInfo;
 
@@ -5813,7 +5869,7 @@
 
     const/16 v10, -0x2710
 
-    if-ne v9, v10, :cond_25
+    if-ne v9, v10, :cond_26
 
     iget v9, v8, Landroid/content/pm/UserInfo;->id:I
 
@@ -5821,27 +5877,27 @@
 
     invoke-virtual {v1, v5}, Lcom/android/server/pm/UserManagerService;->writeUserLP(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_25
+    :cond_26
     iget-object v5, v5, Lcom/android/server/pm/UserManagerService$UserData;->info:Landroid/content/pm/UserInfo;
 
     iget v5, v5, Landroid/content/pm/UserInfo;->restrictedProfileParentId:I
 
     iput v5, v7, Landroid/content/pm/UserInfo;->restrictedProfileParentId:I
 
-    :cond_26
-    :goto_15
-    monitor-exit v27
+    :cond_27
+    :goto_16
+    monitor-exit v28
     :try_end_16
     .catchall {:try_start_16 .. :try_end_16} :catchall_10
 
-    if-eqz v22, :cond_2a
+    if-eqz v23, :cond_2b
 
     :try_start_17
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->verifyDeviceIntegrity()Z
 
     move-result v5
 
-    if-nez v5, :cond_28
+    if-nez v5, :cond_29
 
     const-string v0, "UserManagerService"
 
@@ -5851,22 +5907,22 @@
     :try_end_17
     .catchall {:try_start_17 .. :try_end_17} :catchall_7
 
-    if-eqz v15, :cond_27
+    if-eqz v15, :cond_28
 
     invoke-virtual {v1, v12}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_27
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_28
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     return-object v4
 
-    :cond_28
+    :cond_29
     :try_start_18
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->isDeviceRootKeyInstalled()Z
 
     move-result v5
 
-    if-nez v5, :cond_2a
+    if-nez v5, :cond_2b
 
     const-string v0, "UserManagerService"
 
@@ -5876,12 +5932,12 @@
     :try_end_18
     .catchall {:try_start_18 .. :try_end_18} :catchall_7
 
-    if-eqz v15, :cond_29
+    if-eqz v15, :cond_2a
 
     invoke-virtual {v1, v12}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_29
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_2a
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     return-object v4
 
@@ -5890,12 +5946,12 @@
 
     const/4 v14, 0x0
 
-    goto/16 :goto_20
+    goto/16 :goto_21
 
-    :cond_2a
-    if-eqz v16, :cond_2b
+    :cond_2b
+    if-eqz v16, :cond_2c
 
-    if-nez v3, :cond_2b
+    if-nez v3, :cond_2c
 
     :try_start_19
     iget-object v5, v1, Lcom/android/server/pm/UserManagerService;->sPersonaManager:Lcom/android/server/pm/PersonaManagerService;
@@ -5904,7 +5960,7 @@
     :try_end_19
     .catchall {:try_start_19 .. :try_end_19} :catchall_7
 
-    :cond_2b
+    :cond_2c
     :try_start_1a
     const-string v5, "createUserKey"
 
@@ -5950,13 +6006,13 @@
     :try_end_1a
     .catchall {:try_start_1a .. :try_end_1a} :catchall_f
 
-    if-eqz v20, :cond_2f
+    if-eqz v20, :cond_30
 
-    if-nez v25, :cond_2c
+    if-nez v26, :cond_2d
 
-    if-eqz v21, :cond_2f
+    if-eqz v21, :cond_30
 
-    :cond_2c
+    :cond_2d
     :try_start_1b
     const-string v5, "UserManagerService"
 
@@ -5986,7 +6042,7 @@
 
     move-result v5
 
-    if-nez v5, :cond_2e
+    if-nez v5, :cond_2f
 
     const-string v0, "UserManagerService"
 
@@ -5996,16 +6052,16 @@
     :try_end_1b
     .catchall {:try_start_1b .. :try_end_1b} :catchall_7
 
-    if-eqz v15, :cond_2d
+    if-eqz v15, :cond_2e
 
     invoke-virtual {v1, v12}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_2d
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_2e
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     return-object v8
 
-    :cond_2e
+    :cond_2f
     :try_start_1c
     sget-object v5, Lcom/samsung/android/knox/dar/ddar/fsm/Event;->DDAR_WORKSPACE_CREATED:Lcom/samsung/android/knox/dar/ddar/fsm/Event;
 
@@ -6019,7 +6075,7 @@
     :try_end_1c
     .catchall {:try_start_1c .. :try_end_1c} :catchall_7
 
-    :cond_2f
+    :cond_30
     :try_start_1d
     const-string v5, "LSS.createNewUser"
 
@@ -6083,7 +6139,7 @@
     :try_end_21
     .catchall {:try_start_21 .. :try_end_21} :catchall_f
 
-    if-eqz v17, :cond_30
+    if-eqz v17, :cond_31
 
     :try_start_22
     iget-object v5, v1, Lcom/android/server/pm/UserManagerService;->mGuestRestrictions:Landroid/os/Bundle;
@@ -6099,7 +6155,7 @@
 
     monitor-exit v5
 
-    goto :goto_16
+    goto :goto_17
 
     :catchall_8
     move-exception v0
@@ -6113,11 +6169,11 @@
     :try_end_24
     .catchall {:try_start_24 .. :try_end_24} :catchall_7
 
-    :cond_30
+    :cond_31
     :try_start_25
     invoke-virtual {v6, v0}, Lcom/android/server/pm/UserTypeDetails;->addDefaultRestrictionsTo(Landroid/os/Bundle;)V
 
-    :goto_16
+    :goto_17
     iget-object v5, v1, Lcom/android/server/pm/UserManagerService;->mRestrictionsLock:Ljava/lang/Object;
 
     monitor-enter v5
@@ -6167,7 +6223,7 @@
     :try_end_28
     .catchall {:try_start_28 .. :try_end_28} :catchall_17
 
-    if-eqz v3, :cond_31
+    if-eqz v3, :cond_32
 
     :try_start_29
     const-string v0, "UserManagerService"
@@ -6204,7 +6260,7 @@
     .catch Landroid/os/RemoteException; {:try_start_2a .. :try_end_2a} :catch_0
     .catchall {:try_start_2a .. :try_end_2a} :catchall_9
 
-    goto :goto_17
+    goto :goto_18
 
     :catch_0
     move-exception v0
@@ -6230,19 +6286,19 @@
 
     invoke-static {v0, v3, v2}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
-    goto :goto_17
+    goto :goto_18
 
-    :cond_31
+    :cond_32
     move-object/from16 v0, p8
 
     invoke-virtual {v1, v7, v0}, Lcom/android/server/pm/UserManagerService;->dispatchUserAdded(Landroid/content/pm/UserInfo;Ljava/lang/Object;)V
 
-    :goto_17
-    if-eqz v20, :cond_33
+    :goto_18
+    if-eqz v20, :cond_35
 
-    if-nez v19, :cond_33
+    if-nez v19, :cond_35
 
-    if-eqz v26, :cond_32
+    if-eqz v27, :cond_33
 
     iget-object v0, v1, Lcom/android/server/pm/UserManagerService;->mLockPatternUtils:Lcom/android/internal/widget/LockPatternUtils;
 
@@ -6268,30 +6324,43 @@
 
     invoke-static {v0, v2}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
-    :cond_32
+    :cond_33
+    if-eqz v22, :cond_34
+
+    invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v0
+
+    new-instance v2, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;
+
+    invoke-direct {v2, v14}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda6;-><init>(I)V
+
+    invoke-virtual {v0, v2}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    :cond_34
     iget-object v0, v1, Lcom/android/server/pm/UserManagerService;->sPersonaManager:Lcom/android/server/pm/PersonaManagerService;
 
     invoke-virtual {v0, v7}, Lcom/android/server/pm/PersonaManagerService;->onNewUserCreated(Landroid/content/pm/UserInfo;)V
     :try_end_2b
     .catchall {:try_start_2b .. :try_end_2b} :catchall_9
 
-    :cond_33
-    if-eqz v15, :cond_35
+    :cond_35
+    if-eqz v15, :cond_37
 
-    if-eqz v15, :cond_34
+    if-eqz v15, :cond_36
 
     iget-object v0, v1, Lcom/android/server/pm/UserManagerService;->mMaintenanceModeManager:Lcom/samsung/android/server/pm/mm/MaintenanceModeManager;
 
     invoke-virtual {v0}, Lcom/samsung/android/server/pm/mm/MaintenanceModeManager;->finishUserCreation()V
 
-    goto :goto_18
+    goto :goto_19
 
-    :cond_34
+    :cond_36
     invoke-virtual {v1, v12}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_35
-    :goto_18
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_37
+    :goto_19
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     return-object v7
 
@@ -6300,14 +6369,14 @@
 
     move v14, v15
 
-    goto :goto_20
+    goto :goto_21
 
     :catchall_a
     move-exception v0
 
     const/4 v9, 0x0
 
-    :goto_19
+    :goto_1a
     :try_start_2c
     monitor-exit v5
     :try_end_2c
@@ -6321,14 +6390,14 @@
     :catchall_b
     move-exception v0
 
-    goto :goto_19
+    goto :goto_1a
 
     :catchall_c
     move-exception v0
 
     const/4 v9, 0x0
 
-    :goto_1a
+    :goto_1b
     :try_start_2e
     monitor-exit v5
     :try_end_2e
@@ -6342,52 +6411,52 @@
     :catchall_d
     move-exception v0
 
-    goto :goto_1a
+    goto :goto_1b
 
     :catchall_e
     move-exception v0
 
     move v9, v5
 
-    goto :goto_1f
+    goto :goto_20
 
     :catchall_f
     move-exception v0
 
     const/4 v9, 0x0
 
-    goto :goto_1f
+    goto :goto_20
 
     :catchall_10
     move-exception v0
 
-    goto/16 :goto_e
+    goto/16 :goto_f
 
     :catchall_11
     move-exception v0
 
-    goto/16 :goto_13
+    goto/16 :goto_14
 
     :catchall_12
     move-exception v0
 
     move-object v8, v4
 
-    goto :goto_1b
+    goto :goto_1c
 
     :catchall_13
     move-exception v0
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
     const/4 v8, 0x0
 
-    :goto_1b
+    :goto_1c
     const/4 v9, 0x0
 
     move-object v12, v8
 
-    :goto_1c
+    :goto_1d
     :try_start_30
     monitor-exit v13
     :try_end_30
@@ -6399,31 +6468,31 @@
     :catchall_14
     move-exception v0
 
-    goto :goto_1c
+    goto :goto_1d
 
     :catchall_15
     move-exception v0
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
     move-object v8, v13
 
-    goto :goto_1d
+    goto :goto_1e
 
     :catchall_16
     move-exception v0
 
-    move-object/from16 v27, v10
+    move-object/from16 v28, v10
 
     const/4 v8, 0x0
 
-    :goto_1d
+    :goto_1e
     const/4 v9, 0x0
 
     move-object v12, v8
 
-    :goto_1e
-    monitor-exit v27
+    :goto_1f
+    monitor-exit v28
     :try_end_31
     .catchall {:try_start_31 .. :try_end_31} :catchall_18
 
@@ -6435,12 +6504,12 @@
     :catchall_17
     move-exception v0
 
-    goto :goto_1f
+    goto :goto_20
 
     :catchall_18
     move-exception v0
 
-    goto :goto_1e
+    goto :goto_1f
 
     :catchall_19
     move-exception v0
@@ -6451,26 +6520,26 @@
 
     move-object v12, v8
 
-    :goto_1f
+    :goto_20
     move v14, v9
 
-    :goto_20
-    if-eqz v15, :cond_37
+    :goto_21
+    if-eqz v15, :cond_39
 
-    if-eqz v14, :cond_36
+    if-eqz v14, :cond_38
 
     iget-object v1, v1, Lcom/android/server/pm/UserManagerService;->mMaintenanceModeManager:Lcom/samsung/android/server/pm/mm/MaintenanceModeManager;
 
     invoke-virtual {v1}, Lcom/samsung/android/server/pm/mm/MaintenanceModeManager;->finishUserCreation()V
 
-    goto :goto_21
+    goto :goto_22
 
-    :cond_36
+    :cond_38
     invoke-virtual {v1, v12}, Lcom/android/server/pm/UserManagerService;->cleanUpMaintenanceModeUserDebris(Lcom/android/server/pm/UserManagerService$UserData;)V
 
-    :cond_37
-    :goto_21
-    invoke-static/range {v23 .. v24}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :cond_39
+    :goto_22
+    invoke-static/range {v24 .. v25}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     throw v0
 
@@ -10468,7 +10537,7 @@
 
     iget-object p0, p0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
 
-    const v0, 0x10405d0
+    const v0, 0x10405cc
 
     invoke-virtual {p0, v0}, Landroid/content/Context;->getString(I)Ljava/lang/String;
 
@@ -12338,6 +12407,92 @@
     return v1
 .end method
 
+.method public final getSdpManager()Ljava/util/Optional;
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    if-nez v0, :cond_0
+
+    const-string v0, "dar"
+
+    invoke-static {v0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/DarManagerService;
+
+    if-eqz v0, :cond_0
+
+    invoke-virtual {v0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
+.method public final getSdpManagerInternal()Ljava/util/Optional;
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManagerInternal:Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    if-nez v0, :cond_0
+
+    invoke-virtual {p0}, Lcom/android/server/pm/UserManagerService;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v0
+
+    new-instance v1, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8;
+
+    invoke-direct {v1}, Lcom/android/server/locksettings/LockSettingsService$SdpLockSettings$$ExternalSyntheticLambda8;-><init>()V
+
+    invoke-virtual {v0, v1}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object v0
+
+    sget-object v1, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {v0, v1}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Ljava/lang/Boolean;
+
+    invoke-virtual {v0}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    const-class v0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    invoke-static {v0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    iput-object v0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManagerInternal:Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    :cond_0
+    iget-object p0, p0, Lcom/android/server/pm/UserManagerService;->mSdpManagerInternal:Lcom/android/server/knox/dar/sdp/SdpManagerInternal;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public getSeedAccountName(I)Ljava/lang/String;
     .locals 1
 
@@ -14914,7 +15069,7 @@
 
     const/4 v0, 0x1
 
-    const v1, 0x10408b8
+    const v1, 0x10408b4
 
     invoke-virtual {p1, v1, p2, v0}, Landroid/content/res/Resources;->getValue(ILandroid/util/TypedValue;Z)V
 
@@ -17199,7 +17354,7 @@
 .end method
 
 .method public onBeforeUnlockUser(I)V
-    .locals 6
+    .locals 7
 
     invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerService;->getUserInfo(I)Landroid/content/pm/UserInfo;
 
@@ -17254,55 +17409,76 @@
 
     move-result v1
 
-    if-eqz v1, :cond_1
+    const-string v4, "UserManagerService"
 
-    iget v0, v0, Landroid/content/pm/UserInfo;->flags:I
+    if-eqz v1, :cond_1
 
-    const/high16 v1, 0x6000000
+    iget v1, v0, Landroid/content/pm/UserInfo;->flags:I
 
-    and-int/2addr v0, v1
+    const/high16 v6, 0x6000000
 
-    if-lez v0, :cond_1
+    and-int/2addr v1, v6
 
-    new-instance v0, Ljava/lang/StringBuilder;
+    if-lez v1, :cond_1
 
-    invoke-direct {v0}, Ljava/lang/StringBuilder;-><init>()V
+    new-instance v1, Ljava/lang/StringBuilder;
 
-    const-string v1, "Apply policies on CE storage for dualdar user "
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
 
-    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    const-string v6, "Apply policies on CE storage for dualdar user "
 
-    invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v1, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v1, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    move-result-object v0
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    const-string v1, "UserManagerService"
+    move-result-object v1
 
-    invoke-static {v1, v0}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v4, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
-    iget-object v0, p0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
+    iget-object v1, p0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
 
-    invoke-static {v0}, Lcom/samsung/android/knox/dar/ddar/DualDARController;->getInstance(Landroid/content/Context;)Lcom/samsung/android/knox/dar/ddar/DualDARController;
+    invoke-static {v1}, Lcom/samsung/android/knox/dar/ddar/DualDARController;->getInstance(Landroid/content/Context;)Lcom/samsung/android/knox/dar/ddar/DualDARController;
 
-    move-result-object v0
+    move-result-object v1
 
-    invoke-virtual {v0, p1}, Lcom/samsung/android/knox/dar/ddar/DualDARController;->handleBeforeUnlockUser(I)Z
+    invoke-virtual {v1, p1}, Lcom/samsung/android/knox/dar/ddar/DualDARController;->handleBeforeUnlockUser(I)Z
 
-    move-result v0
+    move-result v1
 
-    if-nez v0, :cond_1
+    if-nez v1, :cond_1
 
     const-string v0, "To set DualDAR Policy on CE storage was failed."
 
-    invoke-static {v1, v0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+    invoke-static {v4, v0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
 
     invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerService;->removeInvalidEnterpriseUser(I)V
 
     return-void
 
     :cond_1
+    invoke-virtual {v0}, Landroid/content/pm/UserInfo;->isManagedProfile()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerService;->setSdpPolicy(I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_2
+
+    const-string v0, "Failed to set sdp policy"
+
+    invoke-static {v4, v0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I
+
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/UserManagerService;->removeInvalidEnterpriseUser(I)V
+
+    return-void
+
+    :cond_2
     const-class v0, Landroid/os/storage/StorageManagerInternal;
 
     invoke-static {v0}, Lcom/android/server/LocalServices;->getService(Ljava/lang/Class;)Ljava/lang/Object;
@@ -19192,9 +19368,9 @@
 
     move-result-object v1
 
-    new-instance v2, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;
+    new-instance v2, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;
 
-    invoke-direct {v2, p0}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;-><init>(Lcom/android/server/pm/UserManagerService;)V
+    invoke-direct {v2, p0}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;-><init>(Lcom/android/server/pm/UserManagerService;)V
 
     const/16 v3, 0x27a8
 
@@ -19206,9 +19382,9 @@
 
     move-result-object v1
 
-    new-instance v2, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;
+    new-instance v2, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;
 
-    invoke-direct {v2, p0}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda7;-><init>(Lcom/android/server/pm/UserManagerService;)V
+    invoke-direct {v2, p0}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda9;-><init>(Lcom/android/server/pm/UserManagerService;)V
 
     const/16 p0, 0x27b0
 
@@ -22703,6 +22879,36 @@
     throw p0
 .end method
 
+.method public final setSdpPolicy(I)Z
+    .locals 1
+
+    invoke-virtual {p0}, Lcom/android/server/pm/UserManagerService;->getSdpManagerInternal()Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance v0, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda8;
+
+    invoke-direct {v0, p1}, Lcom/android/server/pm/UserManagerService$$ExternalSyntheticLambda8;-><init>(I)V
+
+    invoke-virtual {p0, v0}, Ljava/util/Optional;->map(Ljava/util/function/Function;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    sget-object p1, Ljava/lang/Boolean;->FALSE:Ljava/lang/Boolean;
+
+    invoke-virtual {p0, p1}, Ljava/util/Optional;->orElse(Ljava/lang/Object;)Ljava/lang/Object;
+
+    move-result-object p0
+
+    check-cast p0, Ljava/lang/Boolean;
+
+    invoke-virtual {p0}, Ljava/lang/Boolean;->booleanValue()Z
+
+    move-result p0
+
+    return p0
+.end method
+
 .method public setSeedAccountData(ILjava/lang/String;Ljava/lang/String;Landroid/os/PersistableBundle;Z)V
     .locals 1
 
@@ -24791,7 +24997,7 @@
 
     move-result-object v7
 
-    const v8, 0x10408b8
+    const v8, 0x10408b4
 
     invoke-virtual {v7, v8}, Landroid/content/res/Resources;->getString(I)Ljava/lang/String;
 
diff --git a/smali_classes3/com/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1.smali b/smali_classes3/com/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1.smali
new file mode 100644
index 000000000..d6890bd53
--- /dev/null
+++ b/smali_classes3/com/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService;->$r8$lambda$ZFBQm4FnAopjRHJs6j6-N6CahnY(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1.smali b/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1.smali
new file mode 100644
index 000000000..441c9e0af
--- /dev/null
+++ b/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService$1;->$r8$lambda$ko1M1aNN-RgLnwxL61pthLXH4dk(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2.smali b/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2.smali
new file mode 100644
index 000000000..906c916fd
--- /dev/null
+++ b/smali_classes3/com/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2.smali
@@ -0,0 +1,36 @@
+.class public final synthetic Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2;
+.super Ljava/lang/Object;
+.source "R8$$SyntheticClass"
+
+# interfaces
+.implements Ljava/util/function/Consumer;
+
+
+# instance fields
+.field public final synthetic f$0:I
+
+
+# direct methods
+.method public synthetic constructor <init>(I)V
+    .locals 0
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    iput p1, p0, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2;->f$0:I
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public final accept(Ljava/lang/Object;)V
+    .locals 0
+
+    iget p0, p0, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2;->f$0:I
+
+    check-cast p1, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService$1;->$r8$lambda$Pyl_KxHwG4qxp9w_YCR2VYIh6iI(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
diff --git a/smali_classes3/com/android/server/trust/TrustManagerService$1.smali b/smali_classes3/com/android/server/trust/TrustManagerService$1.smali
index 0e1905972..ad17865fb 100644
--- a/smali_classes3/com/android/server/trust/TrustManagerService$1.smali
+++ b/smali_classes3/com/android/server/trust/TrustManagerService$1.smali
@@ -16,6 +16,22 @@
     return-void
 .end method
 
+.method public static synthetic $r8$lambda$Pyl_KxHwG4qxp9w_YCR2VYIh6iI(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService$1;->lambda$setDeviceLockedForUser$2(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
+.method public static synthetic $r8$lambda$ko1M1aNN-RgLnwxL61pthLXH4dk(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService$1;->lambda$setDeviceLockedForUser$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
 .method public static bridge synthetic -$$Nest$mdumpUser(Lcom/android/server/trust/TrustManagerService$1;Ljava/io/PrintWriter;Landroid/content/pm/UserInfo;Z)V
     .locals 0
 
@@ -40,6 +56,22 @@
     return-void
 .end method
 
+.method public static synthetic lambda$setDeviceLockedForUser$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onDeviceLocked(I)V
+
+    return-void
+.end method
+
+.method public static synthetic lambda$setDeviceLockedForUser$2(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onDeviceUnlocked(I)V
+
+    return-void
+.end method
+
 
 # virtual methods
 .method public clearAllBiometricRecognized(Landroid/hardware/biometrics/BiometricSourceType;I)V
@@ -1223,7 +1255,7 @@
 .end method
 
 .method public setDeviceLockedForUser(IZ)V
-    .locals 6
+    .locals 7
 
     invoke-virtual {p0}, Lcom/android/server/trust/TrustManagerService$1;->enforceReportPermission()V
 
@@ -1332,7 +1364,7 @@
 
     move-result v2
 
-    if-eqz v2, :cond_4
+    if-eqz v2, :cond_5
 
     iget-object v2, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
 
@@ -1344,7 +1376,7 @@
 
     move-result v2
 
-    if-eqz v2, :cond_4
+    if-eqz v2, :cond_5
 
     iget-object v2, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
 
@@ -1387,9 +1419,9 @@
     :try_start_7
     invoke-static {}, Landroid/app/ActivityManager;->getService()Landroid/app/IActivityManager;
 
-    move-result-object p2
+    move-result-object v2
 
-    invoke-interface {p2, p1}, Landroid/app/IActivityManager;->notifyLockedProfile(I)V
+    invoke-interface {v2, p1}, Landroid/app/IActivityManager;->notifyLockedProfile(I)V
     :try_end_7
     .catch Landroid/os/RemoteException; {:try_start_7 .. :try_end_7} :catch_0
     .catchall {:try_start_7 .. :try_end_7} :catchall_2
@@ -1397,51 +1429,80 @@
     :catch_0
     :cond_2
     :try_start_8
-    new-instance p2, Landroid/content/Intent;
+    new-instance v2, Landroid/content/Intent;
 
-    const-string v2, "android.intent.action.DEVICE_LOCKED_CHANGED"
+    const-string v4, "android.intent.action.DEVICE_LOCKED_CHANGED"
 
-    invoke-direct {p2, v2}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
+    invoke-direct {v2, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    const/high16 v2, 0x40000000    # 2.0f
+    const/high16 v4, 0x40000000    # 2.0f
 
-    invoke-virtual {p2, v2}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
+    invoke-virtual {v2, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
 
-    const-string v2, "android.intent.extra.user_handle"
+    const-string v4, "android.intent.extra.user_handle"
 
-    invoke-virtual {p2, v2, p1}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
+    invoke-virtual {v2, v4, p1}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
+
+    iget-object v4, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
+
+    invoke-static {v4}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$fgetmContext(Lcom/android/server/trust/TrustManagerService;)Landroid/content/Context;
+
+    move-result-object v4
+
+    sget-object v5, Landroid/os/UserHandle;->SYSTEM:Landroid/os/UserHandle;
+
+    const-string v6, "android.permission.TRUST_LISTENER"
+
+    invoke-virtual {v4, v2, v5, v6, v3}, Landroid/content/Context;->sendBroadcastAsUser(Landroid/content/Intent;Landroid/os/UserHandle;Ljava/lang/String;Landroid/os/Bundle;)V
 
     iget-object v2, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
 
-    invoke-static {v2}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$fgetmContext(Lcom/android/server/trust/TrustManagerService;)Landroid/content/Context;
+    invoke-static {v2}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetPersonaManagerInternal(Lcom/android/server/trust/TrustManagerService;)Lcom/samsung/android/knox/PersonaManagerInternal;
 
     move-result-object v2
 
-    sget-object v4, Landroid/os/UserHandle;->SYSTEM:Landroid/os/UserHandle;
-
-    const-string v5, "android.permission.TRUST_LISTENER"
+    if-eqz v2, :cond_4
 
-    invoke-virtual {v2, p2, v4, v5, v3}, Landroid/content/Context;->sendBroadcastAsUser(Landroid/content/Intent;Landroid/os/UserHandle;Ljava/lang/String;Landroid/os/Bundle;)V
+    iget-object v2, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
 
-    iget-object p2, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
+    invoke-static {v2}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetPersonaManagerInternal(Lcom/android/server/trust/TrustManagerService;)Lcom/samsung/android/knox/PersonaManagerInternal;
 
-    invoke-static {p2}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetPersonaManagerInternal(Lcom/android/server/trust/TrustManagerService;)Lcom/samsung/android/knox/PersonaManagerInternal;
+    move-result-object v2
 
-    move-result-object p2
+    invoke-virtual {v2, p1}, Lcom/samsung/android/knox/PersonaManagerInternal;->onDeviceLockedChanged(I)V
 
     if-eqz p2, :cond_3
 
     iget-object p0, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
 
-    invoke-static {p0}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetPersonaManagerInternal(Lcom/android/server/trust/TrustManagerService;)Lcom/samsung/android/knox/PersonaManagerInternal;
+    invoke-static {p0}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetSdpManager(Lcom/android/server/trust/TrustManagerService;)Ljava/util/Optional;
 
     move-result-object p0
 
-    invoke-virtual {p0, p1}, Lcom/samsung/android/knox/PersonaManagerInternal;->onDeviceLockedChanged(I)V
+    new-instance p2, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1;
+
+    invoke-direct {p2, p1}, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda1;-><init>(I)V
+
+    invoke-virtual {p0, p2}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
 
     goto :goto_1
 
     :cond_3
+    iget-object p0, p0, Lcom/android/server/trust/TrustManagerService$1;->this$0:Lcom/android/server/trust/TrustManagerService;
+
+    invoke-static {p0}, Lcom/android/server/trust/TrustManagerService;->-$$Nest$mgetSdpManager(Lcom/android/server/trust/TrustManagerService;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    new-instance p2, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2;
+
+    invoke-direct {p2, p1}, Lcom/android/server/trust/TrustManagerService$1$$ExternalSyntheticLambda2;-><init>(I)V
+
+    invoke-virtual {p0, p2}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
+    goto :goto_1
+
+    :cond_4
     const-string p0, "TrustManagerService"
 
     const-string/jumbo p1, "onDeviceLockedChanged() - Service is not yet ready..."
@@ -1465,7 +1526,7 @@
     :try_end_a
     .catchall {:try_start_a .. :try_end_a} :catchall_2
 
-    :cond_4
+    :cond_5
     :goto_1
     invoke-static {v0, v1}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
diff --git a/smali_classes3/com/android/server/trust/TrustManagerService.smali b/smali_classes3/com/android/server/trust/TrustManagerService.smali
index db5749972..eb6a30ea2 100644
--- a/smali_classes3/com/android/server/trust/TrustManagerService.smali
+++ b/smali_classes3/com/android/server/trust/TrustManagerService.smali
@@ -28,6 +28,8 @@
 
 .field public mCurrentUser:I
 
+.field public mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
 .field public final mDeviceLockedForUser:Landroid/util/SparseBooleanArray;
 
 .field public final mHandler:Landroid/os/Handler;
@@ -46,6 +48,8 @@
 
 .field public final mReceiver:Lcom/android/server/trust/TrustManagerService$Receiver;
 
+.field public mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
 .field public final mService:Landroid/os/IBinder;
 
 .field public final mSettingsObserver:Lcom/android/server/trust/TrustManagerService$SettingsObserver;
@@ -74,6 +78,14 @@
 
 
 # direct methods
+.method public static synthetic $r8$lambda$ZFBQm4FnAopjRHJs6j6-N6CahnY(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-static {p0, p1}, Lcom/android/server/trust/TrustManagerService;->lambda$refreshDeviceLockedForUser$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+
+    return-void
+.end method
+
 .method public static synthetic $r8$lambda$oZdT0RHw1uiCiujz-iQXVyE5nQc(Lcom/android/server/trust/TrustManagerService;JI)V
     .locals 0
 
@@ -388,6 +400,16 @@
     return-object p0
 .end method
 
+.method public static bridge synthetic -$$Nest$mgetSdpManager(Lcom/android/server/trust/TrustManagerService;)Ljava/util/Optional;
+    .locals 0
+
+    invoke-virtual {p0}, Lcom/android/server/trust/TrustManagerService;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public static bridge synthetic -$$Nest$mhandleDualDARDeviceLockedChangedForUser(Lcom/android/server/trust/TrustManagerService;IZ)V
     .locals 0
 
@@ -825,6 +847,14 @@
     return-void
 .end method
 
+.method public static synthetic lambda$refreshDeviceLockedForUser$1(ILcom/android/server/knox/dar/sdp/SdpManagerImpl;)V
+    .locals 0
+
+    invoke-virtual {p1, p0}, Lcom/android/server/knox/dar/sdp/SdpManagerImpl;->onDeviceLocked(I)V
+
+    return-void
+.end method
+
 
 # virtual methods
 .method public addEscrowToken([BI)J
@@ -2307,6 +2337,48 @@
     return-object p0
 .end method
 
+.method public final getSdpManager()Ljava/util/Optional;
+    .locals 1
+
+    iget-object v0, p0, Lcom/android/server/trust/TrustManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    if-nez v0, :cond_1
+
+    iget-object v0, p0, Lcom/android/server/trust/TrustManagerService;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    if-nez v0, :cond_0
+
+    const-string v0, "dar"
+
+    invoke-static {v0}, Landroid/os/ServiceManager;->getService(Ljava/lang/String;)Landroid/os/IBinder;
+
+    move-result-object v0
+
+    check-cast v0, Lcom/android/server/knox/dar/DarManagerService;
+
+    iput-object v0, p0, Lcom/android/server/trust/TrustManagerService;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    :cond_0
+    iget-object v0, p0, Lcom/android/server/trust/TrustManagerService;->mDarManagerService:Lcom/android/server/knox/dar/DarManagerService;
+
+    if-eqz v0, :cond_1
+
+    invoke-virtual {v0}, Lcom/android/server/knox/dar/DarManagerService;->getSdpManager()Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/server/trust/TrustManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    :cond_1
+    iget-object p0, p0, Lcom/android/server/trust/TrustManagerService;->mSdpManager:Lcom/android/server/knox/dar/sdp/SdpManagerImpl;
+
+    invoke-static {p0}, Ljava/util/Optional;->ofNullable(Ljava/lang/Object;)Ljava/util/Optional;
+
+    move-result-object p0
+
+    return-object p0
+.end method
+
 .method public final getSettingsAttrs(Landroid/content/pm/PackageManager;Landroid/content/pm/ResolveInfo;)Lcom/android/server/trust/TrustManagerService$SettingsAttrs;
     .locals 7
 
@@ -4951,6 +5023,16 @@
 
     invoke-virtual {v3, v4}, Lcom/samsung/android/knox/PersonaManagerInternal;->onDeviceLockedChanged(I)V
 
+    invoke-virtual {p0}, Lcom/android/server/trust/TrustManagerService;->getSdpManager()Ljava/util/Optional;
+
+    move-result-object v3
+
+    new-instance v5, Lcom/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1;
+
+    invoke-direct {v5, v4}, Lcom/android/server/trust/TrustManagerService$$ExternalSyntheticLambda1;-><init>(I)V
+
+    invoke-virtual {v3, v5}, Ljava/util/Optional;->ifPresent(Ljava/util/function/Consumer;)V
+
     goto :goto_7
 
     :cond_a
-- 
2.40.1

